<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Hibernate EntityManager</title><link rel="stylesheet" href="css/hibernate-single.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.72.0"/></head><body><div class="book" lang="en"><div class="titlepage"><div><p id="title"><a href="http://www.hibernate.org" class="site_href"><strong>Hibernate.org</strong></a><a href="http://hibernate.org/Documentation/DocumentationOverview" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e2"/>Hibernate EntityManager</h1></div><div><h2 class="subtitle">User guide</h2></div><div><div xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="authorgroup"><div class="authors">by <span xmlns="http://www.w3.org/1999/xhtml" class="firstname">Emmanuel</span> <span xmlns="http://www.w3.org/1999/xhtml" class="surname">Bernard</span>, <span xmlns="http://www.w3.org/1999/xhtml" class="firstname">Steve</span> <span xmlns="http://www.w3.org/1999/xhtml" class="surname">Ebersole</span>, and <span xmlns="http://www.w3.org/1999/xhtml" class="firstname">Gavin</span> <span xmlns="http://www.w3.org/1999/xhtml" class="surname">King</span></div><div class="editors"/><div class="others"/></div></div><div><p class="releaseinfo">4.0.1.Final</p></div><div><p class="copyright">Copyright © 2005 Red Hat Inc. and the various authors</p></div><div><p class="pubdate">2012-01-11</p></div></div><hr/></div><div class="toc"><dl><dt><span class="preface"><a href="#d0e46">Introducing JPA Persistence</a></span></dt><dt><span class="chapter"><a href="#architecture">1. Architecture</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e61">1.1. Definitions</a></span></dt><dt><span class="section"><a href="#d0e126">1.2. In container environment (eg. EJB 3)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e129">1.2.1. Container-managed entity manager</a></span></dt><dt><span class="section"><a href="#d0e134">1.2.2. Application-managed entity manager</a></span></dt><dt><span class="section"><a href="#architecture-ejb-persistctxscope">1.2.3. Persistence context scope</a></span></dt><dt><span class="section"><a href="#architecture-ejb-persistctxpropagation">1.2.4. Persistence context propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#architecture-javase">1.3. Java SE environments</a></span></dt></dl></dd><dt><span class="chapter"><a href="#configuration">2. Setup and configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e215">2.1. Setup</a></span></dt><dt><span class="section"><a href="#setup-configuration">2.2. Configuration and bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#setup-configuration-packaging">2.2.1. Packaging</a></span></dt><dt><span class="section"><a href="#setup-configuration-bootstrapping">2.2.2. Bootstrapping</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e881">2.3. Event listeners</a></span></dt><dt><span class="section"><a href="#d0e996">2.4. Obtaining an EntityManager in a Java SE environment</a></span></dt><dt><span class="section"><a href="#d0e1021">2.5. Various</a></span></dt></dl></dd><dt><span class="chapter"><a href="#objectstate">3. Working with objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1030">3.1. Entity states</a></span></dt><dt><span class="section"><a href="#d0e1053">3.2. Making objects persistent</a></span></dt><dt><span class="section"><a href="#d0e1077">3.3. Loading an object</a></span></dt><dt><span class="section"><a href="#d0e1104">3.4. Querying objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1109">3.4.1. Executing queries</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1312">3.5. Modifying persistent objects</a></span></dt><dt><span class="section"><a href="#d0e1324">3.6. Detaching a object</a></span></dt><dt><span class="section"><a href="#d0e1334">3.7. Modifying detached objects</a></span></dt><dt><span class="section"><a href="#d0e1356">3.8. Automatic state detection</a></span></dt><dt><span class="section"><a href="#d0e1430">3.9. Deleting managed objects</a></span></dt><dt><span class="section"><a href="#d0e1440">3.10. Flush the persistence context</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1445">3.10.1. In a transaction</a></span></dt><dt><span class="section"><a href="#d0e1522">3.10.2. Outside a transaction</a></span></dt></dl></dd><dt><span class="section"><a href="#objectstate-transitive">3.11. Transitive persistence</a></span></dt><dt><span class="section"><a href="#d0e1650">3.12. Locking</a></span></dt><dt><span class="section"><a href="#d0e1709">3.13. Caching</a></span></dt><dt><span class="section"><a href="#d0e1789">3.14. Checking the state of an object</a></span></dt><dt><span class="section"><a href="#d0e1815">3.15. Native Hibernate API</a></span></dt></dl></dd><dt><span class="chapter"><a href="#metamodel">4. Metamodel</a></span></dt><dd><dl><dt><span class="section"><a href="#metamodel-static">4.1. Static metamodel</a></span></dt></dl></dd><dt><span class="chapter"><a href="#transactions">5. Transactions and Concurrency</a></span></dt><dd><dl><dt><span class="sect1"><a href="#transactions-basics">5.1. Entity manager and transaction scopes</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-basics-uow">5.1.1. Unit of work</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-apptx">5.1.2. Long units of work</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-identity">5.1.3. Considering object identity</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-issues">5.1.4. Common concurrency control issues</a></span></dt></dl></dd><dt><span class="sect1"><a href="#transactions-demarcation">5.2. Database transaction demarcation</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-demarcation-nonmanaged">5.2.1. Non-managed environment</a></span></dt><dt><span class="sect2"><a href="#transactions-demarcation-jta">5.2.2. Using JTA</a></span></dt><dt><span class="sect2"><a href="#transactions-demarcation-exceptions">5.2.3. Exception handling</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d0e2798">5.3. EXTENDED Persistence Context</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d0e2839">5.3.1. Container Managed Entity Manager</a></span></dt><dt><span class="sect2"><a href="#d0e2857">5.3.2. Application Managed Entity Manager</a></span></dt></dl></dd><dt><span class="sect1"><a href="#transactions-optimistic">5.4. Optimistic concurrency control</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-optimistic-manual">5.4.1. Application version checking</a></span></dt><dt><span class="sect2"><a href="#transactions-optimistic-longsession">5.4.2. Extended entity manager and automatic versioning</a></span></dt><dt><span class="sect2"><a href="#transactions-optimistic-detached">5.4.3. Detached objects and automatic versioning</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#listeners">6. Entity listeners and Callback methods</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e2985">6.1. Definition</a></span></dt><dt><span class="section"><a href="#d0e3069">6.2. Callbacks and listeners inheritance</a></span></dt><dt><span class="section"><a href="#d0e3102">6.3. XML definition</a></span></dt></dl></dd><dt><span class="chapter"><a href="#batch">7. Batch processing</a></span></dt><dd><dl><dt><span class="section"><a href="#batch-direct">7.1. Bulk update/delete</a></span></dt></dl></dd><dt><span class="chapter"><a href="#queryhql">8. JP-QL: The Object Query Language</a></span></dt><dd><dl><dt><span class="sect1"><a href="#queryhql-casesensitivity">8.1. Case Sensitivity</a></span></dt><dt><span class="sect1"><a href="#queryhql-from">8.2. The from clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-joins">8.3. Associations and joins</a></span></dt><dt><span class="sect1"><a href="#queryhql-select">8.4. The select clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-aggregation">8.5. Aggregate functions</a></span></dt><dt><span class="sect1"><a href="#queryhql-polymorphism">8.6. Polymorphic queries</a></span></dt><dt><span class="sect1"><a href="#queryhql-where">8.7. The where clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-expressions">8.8. Expressions</a></span></dt><dt><span class="sect1"><a href="#queryhql-ordering">8.9. The order by clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-grouping">8.10. The group by clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-subqueries">8.11. Subqueries</a></span></dt><dt><span class="sect1"><a href="#queryhql-examples">8.12. JP-QL examples</a></span></dt><dt><span class="sect1"><a href="#queryhql-bulk">8.13. Bulk UPDATE &amp; DELETE Statements</a></span></dt><dt><span class="sect1"><a href="#queryhql-tipstricks">8.14. Tips &amp; Tricks</a></span></dt></dl></dd><dt><span class="chapter"><a href="#querycriteria">9. Criteria Queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery">9.1. Typed criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">9.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">9.1.2. Selecting a value</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">9.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">9.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">9.2. Tuple criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-tuple-access">9.2.1. Accessing tuple elements</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-from">9.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">9.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">9.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">9.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">9.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">9.5. Using parameters</a></span></dt></dl></dd><dt><span class="chapter"><a href="#query_native">10. Native query</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d0e4721">10.1. Expressing the resultset</a></span></dt><dt><span class="sect1"><a href="#d0e4753">10.2. Using native SQL Queries</a></span></dt><dt><span class="sect1"><a href="#d0e4774">10.3. Named queries</a></span></dt></dl></dd><dt><span class="bibliography"><a href="#d0e4781">References</a></span></dt></dl></div><div class="preface" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e46"/>Introducing JPA Persistence</h2></div></div></div><p>The JPA specification recognizes the interest and the success of the
    transparent object/relational mapping paradigm. It standardizes the basic
    APIs and the metadata needed for any object/relational persistence
    mechanism. <span class="emphasis"><em>Hibernate EntityManager</em></span> implements the
    programming interfaces and lifecycle rules as defined by the JPA 2.0
    specification. Together with <span class="emphasis"><em>Hibernate Annotations</em></span>,
    this wrapper implements a complete (and standalone) JPA persistence
    solution on top of the mature Hibernate Core. You may use a combination of
    all three together, annotations without JPA programming interfaces and
    lifecycle, or even pure native Hibernate Core, depending on the business
    and technical needs of your project. You can at all times fall back to
    Hibernate native APIs, or if required, even to native JDBC and SQL.</p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="architecture"/>Chapter 1. Architecture</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e61">1.1. Definitions</a></span></dt><dt><span class="section"><a href="#d0e126">1.2. In container environment (eg. EJB 3)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e129">1.2.1. Container-managed entity manager</a></span></dt><dt><span class="section"><a href="#d0e134">1.2.2. Application-managed entity manager</a></span></dt><dt><span class="section"><a href="#architecture-ejb-persistctxscope">1.2.3. Persistence context scope</a></span></dt><dt><span class="section"><a href="#architecture-ejb-persistctxpropagation">1.2.4. Persistence context propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#architecture-javase">1.3. Java SE environments</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e61"/>1.1. Definitions</h2></div></div></div><p>JPA 2 is part of the Java EE 6.0 platform. Persistence in JPA is
    available in containers like EJB 3 or the more modern CDI (Java Context
    and Dependency Injection), as well as in standalone Java SE applications
    that execute outside of a particular container. The following programming
    interfaces and artifacts are available in both environments.</p><div class="variablelist"><dl><dt><span class="term"><code class="literal">EntityManagerFactory</code></span></dt><dd><p>An entity manager factory provides entity manager instances,
          all instances are configured to connect to the same database, to use
          the same default settings as defined by the particular
          implementation, etc. You can prepare several entity manager
          factories to access several data stores. This interface is similar
          to the <code class="literal">SessionFactory</code> in native Hibernate.</p></dd><dt><span class="term"><code class="literal">EntityManager</code></span></dt><dd><p>The <code class="literal">EntityManager</code> API is used to access a
          database in a particular unit of work. It is used to create and
          remove persistent entity instances, to find entities by their
          primary key identity, and to query over all entities. This interface
          is similar to the <code class="literal">Session</code> in Hibernate.</p></dd><dt><span class="term">Persistence context</span></dt><dd><p>A persistence context is a set of entity instances in which
          for any persistent entity identity there is a unique entity
          instance. Within the persistence context, the entity instances and
          their lifecycle is managed by a particular entity manager. The scope
          of this context can either be the transaction, or an extended unit
          of work.</p></dd><dt><span class="term">Persistence unit</span></dt><dd><p>The set of entity types that can be managed by a given entity
          manager is defined by a persistence unit. A persistence unit defines
          the set of all classes that are related or grouped by the
          application, and which must be collocated in their mapping to a
          single data store.</p></dd><dt><span class="term">Container-managed entity manager</span></dt><dd><p>An Entity Manager whose lifecycle is managed by the
          container</p></dd><dt><span class="term">Application-managed entity manager</span></dt><dd><p>An Entity Manager whose lifecycle is managed by the
          application.</p></dd><dt><span class="term">JTA entity manager</span></dt><dd><p>Entity manager involved in a JTA transaction</p></dd><dt><span class="term">Resource-local entity manager</span></dt><dd><p>Entity manager using a resource transaction (not a JTA
          transaction).</p></dd></dl></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e126"/>1.2. In container environment (eg. EJB 3)</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e129"/>1.2.1. Container-managed entity manager</h3></div></div></div><p>The most common and widely used entity manager in a Java EE
      environment is the container-managed entity manager. In this mode, the
      container is responsible for the opening and closing of the entity
      manager (this is transparent to the application). It is also responsible
      for transaction boundaries. A container-managed entity manager is
      obtained in an application through dependency injection or through JNDI
      lookup, A container-managed entity manger requires the use of a JTA
      transaction.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e134"/>1.2.2. Application-managed entity manager</h3></div></div></div><p>An application-managed entity manager allows you to control the
      entity manager in application code. This entity manager is retrieved
      through the <code class="literal">EntityManagerFactory</code> API. An application
      managed entity manager can be either involved in the current JTA
      transaction (a JTA entity manager), or the transaction may be controlled
      through the <code class="literal">EntityTransaction</code> API (a resource-local
      entity manager). The resource-local entity manager transaction maps to a
      direct resource transaction (i. e. in Hibernate's case a JDBC
      transaction). The entity manager type (JTA or resource-local) is defined
      at configuration time, when setting up the entity manager
      factory.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="architecture-ejb-persistctxscope"/>1.2.3. Persistence context scope</h3></div></div></div><p>An entity manager is the API to interact with the persistence
      context. Two common strategies can be used: binding the persistence
      context to the transaction boundaries, or keeping the persistence
      context available across several transactions.</p><p>The most common case is to bind the persistence context scope to
      the current transaction scope. This is only doable when JTA transactions
      are used: the persistence context is associated with the JTA transaction
      life cycle. When an entity manager is invoked, the persistence context
      is also opened, if there is no persistence context associated with the
      current JTA transaction. Otherwise, the associated persistence context
      is used. The persistence context ends when the JTA transaction
      completes. This means that during the JTA transaction, an application
      will be able to work on managed entities of the same persistence
      context. In other words, you don't have to pass the entity manager's
      persistence context across your managed beans (CDI) or EJBs method
      calls, but simply use dependency injection or lookup whenever you need
      an entity manager.</p><p>You can also use an extended persistence context. This can be
      combined with stateful session beans, if you use a container-managed
      entity manager: the persistence context is created when an entity
      manager is retrieved from dependency injection or JNDI lookup , and is
      kept until the container closes it after the completion of the
      <code class="literal">Remove</code> stateful session bean method. This is a
      perfect mechanism for implementing a "long" unit of work pattern. For
      example, if you have to deal with multiple user interaction cycles as a
      single unit of work (e.g. a wizard dialog that has to be fully
      completed), you usually model this as a unit of work from the point of
      view of the application user, and implement it using an extended
      persistence context. Please refer to the Hibernate reference manual or
      the book Hibernate In Action for more information about this pattern.
      </p><p>JBoss Seam 3 is built on top of CDI and has at it's core concept
      the notion of conversation and unit of work. For an application-managed
      entity manager the persistence context is created when the entity
      manager is created and kept until the entity manager is closed. In an
      extended persistence context, all modification operations (persist,
      merge, remove) executed outside a transaction are queued until the
      persistence context is attached to a transaction. The transaction
      typically occurs at the user process end, allowing the whole process to
      be committed or rollbacked. For application-managed entity manager only
      support the extended persistence context.</p><p>A resource-local entity manager or an entity manager created with
      <code class="literal">EntityManagerFactory.createEntityManager()</code>
      (application-managed) has a one-to-one relationship with a persistence
      context. In other situations <span class="emphasis"><em>persistence context
      propagation</em></span> occurs.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="architecture-ejb-persistctxpropagation"/>1.2.4. Persistence context propagation</h3></div></div></div><p>Persistence context propagation occurs for container-managed
      entity managers.</p><p>In a transaction-scoped container managed entity manager (common
      case in a Java EE environment), the JTA transaction propagation is the
      same as the persistence context resource propagation. In other words,
      container-managed transaction-scoped entity managers retrieved within a
      given JTA transaction all share the same persistence context. In
      Hibernate terms, this means all managers share the same session.</p><p>Important: persistence context are never shared between different
      JTA transactions or between entity manager that do not came from the
      same entity manager factory. There are some noteworthy exceptions for
      context propagation when using extended persistence contexts:</p><div class="itemizedlist"><ul><li><p>If a stateless session bean, message-driven bean, or stateful
          session bean with a transaction-scoped persistence context calls a
          stateful session bean with an extended persistence context in the
          same JTA transaction, an
          <code class="classname">IllegalStateException</code> is thrown.</p></li><li><p>If a stateful session bean with an extended persistence
          context calls as stateless session bean or a stateful session bean
          with a transaction-scoped persistence context in the same JTA
          transaction, the persistence context is propagated.</p></li><li><p>If a stateful session bean with an extended persistence
          context calls a stateless or stateful session bean in a different
          JTA transaction context, the persistence context is not
          propagated.</p></li><li><p>If a stateful session bean with an extended persistence
          context instantiates another stateful session bean with an extended
          persistence context, the extended persistence context is inherited
          by the second stateful session bean. If the second stateful session
          bean is called with a different transaction context than the first,
          an IllegalStateException is thrown.</p></li><li><p>If a stateful session bean with an extended persistence
          context calls a stateful session bean with a different extended
          persistence context in the same transaction, an
          <code class="classname">IllegalStateException</code> is thrown.</p></li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="architecture-javase"/>1.3. Java SE environments</h2></div></div></div><p>In a Java SE environment only extended context application-managed
    entity managers are available. You can retrieve an entity manger using the
    <code class="literal">EntityManagerFactory</code> API. Only resource-local entity
    managers are available. In other words, JTA transactions and persistence
    context propagation are not supported in Java SE (you will have to
    propagate the persistence context yourself, e.g. using the thread local
    session pattern popular in the Hibernate community).</p><p>Extended context means that a persistence context is created when
    the entity manager is retrieved (using
    <code class="literal">EntityManagerFactory.createEntityManager(...)</code> ) and
    closed when the entity manager is closed. Many resource-local transaction
    share the same persistence context, in this case.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="configuration"/>Chapter 2. Setup and configuration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e215">2.1. Setup</a></span></dt><dt><span class="section"><a href="#setup-configuration">2.2. Configuration and bootstrapping</a></span></dt><dd><dl><dt><span class="section"><a href="#setup-configuration-packaging">2.2.1. Packaging</a></span></dt><dt><span class="section"><a href="#setup-configuration-bootstrapping">2.2.2. Bootstrapping</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e881">2.3. Event listeners</a></span></dt><dt><span class="section"><a href="#d0e996">2.4. Obtaining an EntityManager in a Java SE environment</a></span></dt><dt><span class="section"><a href="#d0e1021">2.5. Various</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e215"/>2.1. Setup</h2></div></div></div><p>The JPA 2.0 compatible Hibernate EntityManager is built on top of
    the core of Hibernate and Hibernate Annotations. Starting from version
    3.5, we have bundled in a single Hibernate distribution all the necessary
    modules:</p><div class="itemizedlist"><ul><li><p>Hibernate Core: the native Hibernate APIs and core engine</p></li><li><p>Hibernate Annotations: the annotation-based mapping</p></li><li><p>Hibernate EntityManager: the JPA 2.0 APIs and livecycle semantic
        implementation</p></li></ul></div><p>Download the Hibernate Core distribution. Set up your classpath
    (after you have created a new project in your favorite IDE):</p><div class="itemizedlist"><ul><li><p>Copy <code class="filename">hibernate3.jar</code> and the required 3rd
          party libraries available in
          <code class="filename">lib/required</code>.</p></li><li><p>Copy
          <code class="filename">lib/jpa/hibernate-jpa-2.0-api-1.0.0.Final.jar</code>
          to your classpath as well.</p></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>What is hibernate-jpa-2.0-api-x.y.z.jar?</h2><p>This is the JAR containing the JPA 2.0 API, it provides all the
      interfaces and concrete classes that the specification defines as public
      API. Said otherwise, you can use this JAR to bootstrap any JPA provider
      implementation. Note that you typically don't need it when you deploy
      your application in a Java EE 6 application server (like JBoss AS 6 for
      example).</p></div><p>Alternatively, if you use Maven, add the following
    dependencies</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">project</span><span class="xml_plain">&nbsp;...</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-entitymanager</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">${hibernate-core-version}</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">project</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>All the required dependencies like hibernate-core and
    hibernate-annotations will be dragged transitively.</p><p>We recommend you use <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://validator.hibernate.org">Hibernate Validator</a> and the
    Bean Validation specification capabilities as its integration with Java
    Persistence 2 has been standardized. Download Hibernate Validator 4 or
    above from the Hibernate website and add
    <code class="filename">hibernate-validator.jar</code> and
    <code class="filename">validation-api.jar</code> in your classpath. Alternatively
    add the following dependency in your <code class="filename">pom.xml</code>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">project</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-validator</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">${hibernate-validator-version}</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">project</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>If you wish to use <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://search.hibernate.org">Hibernate Search</a> (full-text
    search for Hibernate aplications), download it from the Hibernate website
    and add <code class="filename">hibernate-search.jar</code> and its dependencies in
    your classpath. Alternatively add the following dependency in your
    <code class="filename">pom.xml</code>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">project</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">groupId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">hibernate-search</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">artifactId</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">${hibernate-search-version}</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">version</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependency</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;...</span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">dependencies</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;...</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">project</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="setup-configuration"/>2.2. Configuration and bootstrapping</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="setup-configuration-packaging"/>2.2.1. Packaging</h3></div></div></div><p>The configuration for entity managers both inside an application
      server and in a standalone application reside in a persistence archive.
      A persistence archive is a JAR file which must define a
      <code class="literal">persistence.xml</code> file that resides in the
      <code class="filename">META-INF</code> folder. All properly annotated classes
      included in the archive (ie. having an <code class="literal">@Entity</code>
      annotation), all annotated packages and all Hibernate hbm.xml files
      included in the archive will be added to the persistence unit
      configuration, so by default, your persistence.xml will be quite
      minimalist:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&nbsp;http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">version</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;sample&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">java:/DefaultDS</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.dialect.HSQLDialect&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.hbm2ddl.auto&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;create-drop&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>Here's a more complete example of a
      <code class="filename"><code class="literal">persistence.xml</code></code> file</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&nbsp;http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">version</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;manager1&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">transaction-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;JTA&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">provider</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.HibernatePersistence</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">provider</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">java:/DefaultDS</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">jta-data-source</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">mapping-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">ormap.xml</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">mapping-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">jar-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">MyApp.jar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">jar-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.acme.Employee</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.acme.Person</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.acme.Address</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">shared-cache-mode</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">ENABLE_SELECTIVE</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">shared-cache-mode</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">validation-mode</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">CALLBACK</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">validation-mode</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.dialect.HSQLDialect&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.hbm2ddl.auto&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;create-drop&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><div class="variablelist"><dl><dt><span class="term"><code class="code">name</code></span></dt><dd><p>(attribute) Every entity manager must have a name.</p></dd><dt><span class="term"><code class="code">transaction-type</code></span></dt><dd><p>(attribute) Transaction type used. Either JTA or
            RESOURCE_LOCAL (default to JTA in a JavaEE environment and to
            RESOURCE_LOCAL in a JavaSE environment). When a jta-datasource is
            used, the default is JTA, if non-jta-datasource is used,
            RESOURCE_LOCAL is used.</p></dd><dt><span class="term"><code class="code">provider</code></span></dt><dd><p>The provider is a fully-qualified class name of the EJB
            Persistence provider. You do not have to define it if you don't
            work with several EJB3 implementations. This is needed when you
            are using multiple vendor implementations of EJB
            Persistence.</p></dd><dt><span class="term"><code class="code">jta-data-source</code>,
          <code class="code">non-jta-data-source</code></span></dt><dd><p>This is the JNDI name of where the javax.sql.DataSource is
            located. When running without a JNDI available Datasource, you
            must specify JDBC connections with Hibernate specific properties
            (see below).</p></dd><dt><span class="term"><code class="code">mapping-file</code></span></dt><dd><p>The class element specifies a EJB3 compliant XML mapping
            file that you will map. The file has to be in the classpath. As
            per the EJB3 specification, Hibernate EntityManager will try to
            load the mapping file located in the jar file at
            <code class="literal">META_INF/orm.xml</code>. Of course any explicit
            mapping file will be loaded too. As a matter of fact, you can
            provide any XML file in the mapping file element ie. either hbm
            files or EJB3 deployment descriptor.</p></dd><dt><span class="term"><code class="code">jar-file</code></span></dt><dd><p>The jar-file elements specifies a jar to analyse. All
            properly annotated classes, annotated packages and all hbm.xml
            files part of this jar file will be added to the persistence unit
            configuration. This element is mainly used in Java EE environment.
            Use of this one in Java SE should be considered as non portable,
            in this case a absolute url is needed. You can alternatively point
            to a directory (This is especially useful when in your test
            environment, the persistence.xml file is not under the same root
            directory or jar than your domain model).</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">jar-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">file:/home/turin/work/local/lab8/build/classes</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">jar-file</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></dd><dt><span class="term"><code class="code">exclude-unlisted-classes</code></span></dt><dd><p>Do not check the main jar file for annotated classes. Only
            explicit classes will be part of the persistence unit.</p></dd><dt><span class="term"><code class="code">class</code></span></dt><dd><p>The class element specifies a fully qualified class name
            that you will map. By default all properly annotated classes and
            all hbm.xml files found inside the archive are added to the
            persistence unit configuration. You can add some external entity
            through the class element though. As an extension to the
            specification, you can add a package name in the
            <code class="literal">&lt;class&gt;</code> element (eg
            <code class="code">&lt;class&gt;org.hibernate.eg&lt;/class&gt;</code>).
            Caution, the package will include the metadata defined at the
            package level (ie in <code class="filename">package-info.java</code>), it
            will not include all the classes of a given package.</p></dd><dt><span class="term">shared-cache-mode</span></dt><dd><p>By default, entities are elected for second-level cache if
            annotated with <code class="classname">@Cacheable</code>. You can
            however:</p><div class="itemizedlist"><ul><li><p><code class="literal">ALL</code>: force caching for all
                entities</p></li><li><p><code class="literal">NONE</code>: disable caching for all
                entities (useful to take second-level cache out of the
                equation)</p></li><li><p><code class="literal">ENABLE_SELECTIVE</code> (default): enable
                caching when explicitly marked</p></li><li><p><code class="literal">DISABLE_SELECTIVE</code>: enable caching
                unless explicitly marked as
                <code class="classname">@Cacheable(false)</code> (not
                recommended)</p></li></ul></div><p>See Hibernate Annotation's documentation for more
            details.</p></dd><dt><span class="term">validation-mode</span></dt><dd><p>By default, Bean Validation (and Hibernate Validator) is
            activated. When an entity is created, updated (and optionally
            deleted), it is validated before being sent to the database. The
            database schema generated by Hibernate also reflects the
            constraints declared on the entity.</p><p>You can fine-tune that if needed:</p><div class="itemizedlist"><ul><li><p><code class="literal">AUTO</code>: if Bean Validation is present
                in the classpath, CALLBACK and DDL are activated.</p></li><li><p><code class="literal">CALLBACK</code>: entities are validated on
                creation, update and deletion. If no Bean Validation provider
                is present, an exception is raised at initialization
                time.</p></li><li><p><code class="literal">DDL</code>: (not standard, see below)
                database schemas are entities are validated on creation,
                update and deletion. If no Bean Validation provider is
                present, an exception is raised at initialization time.</p></li><li><p><code class="literal">NONE</code>: Bean Validation is not used at
                all</p></li></ul></div><p>Unfortunately, <code class="literal">DDL</code> is not standard mode
            (though extremely useful) and you will not be able to put it in
            <code class="literal">&lt;validation-mode&gt;</code>. To use it, add a
            regular property</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.validation.mode&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;ddl</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>With this approach, you can mix ddl and callback
            modes:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.validation.mode&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;ddl,&nbsp;callback</span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">property</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></dd><dt><span class="term"><code class="code">properties</code></span></dt><dd><p>The properties element is used to specify vendor specific
            properties. This is where you will define your Hibernate specific
            configurations. This is also where you will have to specify JDBC
            connection information as well.</p><p>Here is a list of JPA 2 standard properties. Be sure to also
            Hibernate Core's documentation to see Hibernate specific
            properties.</p><div class="itemizedlist"><ul><li><p><code class="literal">javax.persistence.lock.timeout</code>
                pessimistic lock timeout in milliseconds
                (<code class="classname">Integer</code> or
                <code class="classname">String</code>), this is a hint used by
                Hibernate but requires support by your underlying
                database.</p></li><li><p><code class="literal">javax.persistence.query.timeout</code> query
                timeout in milliseconds (<code class="classname">Integer</code> or
                <code class="classname">String</code>), this is a hint used by
                Hibernate but requires support by your underlying database
                (TODO is that 100% true or do we use some other
                tricks).</p></li><li><p><code class="literal">javax.persistence.validation.mode</code>
                corresponds to the <code class="literal">validation-mode</code> element.
                Use it if you wish to use the non standard
                <code class="literal">DDL</code> value.</p></li><li><p><code class="literal">javax.persistence.validation.group.pre-persist</code>
                defines the group or list of groups to validate before
                persisting an entity. This is a comma separated fully
                qualified class name string (eg
                <code class="code">com.acme.groups.Common</code> or
                <code class="code">com.acme.groups.Common,
                javax.validation.groups.Default</code>). Defaults to the Bean
                Validation default group.</p></li><li><p><code class="literal">javax.persistence.validation.group.pre-update</code>
                defines the group or list of groups to validate before
                updating an entity. This is a comma separated fully qualified
                class name string (eg <code class="code">com.acme.groups.Common</code> or
                <code class="code">com.acme.groups.Common,
                javax.validation.groups.Default</code>). Defaults to the Bean
                Validation default group.</p></li><li><p><code class="literal">javax.persistence.validation.group.pre-remove</code>
                defines the group or list of groups to validate before
                persisting an entity. This is a comma separated fully
                qualified class name string (eg
                <code class="code">com.acme.groups.Common</code> or
                <code class="code">com.acme.groups.Common,
                javax.validation.groups.Default</code>). Defaults to no
                group.</p></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>To know more about Bean Validation and Hibernate
              Validator, check out Hibernate Validator's reference
              documentation as well as Hibernate Annotations's documentation
              on Bean Validation.</p></div><p>The following properties can only be used in a SE
            environment where no datasource/JNDI is available:</p><div class="itemizedlist"><ul><li><p><code class="literal">javax.persistence.jdbc.driver</code>: the
                fully qualified class name of the driver class</p></li><li><p><code class="literal">javax.persistence.jdbc.url</code>: the
                driver specific URL</p></li><li><p><code class="literal">javax.persistence.jdbc.user</code> the user
                name used for the database connection</p></li><li><p><code class="literal">javax.persistence.jdbc.password</code> the
                password used for the database connection</p></li></ul></div></dd></dl></div><p>Be sure to define the grammar definition in the
      <code class="literal">persistence</code> element since the JPA specification
      requires schema validation. If the <code class="literal">systemId</code> ends with
      <code class="literal">persistence_2_0.xsd</code>, Hibernate entityManager will use
      the version embedded in the hibernate-entitymanager.jar. It won't fetch
      the resource from the internet.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence&nbsp;http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">version</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="setup-configuration-bootstrapping"/>2.2.2. Bootstrapping</h3></div></div></div><p>The JPA specification defines a bootstrap procedure to access the
      <code class="classname">EntityManagerFactory</code> and the
      <code class="classname">EntityManager</code>. The bootstrap class is
      <code class="classname">javax.persistence.Persistence</code>, e.g.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">EntityManagerFactory</span><!-- <br/> --><span class="java_plain">&nbsp;emf&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Persistence</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEntityManagerFactory</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;manager1&quot;</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">or</span>
</span>
<!--  --><br/><span class="java_type">Map</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;configOverrides&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">HashMap</span><span class="java_operator">&lt;</span><span class="java_type">String</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Object</span><span class="java_operator">&gt;</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">configOverrides</span><span class="java_separator">.</span><span class="java_plain">put</span><span class="java_separator">(</span><span class="java_literal">&quot;hibernate.hbm2ddl.auto&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;create-drop&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">EntityManagerFactory</span><span class="java_plain">&nbsp;programmaticEmf&nbsp;</span><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Persistence</span><span class="java_separator">.</span><span class="java_plain">createEntityManagerFactory</span><span class="java_separator">(</span><span class="java_literal">&quot;manager1&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;configOverrides</span><span class="java_separator">);</span></pre><p>The first version is equivalent to the second with an empty map.
      The map version is a set of overrides that will take precedence over any
      properties defined in your <code class="filename">persistence.xml</code> files.
      All the properties defined in <a href="#setup-configuration-packaging" title="2.2.1. Packaging">Section 2.2.1, “Packaging”</a> can be passed to the
      <code class="methodname">createEntityManagerFactory</code> method and there are
      a few additional ones:</p><div class="itemizedlist"><ul><li><p><code class="literal">javax.persistence.provider</code> to define the
          provider class used</p></li><li><p><code class="literal">javax.persistence.transactionType</code> to define
          the transaction type used (either <code class="literal">JTA</code> or
          <code class="literal">RESOURCE_LOCAL</code>)</p></li><li><p><code class="literal">javax.persistence.jtaDataSource</code> to define
          the JTA datasource name in JNDI</p></li><li><p><code class="literal">javax.persistence.nonJtaDataSource</code> to
          define the non JTA datasource name in JNDI</p></li><li><p><code class="literal">javax.persistence.lock.timeout</code> pessimistic
          lock timeout in milliseconds (<code class="classname">Integer</code> or
          <code class="classname">String</code>)</p></li><li><p><code class="literal">javax.persistence.query.timeout</code> query
          timeout in milliseconds (<code class="classname">Integer</code> or
          <code class="classname">String</code>)</p></li><li><p><code class="literal">javax.persistence.sharedCache.mode</code>
          corresponds to the <code class="literal">share-cache-mode</code> element
          defined in <a href="#setup-configuration-packaging" title="2.2.1. Packaging">Section 2.2.1, “Packaging”</a>.</p></li><li><p><code class="literal">javax.persistence.validation.mode</code>
          corresponds to the <code class="literal">validation-mode</code> element
          defined in <a href="#setup-configuration-packaging" title="2.2.1. Packaging">Section 2.2.1, “Packaging”</a>.</p></li></ul></div><p>When <code class="code">Persistence.createEntityManagerFactory()</code> is
      called, the persistence implementation will search your classpath for
      any <code class="code">META-INF/persistence.xml</code> files using the
      <code class="code">ClassLoader.getResource("META-INF/persistence.xml")</code> method.
      Actually the <code class="classname">Persistence</code> class will look at all
      the Persistence Providers available in the classpath and ask each of
      them if they are responsible for the creation of the entity manager
      factory <code class="literal">manager1</code>. Each provider, from this list of
      resources, it will try to find an entity manager that matches the name
      you specify in the command line with what is specified in the
      persistence.xml file (of course the provider <code class="literal">element</code>
      must match the current persistent provider). If no persistence.xml with
      the correct name are found or if the expected persistence provider is
      not found, a <code class="classname">PersistenceException</code> is
      raised.</p><p>Apart from Hibernate system-level settings, all the properties
      available in Hibernate can be set in <code class="code">properties</code> element of
      the persistence.xml file or as an override in the map you pass to
      <code class="code">createEntityManagerFactory()</code>. Please refer to the Hibernate
      reference documentation for a complete listing. There are however a
      couple of properties available in the EJB3 provider only.</p><div class="table"><a id="d0e708"/><p class="title"><b>Table 2.1. Hibernate Entity Manager specific properties</b></p><div class="table-contents"><table summary="Hibernate Entity Manager specific properties" border="1"><colgroup><col align="left"/><col/></colgroup><thead><tr><th align="left">Property name</th><th>Description</th></tr></thead><tbody><tr><td align="left">hibernate.ejb.classcache.&lt;classname&gt;</td><td>class cache strategy [comma cache region] of the class
              Default to no cache, and default region cache to
              fully.qualified.classname (eg.
              hibernate.ejb.classcache.com.acme.Cat read-write or
              hibernate.ejb.classcache.com.acme.Cat read-write,
              MyRegion).</td></tr><tr><td align="left">hibernate.ejb.collectioncache.&lt;collectionrole&gt;</td><td>collection cache strategy [comma cache region] of the
              class Default to no cache, and default region cache to
              fully.qualified.classname.role (eg.
              hibernate.ejb.classcache.com.acme.Cat read-write or
              hibernate.ejb.classcache.com.acme.Cat read-write,
              MyRegion).</td></tr><tr><td align="left">hibernate.ejb.cfgfile</td><td>XML configuration file to use to configure Hibernate (eg.
              <code class="filename">/hibernate.cfg.xml</code>).</td></tr><tr><td align="left">hibernate.archive.autodetection</td><td>Determine which element is auto discovered by Hibernate
              Entity Manager while parsing the .par archive. (default to
              <code class="literal">class,hbm</code>).</td></tr><tr><td align="left">hibernate.ejb.interceptor</td><td>An optional Hibernate interceptor. The interceptor
              instance is shared by all <code class="classname">Session</code>
              instances. This interceptor has to implement
              <code class="classname">org.hibernate.Interceptor</code> and have a
              no-arg constructor. This property can not be combined with
              <code class="literal">hibernate.ejb.interceptor.session_scoped</code>.</td></tr><tr><td align="left">hibernate.ejb.interceptor.session_scoped</td><td>An optional Hibernate interceptor. The interceptor
              instance is specific to a given <code class="classname">Session</code>
              instance (and hence can be non thread-safe). This interceptor
              has to implement
              <code class="classname">org.hibernate.Interceptor</code> and have a
              no-arg constructor. This property can not be combined with
              <code class="literal">hibernate.ejb.interceptor</code>.</td></tr><tr><td align="left">hibernate.ejb.naming_strategy</td><td>An optional naming strategy. The class must have a no-arg
              constructor. The default naming strategy used is
              <code class="classname">EJB3NamingStrategy</code>. You also might want
              to consider the
              <code class="classname">DefaultComponentSafeNamingStrategy</code>.</td></tr><tr><td align="left">hibernate.ejb.persister_class_provider</td><td>A optional <code class="classname">PersisterClassProvider</code>
              implementation class name. The class must have a no-arg
              constructor.</td></tr><tr><td align="left">hibernate.ejb.session_factory_observer</td><td>A optional <code class="classname">SessionFactoryObserver</code>
              implementation class name. The class must have a no-arg
              constructor.</td></tr><tr><td align="left">hibernate.ejb.event.&lt;eventtype&gt;</td><td>Event listener list for a given eventtype. The list of
              event listeners is a comma separated fully qualified class name
              list (eg. hibernate.ejb.event.pre-load
              com.acme.SecurityListener, com.acme.AuditListener)</td></tr><tr><td align="left">hibernate.ejb.use_class_enhancer</td><td>Whether or not use Application server class enhancement
              at deployment time (default to false)</td></tr><tr><td align="left">hibernate.ejb.discard_pc_on_close</td><td>If true, the persistence context will be discarded (think
              clear() when the method is called. Otherwise the persistence
              context will stay alive till the transaction completion: all
              objects will remain managed, and any change will be synchronized
              with the database (default to false, ie wait the transaction
              completion)</td></tr><tr><td align="left">hibernate.ejb.resource_scanner</td><td><p>By default, Hibernate EntityManager scans itself
              the list of resources for annotated classes and persistence
              deployment descriptors (like orm.xml and hbm.xml
              files).</p><p>You can customize this scanning strategy by
              implementing
              <code class="classname">org.hibernate.ejb.packaging.Scanner</code>. This
              property is used by container implementors to improve
              integration with Hibernate.</p><p>Accepts an instance of
              <code class="classname">Scanner</code> or the file name of a no-arg
              constructor class implementing
              <code class="classname">Scanner</code>.</p></td></tr></tbody></table></div></div><br class="table-break"/><p>Note that you can mix XML <code class="literal">&lt;class&gt;</code>
      declaration and <code class="literal">hibernate.ejb.cfgfile</code> usage in the
      same configuration. Be aware of the potential clashed. The properties
      set in <code class="filename">persistence.xml</code> will override the one in the
      defined <code class="filename">hibernate.cfg.xml</code>.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>It is important that you do not override
        <code class="literal">hibernate.transaction.factory_class</code>, Hibernate
        EntityManager automatically set the appropriate transaction factory
        depending on the EntityManager type (ie <code class="literal">JTA</code> versus
        <code class="literal">RESOURSE_LOCAL</code>). If you are working in a Java EE
        environment, you might want to set the
        <code class="literal">hibernate.transaction.manager_lookup_class</code>
        though.</p></div><p>Here is a typical configuration in a Java SE environment</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;manager1&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">transaction-type</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;RESOURCE_LOCAL&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.test.Cat</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.test.Distributor</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.test.Item</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">class</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.jdbc.driver&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hsqldb.jdbcDriver&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.jdbc.user&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;sa&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.jdbc.password&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;javax.persistence.jdbc.url&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jdbc:hsqldb:.&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.dialect.HSQLDialect&quot;</span><span class="xml_plain">/</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="xml_attribute_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.max_fetch_depth&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;3&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;cache&nbsp;configuration&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.ejb.classcache.org.hibernate.ejb.test.Item&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;read-write&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;hibernate.ejb.collectioncache.org.hibernate.ejb.test.Item.distributors&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;read-write,&nbsp;RegionName&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;alternatively&nbsp;to&nbsp;&lt;class&gt;&nbsp;and&nbsp;&lt;property&gt;&nbsp;declarations,&nbsp;you&nbsp;can&nbsp;use&nbsp;a&nbsp;regular&nbsp;hibernate.cfg.xml&nbsp;file&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_comment">&lt;!--&nbsp;property&nbsp;name=&quot;hibernate.ejb.cfgfile&quot;&nbsp;value=&quot;/org/hibernate/ejb/test/hibernate.cfg.xml&quot;/&nbsp;--&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>To ease the programmatic configuration, Hibernate Entity Manager
      provide a proprietary API. This API is very similar to the
      <code class="classname">Configuration</code> API and share the same concepts:
      <code class="classname">Ejb3Configuration</code>. Refer to the JavaDoc and the
      Hibernate reference guide for more detailed informations on how to use
      it.</p><p>TODO: me more descriptive on some APIs like setDatasource()</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Ejb3Configuration</span><!-- <br/> --><span class="java_plain">&nbsp;cfg&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Ejb3Configuration</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">EntityManagerFactory</span><span class="java_plain">&nbsp;emf&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;cfg</span><span class="java_separator">.</span><span class="java_plain">addProperties</span><span class="java_separator">(</span><span class="java_plain">&nbsp;properties&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;some&nbsp;properties</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setInterceptor</span><span class="java_separator">(</span><span class="java_plain">&nbsp;myInterceptorImpl&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;set&nbsp;an&nbsp;interceptor</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addAnnotatedClass</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">MyAnnotatedClass</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;a&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;to&nbsp;be&nbsp;mapped</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addClass</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">NonAnnotatedClass</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;an&nbsp;hbm</span><span class="java_separator">.</span><span class="java_plain">xml&nbsp;file&nbsp;using&nbsp;the&nbsp;</span><span class="java_type">Hibernate</span><span class="java_plain">&nbsp;convention</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addRerousce</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&quot;mypath</span><span class="java_operator">/</span><span class="java_type">MyOtherCLass</span><span class="java_separator">.</span><span class="java_plain">hbm</span><span class="java_separator">.</span><span class="java_plain">xml&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;an&nbsp;hbm</span><span class="java_separator">.</span><span class="java_plain">xml&nbsp;file</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">addRerousce</span><span class="java_separator">(</span><span class="java_plain">&nbsp;&quot;mypath</span><span class="java_operator">/</span><span class="java_plain">orm</span><span class="java_separator">.</span><span class="java_plain">xml&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;an&nbsp;EJB3&nbsp;deployment&nbsp;descriptor</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">configure</span><span class="java_separator">(</span><span class="java_literal">&quot;/mypath/hibernate.cfg.xml&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">add&nbsp;a&nbsp;regular&nbsp;hibernate</span><span class="java_separator">.</span><span class="java_plain">cfg</span><span class="java_separator">.</span><span class="java_plain">xml</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">buildEntityManagerFactory</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_type">Create</span><span class="java_plain">&nbsp;the&nbsp;entity&nbsp;manager&nbsp;factory</span></pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e881"/>2.3. Event listeners</h2></div></div></div><p>Hibernate Entity Manager needs to enhance Hibernate core to
    implements all the JPA semantics. It does that through the event listener
    system of Hibernate. Be careful when you use the event system yourself,
    you might override some of the JPA semantics. A safe way is to add your
    event listeners to the list given below.</p><div class="table"><a id="d0e886"/><p class="title"><b>Table 2.2. Hibernate Entity Manager default event listeners</b></p><div class="table-contents"><table summary="Hibernate Entity Manager default event listeners" border="1"><colgroup><col align="left"/><col/></colgroup><thead><tr><th align="left">Event</th><th>Listeners</th></tr></thead><tbody><tr><td align="left">flush</td><td>org.hibernate.ejb.event.EJB3FlushEventListener</td></tr><tr><td align="left">auto-flush</td><td>org.hibernate.ejb.event.EJB3AutoFlushEventListener</td></tr><tr><td align="left">delete</td><td>org.hibernate.ejb.event.EJB3DeleteEventListener</td></tr><tr><td align="left">flush-entity</td><td>org.hibernate.ejb.event.EJB3FlushEntityEventListener</td></tr><tr><td align="left">merge</td><td>org.hibernate.ejb.event.EJB3MergeEventListener</td></tr><tr><td align="left">create</td><td>org.hibernate.ejb.event.EJB3PersistEventListener</td></tr><tr><td align="left">create-onflush</td><td>org.hibernate.ejb.event.EJB3PersistOnFlushEventListener</td></tr><tr><td align="left">save</td><td>org.hibernate.ejb.event.EJB3SaveEventListener</td></tr><tr><td align="left">save-update</td><td>org.hibernate.ejb.event.EJB3SaveOrUpdateEventListener</td></tr><tr><td align="left">pre-insert</td><td>org.hibernate.secure.internal.JACCPreInsertEventListener</td></tr><tr><td align="left">pre-insert</td><td>org.hibernate.secure.internal.JACCPreUpdateEventListener</td></tr><tr><td align="left">pre-delete</td><td>org.hibernate.secure.internal.JACCPreDeleteEventListener</td></tr><tr><td align="left">pre-load</td><td>org.hibernate.secure.internal.JACCPreLoadEventListener</td></tr><tr><td align="left">post-delete</td><td>org.hibernate.ejb.event.EJB3PostDeleteEventListener</td></tr><tr><td align="left">post-insert</td><td>org.hibernate.ejb.event.EJB3PostInsertEventListener</td></tr><tr><td align="left">post-load</td><td>org.hibernate.ejb.event.EJB3PostLoadEventListener</td></tr><tr><td align="left">post-update</td><td>org.hibernate.ejb.event.EJB3PostUpdateEventListener</td></tr></tbody></table></div></div><br class="table-break"/><p>Note that the <code class="classname">JACC*EventListeners</code> are removed
    if the security is not enabled.</p><p>You can configure the event listeners either through the properties
    (see <a href="#setup-configuration" title="2.2. Configuration and bootstrapping">Configuration and bootstrapping</a>) or through the
    <code class="methodname">ejb3configuration.getEventListeners()</code> API.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e996"/>2.4. Obtaining an EntityManager in a Java SE environment</h2></div></div></div><p>An entity manager factory should be considered as an immutable
    configuration holder, it is defined to point to a single datasource and to
    map a defined set of entities. This is the entry point to create and
    manage <code class="classname">EntityManager</code>s. The
    <code class="classname">Persistence</code> class is bootstrap class to create an
    entity manager factory.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Use</span><!-- <br/> --><span class="java_plain">&nbsp;persistence</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">xml&nbsp;configuration</span>
<!--  --><br/><span class="java_type">EntityManagerFactory</span><span class="java_plain">&nbsp;emf&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_type">Persistence</span><span class="java_separator">.</span><span class="java_plain">createEntityManagerFactory</span><span class="java_separator">(</span><span class="java_literal">&quot;manager1&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;emf</span><span class="java_separator">.</span><span class="java_plain">createEntityManager</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Retrieve</span><span class="java_plain">&nbsp;an&nbsp;application&nbsp;managed&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Work</span><span class="java_plain">&nbsp;with&nbsp;the&nbsp;EM</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">emf</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">close&nbsp;at&nbsp;application&nbsp;end</span></pre><p>An entity manager factory is typically create at application
    initialization time and closed at application end. It's creation is an
    expensive process. For those who are familiar with Hibernate, an entity
    manager factory is very much like a session factory. Actually, an entity
    manager factory is a wrapper on top of a session factory. Calls to the
    entityManagerFactory are thread safe.</p><p>Thanks to the <code class="classname">EntityManagerFactory</code>, you can
    retrieve an extended entity manager. The extended entity manager keep the
    same persistence context for the lifetime of the entity manager: in other
    words, the entities are still managed between two transactions (unless you
    call <code class="methodname">entityManager.clear()</code> in between). You can
    see an entity manager as a small wrapper on top of an Hibernate
    session.</p><p>TODO explains emf.createEntityManager(Map)</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1021"/>2.5. Various</h2></div></div></div><p>Hibernate Entity Manager comes with Hibernate Validator configured
    out of the box. You don't have to override any event yourself. If you do
    not use Hibernate Validator annotations in your domain model, there will
    be no performance cost. For more information on Hibernate Validator,
    please refer to the Hibernate Annotations reference guide.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="objectstate"/>Chapter 3. Working with objects</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e1030">3.1. Entity states</a></span></dt><dt><span class="section"><a href="#d0e1053">3.2. Making objects persistent</a></span></dt><dt><span class="section"><a href="#d0e1077">3.3. Loading an object</a></span></dt><dt><span class="section"><a href="#d0e1104">3.4. Querying objects</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1109">3.4.1. Executing queries</a></span></dt></dl></dd><dt><span class="section"><a href="#d0e1312">3.5. Modifying persistent objects</a></span></dt><dt><span class="section"><a href="#d0e1324">3.6. Detaching a object</a></span></dt><dt><span class="section"><a href="#d0e1334">3.7. Modifying detached objects</a></span></dt><dt><span class="section"><a href="#d0e1356">3.8. Automatic state detection</a></span></dt><dt><span class="section"><a href="#d0e1430">3.9. Deleting managed objects</a></span></dt><dt><span class="section"><a href="#d0e1440">3.10. Flush the persistence context</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e1445">3.10.1. In a transaction</a></span></dt><dt><span class="section"><a href="#d0e1522">3.10.2. Outside a transaction</a></span></dt></dl></dd><dt><span class="section"><a href="#objectstate-transitive">3.11. Transitive persistence</a></span></dt><dt><span class="section"><a href="#d0e1650">3.12. Locking</a></span></dt><dt><span class="section"><a href="#d0e1709">3.13. Caching</a></span></dt><dt><span class="section"><a href="#d0e1789">3.14. Checking the state of an object</a></span></dt><dt><span class="section"><a href="#d0e1815">3.15. Native Hibernate API</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1030"/>3.1. Entity states</h2></div></div></div><p>Like in Hibernate (comparable terms in parentheses), an entity
    instance is in one of the following states:</p><div class="itemizedlist"><ul><li><p>New (transient): an entity is new if it has just been
        instantiated using the new operator, and it is not associated with a
        persistence context. It has no persistent representation in the
        database and no identifier value has been assigned.</p></li><li><p>Managed (persistent): a managed entity instance is an instance
        with a persistent identity that is currently associated with a
        persistence context.</p></li><li><p>Detached: the entity instance is an instance with a persistent
        identity that is no longer associated with a persistence context,
        usually because the persistence context was closed or the instance was
        evicted from the context.</p></li><li><p>Removed: a removed entity instance is an instance with a
        persistent identity, associated with a persistence context, but
        scheduled for removal from the database.</p></li></ul></div><p>The <code class="classname">EntityManager</code> API allows you to change
    the state of an entity, or in other words, to load and store objects. You
    will find persistence with JPA easier to understand if you think about
    object state management, not managing of SQL statements.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1053"/>3.2. Making objects persistent</h2></div></div></div><p>Once you've created a new entity instance (using the common
    <code class="literal">new</code> operator) it is in <code class="literal">new</code> state.
    You can make it persistent by associating it to an entity manager:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">DomesticCat</span><!-- <br/> --><span class="java_plain">&nbsp;fritz&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">DomesticCat</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">fritz</span><span class="java_separator">.</span><span class="java_plain">setColor</span><span class="java_separator">(</span><span class="java_type">Color</span><span class="java_separator">.</span><span class="java_plain">GINGER</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fritz</span><span class="java_separator">.</span><span class="java_plain">setSex</span><span class="java_separator">(</span><span class="java_literal">'M'</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">fritz</span><span class="java_separator">.</span><span class="java_plain">setName</span><span class="java_separator">(</span><span class="java_literal">&quot;Fritz&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">fritz</span><span class="java_separator">);</span></pre><p>If the <code class="literal">DomesticCat</code> entity type has a generated
    identifier, the value is associated to the instance when
    <code class="code">persist()</code> is called. If the identifier is not automatically
    generated, the application-assigned (usually natural) key value has to be
    set on the instance before <code class="code">persist()</code> is called.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1077"/>3.3. Loading an object</h2></div></div></div><p>Load an entity instance by its identifier value with the entity
    manager's <code class="code">find()</code> method:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">cat&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">find</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;catId</span><!-- <br/> --><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">You</span><span class="java_plain">&nbsp;may&nbsp;need&nbsp;to&nbsp;wrap&nbsp;the&nbsp;primitive&nbsp;identifiers</span>
<!--  --><br/><span class="java_type">long</span><span class="java_plain">&nbsp;catId&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">1234</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">find</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Long</span><span class="java_separator">(</span><span class="java_plain">catId</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre><p>In some cases, you don't really want to load the object state, but
    just having a reference to it (ie a proxy). You can get this reference
    using the <code class="literal">getReference()</code> method. This is especially
    useful to link a child to its parent without having to load the
    parent.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">child&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Child</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">child</span><span class="java_separator">.</span><span class="java_type">SetName</span><span class="java_separator">(</span><span class="java_literal">&quot;Henry&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Parent</span><span class="java_plain">&nbsp;parent&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">getReference</span><span class="java_separator">(</span><span class="java_type">Parent</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;parentId</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">no&nbsp;query&nbsp;to&nbsp;the&nbsp;DB</span>
<!--  --><br/><span class="java_plain">child</span><span class="java_separator">.</span><span class="java_plain">setParent</span><span class="java_separator">(</span><span class="java_plain">parent</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">child</span><span class="java_separator">);</span></pre><p>You can reload an entity instance and it's collections at any time
    using the <code class="code">em.refresh()</code> operation. This is useful when
    database triggers are used to initialize some of the properties of the
    entity. Note that only the entity instance and its collections are
    refreshed unless you specify <code class="literal">REFRESH</code> as a cascade style
    of any associations:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">persist</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">cat</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">flush</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;force&nbsp;the&nbsp;SQL&nbsp;insert&nbsp;and&nbsp;triggers&nbsp;to&nbsp;run</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">refresh</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">re</span><span class="java_operator">-</span><span class="java_plain">read&nbsp;the&nbsp;state&nbsp;</span><span class="java_separator">(</span><span class="java_plain">after&nbsp;the&nbsp;trigger&nbsp;executes</span><span class="java_separator">)</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1104"/>3.4. Querying objects</h2></div></div></div><p>If you don't know the identifier values of the objects you are
    looking for, you need a query. The Hibernate EntityManager implementation
    supports an easy-to-use but powerful object-oriented query language
    (JP-QL) which has been inspired by HQL (and vice-versa). HQL is strictly
    speaking a superset of JP-QL. Both query languages are portable across
    databases, the use entity and property names as identifiers (instead of
    table and column names). You may also express your query in the native SQL
    of your database, with optional support from JPA for result set conversion
    into Java business objects.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1109"/>3.4.1. Executing queries</h3></div></div></div><p>JP-QL and SQL queries are represented by an instance of
      <code class="classname">javax.persistence.Query</code>. This interface offers
      methods for parameter binding, result set handling, and for execution of
      the query. Queries are always created using the current entity
      manager:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">List</span><!-- <br/> --><span class="java_operator">&lt;?&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;cats&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;where&nbsp;cat.birthdate&nbsp;&lt;&nbsp;?1&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">TemporalType</span><span class="java_separator">.</span><span class="java_plain">DATE</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;mothers&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;mother&nbsp;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;join&nbsp;cat.mother&nbsp;as&nbsp;mother&nbsp;where&nbsp;cat.name&nbsp;=&nbsp;?1&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;name</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;kittens&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;where&nbsp;cat.mother&nbsp;=&nbsp;?1&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setEntity</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;pk</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;mother&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">)</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;cat.mother&nbsp;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;where&nbsp;cat&nbsp;=&nbsp;?1&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;izi</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span></pre><p>A query is usually executed by invoking
      <code class="methodname">getResultList()</code>. This method loads the
      resulting instances of the query completely into memory. Entity
      instances retrieved by a query are in persistent state. The
      <code class="methodname">getSingleResult() </code>method offers a shortcut if
      you know your query will only return a single object.</p><p>JPA 2 provides more type-safe approaches to queries. The truly
      type-safe approach is the Criteria API explained in <a href="#querycriteria" title="Chapter 9. Criteria Queries">Chapter 9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Criteria Queries</i></a>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;criteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Cat</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cat&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;criteria</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">criteria</span><span class="java_separator">.</span><span class="java_plain">select</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cat&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">criteria</span><span class="java_separator">.</span><span class="java_plain">where</span><span class="java_separator">(</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">lt</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cat</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat_</span><span class="java_separator">.</span><span class="java_plain">birthdate&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;catDate&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Cat</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;criteria&nbsp;</span><span class="java_separator">).</span><span class="java_plain">getResultList</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">notice&nbsp;no&nbsp;downcasting&nbsp;is&nbsp;necessary</span></pre><p>But you can benefit form some type-safe convenience even when
      using JP-QL (note that it's not as type-safe as the compiler has to
      trust you with the return type.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_type">No</span><!-- <br/> --><span class="java_plain">&nbsp;downcasting&nbsp;since&nbsp;we&nbsp;pass&nbsp;the&nbsp;</span><!-- <br/> --><span class="java_keyword">return</span><!-- <br/> --><span class="java_plain">&nbsp;type</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Cat</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;where&nbsp;cat.birthdate&nbsp;&lt;&nbsp;?1&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;date</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">TemporalType</span><span class="java_separator">.</span><span class="java_plain">DATE</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>We highly recommend the Criteria API approach. While more
        verbose, it provides compiler-enforced safety (including down to
        property names) which will pay off when the application will move to
        maintenance mode.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1140"/>3.4.1.1. Projection</h4></div></div></div><p>JPA queries can return tuples of objects if projection is used.
        Each result tuple is returned as an object array:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Iterator</span><!-- <br/> --><span class="java_plain">&nbsp;kittensAndMothers&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;sess</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;kitten,&nbsp;mother&nbsp;from&nbsp;Cat&nbsp;kitten&nbsp;join&nbsp;kitten.mother&nbsp;mother&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">iterator</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;kittensAndMothers</span><span class="java_separator">.</span><span class="java_plain">hasNext</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;tuple&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Object</span><span class="java_separator">[])</span><span class="java_plain">&nbsp;kittensAndMothers</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;kitten&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">)</span><span class="java_plain">&nbsp;tuple</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;mother&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">)</span><span class="java_plain">&nbsp;tuple</span><span class="java_separator">[</span><span class="java_literal">1</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">....</span>
<!--  --><br/><span class="java_separator">}</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>The criteria API provides a type-safe approach to projection
          results. Check out <a href="#querycriteria-tuple" title="9.2. Tuple criteria queries">Section 9.2, “Tuple criteria queries”</a>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1152"/>3.4.1.2. Scalar results</h4></div></div></div><p>Queries may specify a particular property of an entity in the
        select clause, instead of an entity alias. You may call SQL aggregate
        functions as well. Returned non-transactional objects or aggregation
        results are considered "scalar" results and are not entities in
        persistent state (in other words, they are considered "read
        only"):</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Iterator</span><!-- <br/> --><span class="java_plain">&nbsp;results&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;select&nbsp;cat.color,&nbsp;min(cat.birthdate),&nbsp;count(cat)&nbsp;from&nbsp;Cat&nbsp;cat&nbsp;&quot;</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_literal">&quot;group&nbsp;by&nbsp;cat.color&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">()</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">iterator</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_keyword">while</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">hasNext</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Object</span><span class="java_separator">[]</span><span class="java_plain">&nbsp;row&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;results</span><span class="java_separator">.</span><span class="java_plain">next</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Color</span><span class="java_plain">&nbsp;type&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Color</span><span class="java_separator">)</span><span class="java_plain">&nbsp;row</span><span class="java_separator">[</span><span class="java_literal">0</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;oldest&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Date</span><span class="java_separator">)</span><span class="java_plain">&nbsp;row</span><span class="java_separator">[</span><span class="java_literal">1</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;count&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Integer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;row</span><span class="java_separator">[</span><span class="java_literal">2</span><span class="java_separator">];</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.....</span>
<!--  --><br/><span class="java_separator">}</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1159"/>3.4.1.3. Bind parameters</h4></div></div></div><p>Both named and positional query parameters are supported, the
        <code class="literal">Query</code> API offers several methods to bind arguments.
        The JPA specification numbers positional parameters from one. Named
        parameters are identifiers of the form <code class="literal">:paramname</code>
        in the query string. Named parameters should be preferred, they are
        more robust and easier to read and understand:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Named</span><!-- <br/> --><span class="java_plain">&nbsp;parameter&nbsp;</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">preferred</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;DomesticCat&nbsp;cat&nbsp;where&nbsp;cat.name&nbsp;=&nbsp;:name&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Fritz&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Positional</span><span class="java_plain">&nbsp;parameter</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;DomesticCat&nbsp;cat&nbsp;where&nbsp;cat.name&nbsp;=&nbsp;?1&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Izi&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Named</span><span class="java_plain">&nbsp;parameter&nbsp;list</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;names&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">ArrayList</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">names</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_literal">&quot;Izi&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">names</span><span class="java_separator">.</span><span class="java_plain">add</span><span class="java_separator">(</span><span class="java_literal">&quot;Fritz&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;DomesticCat&nbsp;cat&nbsp;where&nbsp;cat.name&nbsp;in&nbsp;(:namesList)&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_literal">&quot;namesList&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;names</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">list</span><span class="java_separator">();</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1172"/>3.4.1.4. Pagination</h4></div></div></div><p>If you need to specify bounds upon your result set (the maximum
        number of rows you want to retrieve and/or the first row you want to
        retrieve), use the following methods:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;q&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;DomesticCat&nbsp;cat&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setFirstResult</span><span class="java_separator">(</span><span class="java_literal">20</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setMaxResults</span><span class="java_separator">(</span><span class="java_literal">10</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;cats&nbsp;from&nbsp;the&nbsp;</span><span class="java_literal">20</span><span class="java_plain">th&nbsp;position&nbsp;to&nbsp;</span><span class="java_literal">29</span><span class="java_plain">th</span></pre><p>Hibernate knows how to translate this limit query into the
        native SQL of your DBMS.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1181"/>3.4.1.5. Externalizing named queries</h4></div></div></div><p>You may also define named queries through annotations:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@javax</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">persistence</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_type">NamedQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;eg.DomesticCat.by.name.and.minimum.weight&quot;</span><!-- <br/> --><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;query</span><span class="java_operator">=</span><span class="java_literal">&quot;select&nbsp;cat&nbsp;from&nbsp;eg.DomesticCat&nbsp;as&nbsp;cat&nbsp;&nbsp;where&nbsp;cat.name&nbsp;=&nbsp;?1&nbsp;and&nbsp;cat.weight&nbsp;&gt;&nbsp;?2&quot;</span><span class="java_separator">)</span></pre><p>Parameters are bound programmatically to the named query, before
        it is executed:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;q&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createNamedQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;eg.DomesticCat.by.name.and.minimum.weight&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;name</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setInt</span><span class="java_separator">(</span><span class="java_literal">2</span><span class="java_separator">,</span><span class="java_plain">&nbsp;minWeight</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;?&gt;</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><p>You can also use the slightly more type-safe approach:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;q&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createNamedQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;eg.DomesticCat.by.name.and.minimum.weight&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setString</span><span class="java_separator">(</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;name</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setInt</span><span class="java_separator">(</span><span class="java_literal">2</span><span class="java_separator">,</span><span class="java_plain">&nbsp;minWeight</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">List</span><span class="java_operator">&lt;</span><span class="java_type">Cat</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;cats&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><p>Note that the actual program code is independent of the query
        language that is used, you may also define native SQL queries in
        metadata, or use Hibernate's native facilities by placing them in XML
        mapping files.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1198"/>3.4.1.6. Native queries</h4></div></div></div><p>You may express a query in SQL, using
        <code class="methodname">createNativeQuery()</code> and let Hibernate take
        care mapping from JDBC result sets to business objects. Use the
        <code class="literal">@SqlResultSetMapping</code> (please see the Hibernate
        Annotations reference documentation on how to map a SQL resultset
        mapping) or the entity mapping (if the column names of the query
        result are the same as the names declared in the entity mapping;
        remember that all entity columns have to be returned for this
        mechanism to work):</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">SqlResultSetMapping</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;getItem&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;entities&nbsp;</span><!-- <br/> --><span class="java_operator">=</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">entityClass</span><span class="java_operator">=</span><span class="java_plain">org</span><span class="java_separator">.</span><span class="java_plain">hibernate</span><span class="java_separator">.</span><span class="java_plain">ejb</span><span class="java_separator">.</span><span class="java_plain">test</span><span class="java_separator">.</span><span class="java_type">Item</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;itemname&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;descr&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;itemdescription&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;select&nbsp;name&nbsp;as&nbsp;itemname,&nbsp;descr&nbsp;as&nbsp;itemdescription&nbsp;from&nbsp;Item&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;getItem&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">item&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Item</span><span class="java_separator">)</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">from&nbsp;a&nbsp;resultset</span>
</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;select&nbsp;*&nbsp;from&nbsp;Item&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">Item</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">item&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Item</span><span class="java_separator">)</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">from&nbsp;a&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;columns&nbsp;names&nbsp;match&nbsp;the&nbsp;mapping</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>For more information about scalar support in named queries,
          please refers to the Hibernate Annotations documentation</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1214"/>3.4.1.7. Query lock and flush mode</h4></div></div></div><p>You can adjust the flush mode used when executing the query as
        well as define the lock mode used to load the entities.</p><p>Adjusting the flush mode is interesting when one must guaranty
        that a query execution will not trigger a flush operation. Most of the
        time you don't need to care about this.</p><p>Adjusting the lock mode is useful if you need to lock the
        objects returns by the query to a certain level.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">query</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">setFlushMode</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">FlushModeType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">COMMIT</span><!-- <br/> --><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setLockMode</span><span class="java_separator">(</span><span class="java_type">LockModeType</span><span class="java_separator">.</span><span class="java_plain">PESSIMISTIC_READ</span><span class="java_separator">);</span></pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>If you want to use <code class="literal">FlushMode.MANUAL</code> (ie the
          Hibernate specific flush mode), you will need to use a query hint.
          See below.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e1231"/>3.4.1.8. Query hints</h4></div></div></div><p>Query hints (for performance optimization, usually) are
        implementation specific. Hints are declared using the
        <code class="methodname">query.setHint(String name, Object value)</code>
        method, or through the <code class="literal">@Named(Native)Query(hints)</code>
        annotation Note that these are not SQL query hints! The Hibernate EJB3
        implementation offers the following query hints:</p><div class="table"><a id="d0e1242"/><p class="title"><b>Table 3.1. Hibernate query hints</b></p><div class="table-contents"><table summary="Hibernate query hints" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="center">Hint</th><th align="center">Description</th></tr></thead><tbody><tr><td>org.hibernate.timeout</td><td>Query timeout in seconds ( eg. new Integer(10)
                )</td></tr><tr><td>org.hibernate.fetchSize</td><td>Number of rows fetched by the JDBC driver per roundtrip
                ( eg. new Integer(50) )</td></tr><tr><td>org.hibernate.comment</td><td>Add a comment to the SQL query, useful for the DBA (
                e.g. new String("fetch all orders in 1 statement") )</td></tr><tr><td>org.hibernate.cacheable</td><td>Whether or not a query is cacheable ( eg. new
                Boolean(true) ), defaults to false</td></tr><tr><td>org.hibernate.cacheMode</td><td>Override the cache mode for this query ( eg.
                CacheMode.REFRESH )</td></tr><tr><td>org.hibernate.cacheRegion</td><td>Cache region of this query ( eg. new
                String("regionName") )</td></tr><tr><td>org.hibernate.readOnly</td><td>Entities retrieved by this query will be loaded in a
                read-only mode where Hibernate will never dirty-check them or
                make changes persistent ( eg. new Boolean(true) ), default to
                false</td></tr><tr><td>org.hibernate.flushMode</td><td>Flush mode used for this query (useful to pass
                Hibernate specific flush modes, in particular
                <code class="literal">MANUAL</code>).</td></tr><tr><td>org.hibernate.cacheMode</td><td>Cache mode used for this query</td></tr></tbody></table></div></div><br class="table-break"/><p>The value object accept both the native type or its string
        equivalent (eg. <code class="literal">CaheMode.REFRESH</code> or
        “<span class="quote"><code class="literal">REFRESH</code></span>”). Please refer to the
        Hibernate reference documentation for more information.</p></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1312"/>3.5. Modifying persistent objects</h2></div></div></div><p>Transactional managed instances (ie. objects loaded, saved, created
    or queried by the entity manager) may be manipulated by the application
    and any changes to persistent state will be persisted when the Entity
    manager is flushed (discussed later in this chapter). There is no need to
    call a particular method to make your modifications persistent. A
    straightforward way to update the state of an entity instance is to
    <code class="methodname">find()</code> it, and then manipulate it directly, while
    the persistence context is open:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_plain">&nbsp;cat&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">find</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Long</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">69</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cat</span><span class="java_separator">.</span><span class="java_plain">setName</span><span class="java_separator">(</span><span class="java_literal">&quot;PK&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">flush</span><span class="java_separator">();</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;changes&nbsp;to&nbsp;cat&nbsp;are&nbsp;automatically&nbsp;detected&nbsp;and&nbsp;persisted</span></pre><p>Sometimes this programming model is inefficient since it would
    require both an SQL SELECT (to load an object) and an SQL UPDATE (to
    persist its updated state) in the same session. Therefore Hibernate offers
    an alternate approach, using detached instances.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1324"/>3.6. Detaching a object</h2></div></div></div><p>An object when loaded in the persistence context is managed by
    Hibernate. You can force an object to be detached (ie. no longer managed
    by Hibernate) by closing the EntityManager or in a more fine-grained
    approach by calling the <code class="methodname">detach()</code> method.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_plain">&nbsp;cat&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">find</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_keyword">new</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Long</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">69</span><!-- <br/> --><span class="java_separator">)</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">detach</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">cat</span><span class="java_separator">.</span><span class="java_plain">setName</span><span class="java_separator">(</span><span class="java_literal">&quot;New&nbsp;name&quot;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">not&nbsp;propatated&nbsp;to&nbsp;the&nbsp;database</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1334"/>3.7. Modifying detached objects</h2></div></div></div><p>Many applications need to retrieve an object in one transaction,
    send it to the presentation layer for manipulation, and later save the
    changes in a new transaction. There can be significant user think and
    waiting time between both transactions. Applications that use this kind of
    approach in a high-concurrency environment usually use versioned data to
    ensure isolation for the "long" unit of work.</p><p>The JPA specifications supports this development model by providing
    for persistence of modifications made to detached instances using the
    <code class="methodname">EntityManager.merge()</code> method:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;in&nbsp;the&nbsp;first&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;cat&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstEntityManager</span><span class="java_separator">.</span><span class="java_plain">find</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;catId</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;potentialMate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">firstEntityManager</span><span class="java_separator">.</span><span class="java_plain">persist</span><span class="java_separator">(</span><span class="java_plain">potentialMate</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;in&nbsp;a&nbsp;higher&nbsp;layer&nbsp;of&nbsp;the&nbsp;application</span>
<!--  --><br/><span class="java_plain">cat</span><span class="java_separator">.</span><span class="java_plain">setMate</span><span class="java_separator">(</span><span class="java_plain">potentialMate</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;later</span><span class="java_separator">,</span><span class="java_plain">&nbsp;in&nbsp;a&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_plain">secondEntityManager</span><span class="java_separator">.</span><span class="java_plain">merge</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;update&nbsp;cat</span>
<!--  --><br/><span class="java_plain">secondEntityManager</span><span class="java_separator">.</span><span class="java_plain">merge</span><span class="java_separator">(</span><span class="java_plain">mate</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;update&nbsp;mate</span></pre><p>The <code class="literal">merge()</code> method merges modifications made to
    the detached instance into the corresponding managed instance, if any,
    without consideration of the state of the persistence context. In other
    words, the merged objects state overrides the persistent entity state in
    the persistence context, if one is already present. The application should
    individually <code class="methodname">merge()</code> detached instances reachable
    from the given detached instance if and only if it wants their state also
    to be persistent. This can be cascaded to associated entities and
    collections, using transitive persistence, see <a href="#objectstate-transitive" title="3.11. Transitive persistence">Transitive persistence</a>.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1356"/>3.8. Automatic state detection</h2></div></div></div><p>The merge operation is clever enough to automatically detect whether
    the merging of the detached instance has to result in an insert or update.
    In other words, you don't have to worry about passing a new instance (and
    not a detached instance) to <code class="literal">merge()</code>, the entity manager
    will figure this out for you:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">In</span><!-- <br/> --><span class="java_plain">&nbsp;the&nbsp;first&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;cat&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;firstEntityManager</span><span class="java_separator">.</span><span class="java_plain">find</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;catID</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">In</span><span class="java_plain">&nbsp;a&nbsp;higher&nbsp;layer&nbsp;of&nbsp;the&nbsp;application</span><span class="java_separator">,</span><span class="java_plain">&nbsp;detached</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;mate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">cat</span><span class="java_separator">.</span><span class="java_plain">setMate</span><span class="java_separator">(</span><span class="java_plain">mate</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Later</span><span class="java_separator">,</span><span class="java_plain">&nbsp;in&nbsp;a&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_plain">secondEntityManager</span><span class="java_separator">.</span><span class="java_plain">merge</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;update&nbsp;existing&nbsp;state</span>
<!--  --><br/><span class="java_plain">secondEntityManager</span><span class="java_separator">.</span><span class="java_plain">merge</span><span class="java_separator">(</span><span class="java_plain">mate</span><span class="java_separator">);</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;save&nbsp;the&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;instance</span></pre><p>The usage and semantics of <code class="literal">merge()</code> seems to be
    confusing for new users. Firstly, as long as you are not trying to use
    object state loaded in one entity manager in another new entity manager,
    you should not need to use <code class="methodname">merge()</code> at all. Some
    whole applications will never use this method.</p><p>Usually <code class="methodname">merge()</code> is used in the following
    scenario:</p><div class="itemizedlist"><ul><li><p>the application loads an object in the first entity
        manager</p></li><li><p>the object is passed up to the presentation layer</p></li><li><p>some modifications are made to the object</p></li><li><p>the object is passed back down to the business logic
        layer</p></li><li><p>the application persists these modifications by calling
        <code class="methodname">merge()</code> in a second entity manager</p></li></ul></div><p>Here is the exact semantic of
    <code class="methodname">merge()</code>:</p><div class="itemizedlist"><ul><li><p>if there is a managed instance with the same identifier
        currently associated with the persistence context, copy the state of
        the given object onto the managed instance</p></li><li><p>if there is no managed instance currently associated with the
        persistence context, try to load it from the database, or create a new
        managed instance</p></li><li><p>the managed instance is returned</p></li><li><p>the given instance does not become associated with the
        persistence context, it remains detached and is usually
        discarded</p></li></ul></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Merging vs. saveOrUpdate/saveOrUpdateCopy</h2><p>Merging in JPA is similar to the
      <code class="literal">saveOrUpdateCopy()</code> method in native Hibernate.
      However, it is not the same as the <code class="literal">saveOrUpdate()</code>
      method, the given instance is not reattached with the persistence
      context, but a managed instance is returned by the
      <code class="methodname">merge()</code> method.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1430"/>3.9. Deleting managed objects</h2></div></div></div><p><code class="methodname">EntityManager.remove()</code> will remove an
    objects state from the database. Of course, your application might still
    hold a reference to a deleted object. You can think of
    <code class="methodname">remove()</code> as making a persistent instance new (aka
    transient) again. It is not detached, and a merge would result in an
    insertion.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1440"/>3.10. Flush the persistence context</h2></div></div></div><p>From time to time the entity manager will execute the SQL DML
    statements needed to synchronize the data store with the state of objects
    held in memory. This process is called flushing.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1445"/>3.10.1. In a transaction</h3></div></div></div><p>Flush occurs by default (this is Hibernate specific and not
      defined by the specification) at the following points:</p><div class="itemizedlist"><ul><li><p>before query execution*</p></li><li><p>from
          <code class="methodname">javax.persistence.EntityTransaction.commit()*</code></p></li><li><p>when <code class="methodname">EntityManager.flush()</code> is
          called*</p></li></ul></div><p>(*) if a transaction is active</p><p>The SQL statements are issued in the following order</p><div class="itemizedlist"><ul><li><p>all entity insertions, in the same order the corresponding
          objects were saved using
          <code class="methodname">EntityManager.persist()</code></p></li><li><p>all entity updates</p></li><li><p>all collection deletions</p></li><li><p>all collection element deletions, updates and
          insertions</p></li><li><p>all collection insertions</p></li><li><p>all entity deletions, in the same order the corresponding
          objects were deleted using
          <code class="methodname">EntityManager.remove()</code></p></li></ul></div><p>(Exception: entity instances using application-assigned
      identifiers are inserted when they are saved.)</p><p>Except when you explicitly <code class="methodname">flush()</code>, there
      are no guarantees about when the entity manager executes the JDBC calls,
      only the order in which they are executed. However, Hibernate does
      guarantee that the
      <code class="methodname">Query.getResultList()</code>/<code class="methodname">Query.getSingleResult()</code>
      will never return stale data; nor will they return wrong data if
      executed in an active transaction.</p><p>It is possible to change the default behavior so that flush occurs
      less frequently. The <code class="classname">FlushModeType</code> for an entity
      manager defines two different modes: only flush at commit time or flush
      automatically using the explained routine unless
      <code class="methodname">flush()</code> is called explicitly.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">em&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;emf</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEntityManager</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Transaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">begin</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">setFlushMode</span><span class="java_separator">(</span><span class="java_type">FlushModeType</span><span class="java_separator">.</span><span class="java_plain">COMMIT</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;allow&nbsp;queries&nbsp;to&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;stale&nbsp;state</span>
</span>
<!--  --><br/><span class="java_type">Cat</span><span class="java_plain">&nbsp;izi&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">find</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;id</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">izi</span><span class="java_separator">.</span><span class="java_plain">setName</span><span class="java_separator">(</span><span class="java_plain">iznizi</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;might&nbsp;</span><span class="java_keyword">return</span><span class="java_plain">&nbsp;stale&nbsp;data</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_literal">&quot;from&nbsp;Cat&nbsp;as&nbsp;cat&nbsp;left&nbsp;outer&nbsp;join&nbsp;cat.kittens&nbsp;kitten&quot;</span><span class="java_separator">).</span><span class="java_plain">getResultList</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;change&nbsp;to&nbsp;izi&nbsp;is&nbsp;not&nbsp;flushed</span><span class="java_operator">!</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">commit</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;flush&nbsp;occurs</span></pre><p>During flush, an exception might happen (e.g. if a DML operation
      violates a constraint). TODO: Add link to exception handling.</p><p>Hibernate provides more flush modes than the one described in the
      JPA specification. In particular <code class="literal">FlushMode.MANUAL</code> for
      long running conversation. Please refer to the Hibernate core reference
      documentation for more informations.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1522"/>3.10.2. Outside a transaction</h3></div></div></div><p>In an <code class="literal">EXTENDED</code> persistence context, all read
      only operations of the entity manager can be executed outside a
      transaction (<code class="literal">find()</code>,
      <code class="literal">getReference()</code>, <code class="literal">refresh()</code>, and
      read queries). Some modifications operations can be executed outside a
      transaction, but they are queued until the persistence context join a
      transaction. This is the case of <code class="literal">persist()</code>,
      <code class="literal"><code class="literal">merge()</code></code>,
      <code class="literal">remove()</code>. Some operations cannot be called outside a
      transaction: <code class="literal">flush()</code>, <code class="literal">lock()</code>, and
      update/delete queries.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="objectstate-transitive"/>3.11. Transitive persistence</h2></div></div></div><p>It is quite cumbersome to save, delete, or reattach individual
    objects, especially if you deal with a graph of associated objects. A
    common case is a parent/child relationship. Consider the following
    example:</p><p>If the children in a parent/child relationship would be value typed
    (e.g. a collection of addresses or strings), their lifecycle would depend
    on the parent and no further action would be required for convenient
    "cascading" of state changes. When the parent is persisted, the
    value-typed child objects are persisted as well, when the parent is
    removed, the children will be removed, etc. This even works for operations
    such as the removal of a child from the collection; Hibernate will detect
    this and, since value-typed objects can't have shared references, remove
    the child from the database.</p><p>Now consider the same scenario with parent and child objects being
    entities, not value-types (e.g. categories and items, or parent and child
    cats). Entities have their own lifecycle, support shared references (so
    removing an entity from the collection does not mean it can be deleted),
    and there is by default no cascading of state from one entity to any other
    associated entities. The EJB3 specification does not require persistence
    by reachability. It supports a more flexible model of transitive
    persistence, as first seen in Hibernate.</p><p>For each basic operation of the entity manager - including
    <code class="methodname">persist()</code>, <code class="methodname">merge()</code>,
    <code class="methodname">remove()</code>, <code class="methodname">refresh()</code> -
    there is a corresponding cascade style. Respectively, the cascade styles
    are named <code class="literal">PERSIST</code>, <code class="literal">MERGE</code>,
    <code class="literal">REMOVE</code>, <code class="literal">REFRESH</code>,
    <code class="literal">DETACH</code>. If you want an operation to be cascaded to
    associated entity (or collection of entities), you must indicate that in
    the association annotation:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">OneToOne</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">cascade</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_type">CascadeType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">PERSIST</span><!-- <br/> --><span class="java_separator">)</span></pre><p>Cascading options can be combined:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">OneToOne</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">cascade</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">{</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CascadeType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">PERSIST</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CascadeType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">REMOVE</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">CascadeType</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">REFRESH&nbsp;</span><!-- <br/> --><span class="java_separator">}</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">)</span></pre><p>You may even use <code class="literal">CascadeType.ALL</code> to specify that
    all operations should be cascaded for a particular association. Remember
    that by default, no operation is cascaded.</p><p>There is an additional cascading mode used to describe orphan
    deletion (ie an object no longer linked to an owning object should be
    removed automatically by Hibernate. Use
    <code class="literal">orphanRemoval=true</code> on <code class="classname">@OneToOne</code>
    or <code class="classname">@OneToMany</code>. Check Hibernate Annotations's
    documentation for more information.</p><p>Hibernate offers more native cascading options, please refer to the
    Hibernate Annotations manual and the Hibernate reference guide for more
    informations.</p><p>Recommendations:</p><div class="itemizedlist"><ul><li><p>It doesn't usually make sense to enable cascade on a
        <code class="literal">@ManyToOne</code> or <code class="literal">@ManyToMany</code>
        association. Cascade is often useful for <code class="literal">@OneToOne</code>
        and <code class="literal">@OneToMany</code> associations.</p></li><li><p>If the child object's lifespan is bounded by the lifespan of the
        parent object, make the parent a full lifecycle object by specifying
        <code class="literal">CascadeType.ALL</code> and
        <code class="literal">org.hibernate.annotations.CascadeType.DELETE_ORPHAN</code>
        (please refer to the Hibernate reference guide for the semantics of
        orphan delete)</p></li><li><p>Otherwise, you might not need cascade at all. But if you think
        that you will often be working with the parent and children together
        in the same transaction, and you want to save yourself some typing,
        consider using <code class="code">cascade={PERSIST, MERGE}</code>. These options
        can even make sense for a many-to-many association.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1650"/>3.12. Locking</h2></div></div></div><p>You can define various levels of locking strategies. A lock can be
    applied in several ways:</p><div class="itemizedlist"><ul><li><p>via the explicit <code class="methodname">entityManager.lock()</code>
        method</p></li><li><p>via lookup methods on <code class="classname">EntityManager</code>:
        <code class="literal">find()</code>, <code class="literal">refresh()</code></p></li><li><p>on queries: <code class="methodname">query.setLockMode()</code></p></li></ul></div><p>You can use various lock approaches:</p><div class="itemizedlist"><ul><li><p><code class="literal">OPTIMISTIC</code> (previously
        <code class="literal">READ</code>): use an optimistic locking scheme where the
        version number is compared: the version number is compared and has to
        match before the transaction is committed.</p></li><li><p><code class="literal">OPTIMISTIC_FORCE_INCREMENT</code> (previously
        <code class="literal">WRITE</code>): use an optimistic locking scheme but force
        a version number increase as well: the version number is compared and
        has to match before the transaction is committed.</p></li><li><p><code class="literal">PESSIMISTIC_READ</code>: apply a database-level read
        lock when the lock operation is requested: roughly concurrent readers
        are allowed but no writer is allowed.</p></li><li><p><code class="literal">PESSIMISTIC_WRITE</code>: apply a database-level
        write lock when the lock operation is requested: roughly no reader nor
        writer is allowed.</p></li></ul></div><p>All these locks prevent dirty reads and non-repeatable reads on a
    given entity. Optimistic locks enforce the lock as late as possible hoping
    nobody changes the data underneath while pessimistic locks enforce the
    lock right away and keep it till the transaction is committed.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1709"/>3.13. Caching</h2></div></div></div><p>When the second-level cache is activated (see <a href="#setup-configuration-packaging" title="2.2.1. Packaging">Section 2.2.1, “Packaging”</a> and the Hibernate Annotations
    reference documentation), Hibernate ensures it is used and properly
    updated. You can however adjust these settings by passing two
    properties:</p><div class="itemizedlist"><ul><li><p><code class="literal">javax.persistence.cache.retrieveMode</code> which
        accepts <code class="literal"><code class="classname">CacheRetrieveMode</code></code>
        values</p></li><li><p><code class="literal">javax.persistence.cache.storeMode</code> which
        accepts <code class="classname">CacheStoreMode</code> values</p></li></ul></div><p><code class="classname">CacheRetrieveMode</code> controls how Hibernate
    accesses information from the second-level cache: <code class="literal">USE</code>
    which is the default or <code class="literal">BYPASS</code> which means ignore the
    cache. <code class="classname">CacheStoreMode</code> controls how Hibernate pushes
    information to the second-level cache: <code class="literal">USE</code> which is the
    default and push data in the cache when reading from and writing to the
    database, <code class="literal">BYPASS</code> which does not insert new data in the
    cache (but can invalidate obsolete data) and
    <code class="classname">REFRESH</code> which does like default but also force data
    to be pushed to the cache on database read even if the data is already
    cached.</p><p>You can set these properties:</p><div class="itemizedlist"><ul><li><p>on a particular <code class="classname">EntityManager</code> via the
        <code class="methodname">setProperty</code> method</p></li><li><p>on a query via a query hint (<code class="methodname">setHint</code>
        method)</p></li><li><p>when calling <code class="methodname">find()</code> and
        <code class="methodname">refresh()</code> and passing the properties in the
        appropriate <code class="classname">Map</code></p></li></ul></div><p>JPA also introduces an API to interrogate the second-level cache and
    evict data manually.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Cache</span><!-- <br/> --><span class="java_plain">&nbsp;cache&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManagerFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getCache</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;cache</span><span class="java_separator">.</span><span class="java_plain">contains</span><span class="java_separator">(</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;userId</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">load&nbsp;it&nbsp;as&nbsp;we&nbsp;don't&nbsp;hit&nbsp;the&nbsp;DB</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">cache</span><span class="java_separator">.</span><span class="java_plain">evict</span><span class="java_separator">(</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;userId</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">manually&nbsp;evict&nbsp;user&nbsp;form&nbsp;the&nbsp;second</span><span class="java_operator">-</span><span class="java_plain">level&nbsp;cache</span>
<!--  --><br/><span class="java_plain">cache</span><span class="java_separator">.</span><span class="java_plain">evict</span><span class="java_separator">(</span><span class="java_type">User</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">evict&nbsp;all&nbsp;users&nbsp;from&nbsp;the&nbsp;second</span><span class="java_operator">-</span><span class="java_plain">level&nbsp;cache</span>
<!--  --><br/><span class="java_plain">cache</span><span class="java_separator">.</span><span class="java_plain">evictAll</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">purge&nbsp;the&nbsp;second</span><span class="java_operator">-</span><span class="java_plain">level&nbsp;cache&nbsp;entirely</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1789"/>3.14. Checking the state of an object</h2></div></div></div><p>You can check whether an object is managed by the persistence
    context</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">entityManager</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Cat</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;catId</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span>
<!--  --><br/><span class="java_type">boolean</span><span class="java_plain">&nbsp;isIn&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">contains</span><span class="java_separator">(</span><span class="java_plain">cat</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_keyword">assert</span><span class="java_plain">&nbsp;isIn</span><span class="java_separator">;</span></pre><p>You can also check whether an object, an association or a property
    is lazy or not. You can do that independently of the underlying
    persistence provider: </p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">PersistenceUtil</span><!-- <br/> --><span class="java_plain">&nbsp;jpaUtil&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Persistence</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getPersistenceUtil</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">getAddress</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;address&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">getOrders&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;orders&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;detailedBio&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;property&nbsp;detailedBio&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>However, if you have access to the entityManagerFactory, we
    recommend you to use:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">PersistenceUnitUtil</span><!-- <br/> --><span class="java_plain">&nbsp;jpaUtil&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getEntityManagerFactory</span><!-- <br/> --><span class="java_separator">().</span><!-- <br/> --><span class="java_plain">getPersistenceUnitUtil</span><!-- <br/> --><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">Customer</span><span class="java_plain">&nbsp;customer&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Customer</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">,</span><span class="java_plain">&nbsp;customerId&nbsp;</span><span class="java_separator">);</span>
</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">getAddress</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;address&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">&nbsp;customer</span><span class="java_separator">.</span><span class="java_plain">getOrders&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;orders&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">jpaUtil</span><span class="java_separator">.</span><span class="java_plain">isLoaded</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;detailedBio&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">display&nbsp;property&nbsp;detailedBio&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;loaded</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_plain">log</span><span class="java_separator">.</span><span class="java_plain">debug</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Customer&nbsp;id&nbsp;{}&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;jpaUtil</span><span class="java_separator">.</span><span class="java_plain">getIdentifier</span><span class="java_separator">(</span><span class="java_plain">customer</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre><p>The performances are likely to be slightly better and you can get
    the identifier value from an object (using
    <code class="methodname">getIdentifier()</code>).</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>These are roughly the counterpart methods of
      <code class="methodname">Hibernate.isInitialize</code>.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1815"/>3.15. Native Hibernate API</h2></div></div></div><p>You can always fall back to the underlying
    <code class="classname">Session</code> API from a given
    <code class="classname">EntityManager</code>:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_plain">&nbsp;session&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">unwrap</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Session</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_separator">);</span></pre></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="metamodel"/>Chapter 4. Metamodel</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#metamodel-static">4.1. Static metamodel</a></span></dt></dl></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>
            The Metamodel itself is described in <em class="citetitle">Chapter 5 Metamodel API</em>
            of the [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a></span>].  <em class="citetitle">Chapter 6 Criteria API</em>
            of the [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a></span>] describes and shows uses of the metamodel in criteria
            queries, as does <a href="#querycriteria" title="Chapter 9. Criteria Queries">Chapter 9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Criteria Queries</i></a>.
        </p></div><p>
        The metamodel is a set of objects that describe your domain model.
        <code class="interfacename">javax.persistence.metamodel.Metamodel</code> acts as a repository of these metamodel
        objects and provides access to them, and can be obtained from either the
        <code class="interfacename">javax.persistence.EntityManagerFactory</code> or the
        <code class="interfacename">javax.persistence.EntityManager</code> via their
        <code class="methodname">getMetamodel</code> method.
    </p><p>
        This metamodel is important in 2 ways.  First, it allows providers and frameworks a generic way to
        deal with an application's domain model.  Persistence providers will already have some form of
        metamodel that they use to describe the domain model being mapped.  This API however defines a single,
        independent access to that existing information.  A validation framework, for example, could use this
        information to understand associations; a marshaling framework might use this information to decide how
        much of an entity graph to marshal.  This usage is beyond the scope of this documentation.
    </p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>
            As of today the JPA 2 metamodel does not provide any facility for accessing relational information
            pertaining to the physical model.  It is expected this will be addressed in a future release of the
            specification.
        </p></div><p>
        Second, from an application writer's perspective, it allows very fluent expression of completely type-safe
        criteria queries, especially the <span class="emphasis"><em>Static Metamodel</em></span> approach.  The
        [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a></span>] defines a number of ways the metamodel can be accessed and used,
        including the <span class="emphasis"><em>Static Metamodel</em></span> approach, which we will look at later.
        The <span class="emphasis"><em>Static Metamodel</em></span> approach is wonderful when the code has
        <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/A_priori_and_a_posteriori">a priori knowledge</a> of the domain
        model.  <a href="#querycriteria" title="Chapter 9. Criteria Queries">Chapter 9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Criteria Queries</i></a> uses this approach exclusively in its examples.
    </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="metamodel-static"/>4.1. Static metamodel</h2></div></div></div><p>
            A <span class="emphasis"><em>static metamodel</em></span> is a series of classes that "mirror" the entities and embeddables
            in the domain model and provide static access to the metadata about the mirrored class's attributes.  We
            will exclusively discuss what the [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a></span>] terms a
            <span class="emphasis"><em>Canonical Metamodel</em></span>:
        </p><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
                </p><div class="itemizedlist"><ul><li><p>
                            For each managed class <code class="classname">X</code> in package <span class="package">p</span>,
                            a metamodel class <code class="classname">X_</code> in package <span class="package">p</span> is created.
                        </p></li><li><p>
                            The name of the metamodel class is derived from the name of the managed class by appending
                           "_" to the name of the managed class.
                        </p></li><li><p>
                            The metamodel class <code class="classname">X_</code> must be annotated with the
                            <code class="interfacename">javax.persistence.StaticMetamodel</code>annotation
                            <sup>[<a id="d0e1938" href="#ftn.d0e1938">1</a>]</sup>
                        </p></li><li><p>
                            If class <code class="classname">X</code> extends another class <code class="classname">S</code>, where
                            <code class="classname">S</code> is the most derived managed class (i.e., entity or mapped
                            superclass) extended by <code class="classname">X</code>, then class <code class="classname">X_</code> must
                            extend class <code class="classname">S_</code>, where <code class="classname">S_</code> is the metamodel
                            class created for <code class="classname">S</code>.
                        </p></li><li><p>
                            For every persistent non-collection-valued attribute <span class="emphasis"><em>y</em></span> declared by
                            class <code class="classname">X</code>, where the type of <span class="emphasis"><em>y</em></span> is
                            <code class="classname">Y</code>, the metamodel class must contain a declaration as follows:
                            </p><pre class="programlisting">public static volatile SingularAttribute&lt;X, Y&gt; y;</pre><p>
                        </p></li><li><p>
                            For every persistent collection-valued attribute <span class="emphasis"><em>z</em></span> declared by class
                            <code class="classname">X</code>, where the element type of <span class="emphasis"><em>z</em></span> is
                            <code class="classname">Z</code>, the metamodel class must contain a declaration as follows:
                            </p><div class="itemizedlist"><ul><li><p>
                                        if the collection type of <span class="emphasis"><em>z</em></span> is
                                        <code class="interfacename">java.util.Collection</code>, then
                                        </p><pre class="programlisting">public static volatile CollectionAttribute&lt;X, Z&gt; z;</pre><p>
                                    </p></li><li><p>
                                        if the collection type of <span class="emphasis"><em>z</em></span> is
                                        <code class="interfacename">java.util.Set</code>, then
                                        </p><pre class="programlisting">public static volatile SetAttribute&lt;X, Z&gt; z;</pre><p>
                                    </p></li><li><p>
                                        if the collection type of <span class="emphasis"><em>z</em></span> is
                                        <code class="interfacename">java.util.List</code>, then
                                        </p><pre class="programlisting">public static volatile ListAttribute&lt;X, Z&gt; z;</pre><p>
                                    </p></li><li><p>
                                        if the collection type of <span class="emphasis"><em>z</em></span> is
                                        <code class="interfacename">java.util.Map</code>, then
                                        </p><pre class="programlisting">public static volatile MapAttribute&lt;X, K, Z&gt; z;</pre><p>
                                        where <code class="classname">K</code> is the type of the key of the map in class
                                        <code class="classname">X</code>
                                    </p></li></ul></div><p>
                        </p></li></ul></div><p>
            </p><p>
                Import statements must be included for the needed <span class="package">javax.persistence.metamodel</span> types
                as appropriate (e.g., <code class="interfacename">javax.persistence.metamodel.SingularAttribute</code>,
                <code class="interfacename">javax.persistence.metamodel.CollectionAttribute</code>,
                <code class="interfacename">javax.persistence.metamodel.SetAttribute</code>,
                <code class="interfacename">javax.persistence.metamodel.ListAttribute</code>,
                <code class="interfacename">javax.persistence.metamodel.MapAttribute</code>) and all classes
                <code class="classname">X</code>, <code class="classname">Y</code>, <code class="classname">Z</code>, and <code class="classname">K</code>.
            </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">
                [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a>, section 6.2.1.1, pp 198-199</span>]
            </span></td></tr></table></div><div class="example"><a id="metamodel-static-ex"/><p class="title"><b>Example 4.1. Static metamodel example</b></p><div class="example-contents"><p>
                For the <code class="classname">Person</code> entity
                </p><pre class="programlisting">package org.hibernate.jpa2.metamodel.example;

import java.util.Set;
import javax.persistence.Entity;

@Entity
public class Person {
    @Id private Long id;
    private String name;
    private int age;
    private Address address;
    @OneToMany  private Set&lt;Order&gt; orders;
}</pre><p>
                The corresponding canonical metamodel class, <code class="classname">Person_</code> would look like
                </p><pre class="programlisting">package org.hibernate.jpa2.metamodel.example;

import javax.persistence.metamodel.SingularAttribute;
import javax.persistence.metamodel.SetAttribute;
import javax.persistence.metamodel.StaticMetamodel;

@StaticMetamodel( Person.class )
public class Person_ {
    public static volatile SingularAttribute&lt;Person, Long&gt; id;
    public static volatile SingularAttribute&lt;Person, String&gt; name;
    public static volatile SingularAttribute&lt;Person, Integer&gt; age;
    public static volatile SingularAttribute&lt;Person, Address&gt; address;
    public static volatile SetAttribute&lt;Person, Order&gt; orders;
}</pre><p>
            </p></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>
                These canonical metamodel classes can be generated manually if you wish though it is expected
                that most developers will prefer use of an <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/javase/6/docs/technotes/tools/solaris/javac.html#processing">annotation processor</a>.
                Annotation processors themselves are beyond the scope of this document.  However, the Hibernate team
                does develop an annotation processor tool for generating a canonical metamodel.
                See <em class="citetitle">Hibernate Metamodel Generator</em>.
            </p></div><p>
            When the Hibernate <code class="interfacename">EntityManagerFactory</code> is being built, it will
            look for a canonical metamodel class for each of the managed typed is knows about and if it finds
            any it will inject the appropriate metamodel information into them, as outlined in
            [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a>, section 6.2.2, pg 200</span>]
        </p></div><div xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="footnotes"><br/><hr/><div xmlns="http://www.w3.org/1999/xhtml" class="footnote"><p><sup>[<a id="ftn.d0e1938" href="#d0e1938">1</a>] </sup>
                                    <span class="emphasis"><em>(from the original)</em></span> If the class was generated, the
                                    <code class="interfacename">javax.annotation.Generated</code> annotation should be
                                    used to annotate the class. The use of any other annotations on static metamodel
                                    classes is undefined.
                                </p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="transactions"/>Chapter 5. Transactions and Concurrency</h2></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="#transactions-basics">5.1. Entity manager and transaction scopes</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-basics-uow">5.1.1. Unit of work</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-apptx">5.1.2. Long units of work</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-identity">5.1.3. Considering object identity</a></span></dt><dt><span class="sect2"><a href="#transactions-basics-issues">5.1.4. Common concurrency control issues</a></span></dt></dl></dd><dt><span class="sect1"><a href="#transactions-demarcation">5.2. Database transaction demarcation</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-demarcation-nonmanaged">5.2.1. Non-managed environment</a></span></dt><dt><span class="sect2"><a href="#transactions-demarcation-jta">5.2.2. Using JTA</a></span></dt><dt><span class="sect2"><a href="#transactions-demarcation-exceptions">5.2.3. Exception handling</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d0e2798">5.3. EXTENDED Persistence Context</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d0e2839">5.3.1. Container Managed Entity Manager</a></span></dt><dt><span class="sect2"><a href="#d0e2857">5.3.2. Application Managed Entity Manager</a></span></dt></dl></dd><dt><span class="sect1"><a href="#transactions-optimistic">5.4. Optimistic concurrency control</a></span></dt><dd><dl><dt><span class="sect2"><a href="#transactions-optimistic-manual">5.4.1. Application version checking</a></span></dt><dt><span class="sect2"><a href="#transactions-optimistic-longsession">5.4.2. Extended entity manager and automatic versioning</a></span></dt><dt><span class="sect2"><a href="#transactions-optimistic-detached">5.4.3. Detached objects and automatic versioning</a></span></dt></dl></dd></dl></div><p>The most important point about Hibernate Entity Manager and
  concurrency control is that it is very easy to understand. Hibernate Entity
  Manager directly uses JDBC connections and JTA resources without adding any
  additional locking behavior. We highly recommend you spend some time with
  the JDBC, ANSI, and transaction isolation specification of your database
  management system. Hibernate Entity Manager only adds automatic versioning
  but does not lock objects in memory or change the isolation level of your
  database transactions. Basically, use Hibernate Entity Manager like you
  would use direct JDBC (or JTA/CMT) with your database resources.</p><p>We start the discussion of concurrency control in Hibernate with the
  granularity of <code class="literal">EntityManagerFactory</code>, and
  <code class="literal">EntityManager</code>, as well as database transactions and long
  units of work..</p><p>In this chapter, and unless explicitly expressed, we will mix and
  match the concept of entity manager and persistence context. One is an API
  and programming object, the other a definition of scope. However, keep in
  mind the essential difference. A persistence context is usually bound to a
  JTA transaction in Java EE, and a persistence context starts and ends at
  transaction boundaries (transaction-scoped) unless you use an extended
  entity manager. Please refer to <a href="#architecture-ejb-persistctxscope" title="1.2.3. Persistence context scope">Section 1.2.3, “Persistence context scope”</a> for more information.</p><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-basics"/>5.1. Entity manager and transaction scopes</h2></div></div></div><p>A <code class="literal">EntityManagerFactory</code> is an expensive-to-create,
    threadsafe object intended to be shared by all application threads. It is
    created once, usually on application startup.</p><p>An <code class="literal">EntityManager</code> is an inexpensive,
    non-threadsafe object that should be used once, for a single business
    process, a single unit of work, and then discarded. An
    <code class="literal">EntityManager</code> will not obtain a JDBC
    <code class="literal">Connection</code> (or a <code class="literal">Datasource</code>) unless
    it is needed, so you may safely open and close an
    <code class="literal">EntityManager</code> even if you are not sure that data access
    will be needed to serve a particular request. (This becomes important as
    soon as you are implementing some of the following patterns using request
    interception.)</p><p>To complete this picture you also have to think about database
    transactions. A database transaction has to be as short as possible, to
    reduce lock contention in the database. Long database transactions will
    prevent your application from scaling to highly concurrent load.</p><p>What is the scope of a unit of work? Can a single Hibernate
    <code class="literal">EntityManager</code> span several database transactions or is
    this a one-to-one relationship of scopes? When should you open and close a
    <code class="literal">Session</code> and how do you demarcate the database
    transaction boundaries?</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-basics-uow"/>5.1.1. Unit of work</h3></div></div></div><p>First, don't use the
      <span class="emphasis"><em>entitymanager-per-operation</em></span> antipattern, that is,
      don't open and close an <code class="literal">EntityManager</code> for every
      simple database call in a single thread! Of course, the same is true for
      database transactions. Database calls in an application are made using a
      planned sequence, they are grouped into atomic units of work. (Note that
      this also means that auto-commit after every single SQL statement is
      useless in an application, this mode is intended for ad-hoc SQL console
      work.)</p><p>The most common pattern in a multi-user client/server application
      is <span class="emphasis"><em>entitymanager-per-request</em></span>. In this model, a
      request from the client is send to the server (where the JPA persistence
      layer runs), a new <code class="literal">EntityManager</code> is opened, and all
      database operations are executed in this unit of work. Once the work has
      been completed (and the response for the client has been prepared), the
      persistence context is flushed and closed, as well as the entity manager
      object. You would also use a single database transaction to serve the
      clients request. The relationship between the two is one-to-one and this
      model is a perfect fit for many applications.</p><p>This is the default JPA persistence model in a Java EE environment
      (JTA bounded, transaction-scoped persistence context); injected (or
      looked up) entity managers share the same persistence context for a
      particular JTA transaction. The beauty of JPA is that you don't have to
      care about that anymore and just see data access through entity manager
      and demarcation of transaction scope on session beans as completely
      orthogonal.</p><p>The challenge is the implementation of this (and other) behavior
      outside an EJB3 container: not only has the
      <code class="literal">EntityManager</code> and resource-local transaction to be
      started and ended correctly, but they also have to be accessible for
      data access operations. The demarcation of a unit of work is ideally
      implemented using an interceptor that runs when a request hits the
      non-EJB3 container server and before the response will be send (i.e. a
      <code class="literal">ServletFilter</code> if you are using a standalone servlet
      container). We recommend to bind the <code class="literal">EntityManager</code> to
      the thread that serves the request, using a
      <code class="literal">ThreadLocal</code> variable. This allows easy access (like
      accessing a static variable) in all code that runs in this thread.
      Depending on the database transaction demarcation mechanism you chose,
      you might also keep the transaction context in a
      <code class="literal">ThreadLocal</code> variable. The implementation patterns for
      this are known as <span class="emphasis"><em>ThreadLocal Session</em></span> and
      <span class="emphasis"><em>Open Session in View</em></span> in the Hibernate community.
      You can easily extend the <code class="literal">HibernateUtil</code> shown in the
      Hibernate reference documentation to implement this pattern, you don't
      need any external software (it's in fact very trivial). Of course, you'd
      have to find a way to implement an interceptor and set it up in your
      environment. See the Hibernate website for tips and examples. Once
      again, remember that your first choice is naturally an EJB3 container -
      preferably a light and modular one such as JBoss application
      server.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-basics-apptx"/>5.1.2. Long units of work</h3></div></div></div><p>The entitymanager-per-request pattern is not the only useful
      concept you can use to design units of work. Many business processes
      require a whole series of interactions with the user interleaved with
      database accesses. In web and enterprise applications it is not
      acceptable for a database transaction to span a user interaction with
      possibly long waiting time between requests. Consider the following
      example:</p><div class="itemizedlist"><ul><li><p>The first screen of a dialog opens, the data seen by the user
          has been loaded in a particular <code class="literal">EntityManager</code> and
          resource-local transaction. The user is free to modify the detached
          objects.</p></li><li><p>The user clicks "Save" after 5 minutes and expects his
          modifications to be made persistent; he also expects that he was the
          only person editing this information and that no conflicting
          modification can occur.</p></li></ul></div><p>We call this unit of work, from the point of view of the user, a
      long running <span class="emphasis"><em>application transaction</em></span>. There are
      many ways how you can implement this in your application.</p><p>A first naive implementation might keep the
      <code class="literal">EntityManager</code> and database transaction open during
      user think time, with locks held in the database to prevent concurrent
      modification, and to guarantee isolation and atomicity. This is of
      course an anti-pattern, a pessimistic approach, since lock contention
      would not allow the application to scale with the number of concurrent
      users.</p><p>Clearly, we have to use several database transactions to implement
      the application transaction. In this case, maintaining isolation of
      business processes becomes the partial responsibility of the application
      tier. A single application transaction usually spans several database
      transactions. It will be atomic if only one of these database
      transactions (the last one) stores the updated data, all others simply
      read data (e.g. in a wizard-style dialog spanning several
      request/response cycles). This is easier to implement than it might
      sound, especially if you use JPA entity manager and persistence context
      features:</p><div class="itemizedlist"><ul><li><p><span class="emphasis"><em>Automatic Versioning</em></span> - An entity manager
          can do automatic optimistic concurrency control for you, it can
          automatically detect if a concurrent modification occurred during
          user think time (usually by comparing version numbers or timestamps
          when updating the data in the final resource-local
          transaction).</p></li><li><p><span class="emphasis"><em>Detached Entities</em></span> - If you decide to use
          the already discussed <span class="emphasis"><em>entity-per-request</em></span>
          pattern, all loaded instances will be in detached state during user
          think time. The entity manager allows you to merge the detached
          (modified) state and persist the modifications, the pattern is
          called
          <span class="emphasis"><em>entitymanager-per-request-with-detached-entities</em></span>.
          Automatic versioning is used to isolate concurrent
          modifications.</p></li><li><p><span class="emphasis"><em>Extended Entity Manager</em></span> - The Hibernate
          Entity Manager may be disconnected from the underlying JDBC
          connection between two client calls and reconnected when a new
          client request occurs. This pattern is known as
          <span class="emphasis"><em>entitymanager-per-application-transaction</em></span> and
          makes even merging unnecessary. An extend persistence context is
          responsible to collect and retain any modification (persist, merge,
          remove) made outside a transaction. The next client call made inside
          an active transaction (typically the last operation of a user
          conversation) will execute all queued modifications. Automatic
          versioning is used to isolate concurrent modifications.</p></li></ul></div><p>Both
      <span class="emphasis"><em>entitymanager-per-request-with-detached-objects</em></span> and
      <span class="emphasis"><em>entitymanager-per-application-transaction</em></span> have
      advantages and disadvantages, we discuss them later in this chapter in
      the context of optimistic concurrency control.</p><p>TODO: This note should probably come later.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-basics-identity"/>5.1.3. Considering object identity</h3></div></div></div><p>An application may concurrently access the same persistent state
      in two different persistence contexts. However, an instance of a managed
      class is never shared between two persistence contexts. Hence there are
      two different notions of identity:</p><div class="variablelist"><dl><dt><span class="term">Database Identity</span></dt><dd><p><code class="literal">foo.getId().equals( bar.getId() )</code></p></dd><dt><span class="term">JVM Identity</span></dt><dd><p><code class="literal">foo==bar</code></p></dd></dl></div><p>Then for objects attached to a <span class="emphasis"><em>particular</em></span>
      persistence context (i.e. in the scope of an
      <code class="literal">EntityManager</code>) the two notions are equivalent, and
      JVM identity for database identity is guaranteed by the Hibernate Entity
      Manager. However, while the application might concurrently access the
      "same" (persistent identity) business object in two different
      persistence contexts, the two instances will actually be "different"
      (JVM identity). Conflicts are resolved using (automatic versioning) at
      flush/commit time, using an optimistic approach.</p><p>This approach leaves Hibernate and the database to worry about
      concurrency; it also provides the best scalability, since guaranteeing
      identity in single-threaded units of work only doesn't need expensive
      locking or other means of synchronization. The application never needs
      to synchronize on any business object, as long as it sticks to a single
      thread per <code class="literal">EntityManager</code>. Within a persistence
      context, the application may safely use <code class="literal">==</code> to compare
      entities.</p><p>However, an application that uses <code class="literal">==</code> outside of
      a persistence context might see unexpected results. This might occur
      even in some unexpected places, for example, if you put two detached
      instances into the same <code class="literal">Set</code>. Both might have the same
      database identity (i.e. they represent the same row), but JVM identity
      is by definition not guaranteed for instances in detached state. The
      developer has to override the <code class="literal">equals()</code> and
      <code class="literal">hashCode()</code> methods in persistent classes and
      implement his own notion of object equality. There is one caveat: Never
      use the database identifier to implement equality, use a business key, a
      combination of unique, usually immutable, attributes. The database
      identifier will change if a transient entity is made persistent (see the
      contract of the <code class="literal">persist()</code> operation). If the
      transient instance (usually together with detached instances) is held in
      a <code class="literal">Set</code>, changing the hashcode breaks the contract of
      the <code class="literal">Set</code>. Attributes for good business keys don't have
      to be as stable as database primary keys, you only have to guarantee
      stability as long as the objects are in the same <code class="literal">Set</code>.
      See the Hibernate website for a more thorough discussion of this issue.
      Also note that this is not a Hibernate issue, but simply how Java object
      identity and equality has to be implemented.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-basics-issues"/>5.1.4. Common concurrency control issues</h3></div></div></div><p>Never use the anti-patterns
      <span class="emphasis"><em>entitymanager-per-user-session</em></span> or
      <span class="emphasis"><em>entitymanager-per-application</em></span> (of course, there are
      rare exceptions to this rule, e.g. entitymanager-per-application might
      be acceptable in a desktop application, with manual flushing of the
      persistence context). Note that some of the following issues might also
      appear with the recommended patterns, make sure you understand the
      implications before making a design decision:</p><div class="itemizedlist"><ul><li><p>An entity manager is not thread-safe. Things which are
          supposed to work concurrently, like HTTP requests, session beans, or
          Swing workers, will cause race conditions if an
          <code class="literal">EntityManager</code> instance would be shared. If you
          keep your Hibernate <code class="literal">EntityManager</code> in your
          <code class="literal">HttpSession</code> (discussed later), you should
          consider synchronizing access to your Http session. Otherwise, a
          user that clicks reload fast enough may use the same
          <code class="literal">EntityManager</code> in two concurrently running
          threads. You will very likely have provisions for this case already
          in place, for other non-threadsafe but session-scoped
          objects.</p></li><li><p>An exception thrown by the Entity Manager means you have to
          rollback your database transaction and close the
          <code class="literal">EntityManager</code> immediately (discussed later in
          more detail). If your <code class="literal">EntityManager</code> is bound to
          the application, you have to stop the application. Rolling back the
          database transaction doesn't put your business objects back into the
          state they were at the start of the transaction. This means the
          database state and the business objects do get out of sync. Usually
          this is not a problem, because exceptions are not recoverable and
          you have to start over your unit of work after rollback
          anyway.</p></li><li><p>The persistence context caches every object that is in managed
          state (watched and checked for dirty state by Hibernate). This means
          it grows endlessly until you get an
          <code class="classname">OutOfMemoryException</code>, if you keep it open for
          a long time or simply load too much data. One solution for this is
          some kind batch processing with regular flushing of the persistence
          context, but you should consider using a database stored procedure
          if you need mass data operations. Some solutions for this problem
          are shown in <a href="#batch" title="Chapter 7. Batch processing">Chapter 7, <i xmlns:xlink="http://www.w3.org/1999/xlink">Batch processing</i></a>. Keeping a persistence context
          open for the duration of a user session also means a high
          probability of stale data, which you have to know about and control
          appropriately.</p></li></ul></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-demarcation"/>5.2. Database transaction demarcation</h2></div></div></div><p>Database (or system) transaction boundaries are always necessary. No
    communication with the database can occur outside of a database
    transaction (this seems to confuse many developers who are used to the
    auto-commit mode). Always use clear transaction boundaries, even for
    read-only operations. Depending on your isolation level and database
    capabilities this might not be required but there is no downside if you
    always demarcate transactions explicitly. You'll have to do operations
    outside a transaction, though, when you'll need to retain modifications in
    an <code class="literal">EXTENDED</code> persistence context.</p><p>A JPA application can run in non-managed (i.e. standalone, simple
    Web- or Swing applications) and managed Java EE environments. In a
    non-managed environment, an <code class="literal">EntityManagerFactory</code> is
    usually responsible for its own database connection pool. The application
    developer has to manually set transaction boundaries, in other words,
    begin, commit, or rollback database transactions itself. A managed
    environment usually provides container-managed transactions, with the
    transaction assembly defined declaratively through annotations of EJB
    session beans, for example. Programmatic transaction demarcation is then
    no longer necessary, even flushing the <code class="literal">EntityManager</code> is
    done automatically.</p><p>Usually, ending a unit of work involves four distinct phases:</p><div class="itemizedlist"><ul compact="compact"><li><p>commit the (resource-local or JTA) transaction (this
        automatically flushes the entity manager and persistence
        context)</p></li><li><p>close the entity manager (if using an application-managed entity
        manager)</p></li><li><p>handle exceptions</p></li></ul></div><p>We'll now have a closer look at transaction demarcation and
    exception handling in both managed- and non-managed environments.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-demarcation-nonmanaged"/>5.2.1. Non-managed environment</h3></div></div></div><p>If an JPA persistence layer runs in a non-managed environment,
      database connections are usually handled by Hibernate's pooling
      mechanism behind the scenes. The common entity manager and transaction
      handling idiom looks like this:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Non</span><!-- <br/> --><span class="java_operator">-</span><!-- <br/> --><span class="java_plain">managed&nbsp;environment&nbsp;idiom</span>
<!--  --><br/><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;emf</span><span class="java_separator">.</span><span class="java_plain">createEntityManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">EntityTransaction</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_keyword">try</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;tx&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;tx</span><span class="java_separator">.</span><span class="java_plain">begin</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;some&nbsp;work</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;tx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">RuntimeException</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;tx&nbsp;</span><span class="java_operator">!=</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_plain">&nbsp;</span><span class="java_operator">&amp;&amp;</span><span class="java_plain">&nbsp;tx</span><span class="java_separator">.</span><span class="java_plain">isActive</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;tx</span><span class="java_separator">.</span><span class="java_plain">rollback</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;e</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;or&nbsp;display&nbsp;error&nbsp;message</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">finally</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>You don't have to <code class="literal">flush()</code> the
      <code class="literal">EntityManager</code> explicitly - the call to
      <code class="literal">commit()</code> automatically triggers the
      synchronization.</p><p>A call to <code class="literal">close()</code> marks the end of an
      <code class="literal">EntityManager</code>. The main implication of
      <code class="literal">close()</code> is the release of resources - make sure you
      always close and never outside of guaranteed finally block.</p><p>You will very likely never see this idiom in business code in a
      normal application; fatal (system) exceptions should always be caught at
      the "top". In other words, the code that executes entity manager calls
      (in the persistence layer) and the code that handles
      <code class="literal">RuntimeException</code> (and usually can only clean up and
      exit) are in different layers. This can be a challenge to design
      yourself and you should use J2EE/EJB container services whenever they
      are available. Exception handling is discussed later in this
      chapter.</p><div class="sect3" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2464"/>5.2.1.1. EntityTransaction</h4></div></div></div><p>In a JTA environment, you don't need any extra API to interact
        with the transaction in your environment. Simply use transaction
        declaration or the JTA APIs.</p><p>If you are using a <code class="literal">RESOURCE_LOCAL</code> entity
        manager, you need to demarcate your transaction boundaries through the
        <code class="literal">EntityTransaction</code> API. You can get an
        <code class="literal">EntityTransaction</code> through
        <code class="literal">entityManager.getTransaction()</code>. This
        <code class="literal">EntityTransaction</code> API provides the regular
        <code class="methodname">begin()</code>, <code class="methodname">commit()</code>,
        <code class="methodname">rollback()</code> and
        <code class="methodname">isActive()</code> methods. It also provide a way to
        mark a transaction as rollback only, ie force the transaction to
        rollback. This is very similar to the JTA operation
        <code class="methodname">setRollbackOnly()</code>. When a
        <code class="literal">commit()</code> operation fail and/or if the transaction
        is marked as <code class="literal">setRollbackOnly()</code>, the
        <code class="literal">commit()</code> method will try to rollback the
        transaction and raise a
        <code class="literal">javax.transaction.RollbackException</code>.</p><p>In a <code class="literal">JTA</code> entity manager,
        <code class="literal">entityManager.getTransaction()</code> calls are not
        permitted.</p></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-demarcation-jta"/>5.2.2. Using JTA</h3></div></div></div><p>If your persistence layer runs in an application server (e.g.
      behind EJB3 session beans), every datasource connection obtained
      internally by the entity manager will automatically be part of the
      global JTA transaction. Hibernate offers two strategies for this
      integration.</p><p>If you use bean-managed transactions (BMT), the code will look
      like this:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;BMT&nbsp;idiom</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Resource</span><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">UserTransaction</span><span class="java_plain">&nbsp;utx</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">Resource</span><span class="java_plain">&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">EntityManagerFactory</span><span class="java_plain">&nbsp;factory</span><span class="java_separator">;</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;doBusiness</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;factory</span><span class="java_separator">.</span><span class="java_plain">createEntityManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">try</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">do</span><span class="java_plain">&nbsp;some&nbsp;work</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">...</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;utx</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">catch</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">RuntimeException</span><span class="java_plain">&nbsp;e</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">utx&nbsp;</span><span class="java_operator">!=</span><span class="java_plain">&nbsp;</span><span class="java_literal">null</span><span class="java_separator">)</span><span class="java_plain">&nbsp;utx</span><span class="java_separator">.</span><span class="java_plain">rollback</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;e</span><span class="java_separator">;</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;or&nbsp;display&nbsp;error&nbsp;message</span>
<!--  --><br/><span class="java_separator">}</span>
<!--  --><br/><span class="java_keyword">finally</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>With Container Managed Transactions (CMT) in an EJB3 container,
      transaction demarcation is done in session bean annotations or
      deployment descriptors, not programatically. The
      <code class="literal">EntityManager</code> will automatically be flushed on
      transaction completion (and if you have injected or lookup the
      <code class="literal">EntityManager</code>, it will be also closed automatically).
      If an exception occurs during the <code class="literal">EntityManager</code> use,
      transaction rollback occurs automatically if you don't catch the
      exception. Since <code class="literal">EntityManager</code> exceptions are
      <code class="literal">RuntimeException</code>s they will rollback the transaction
      as per the EJB specification (system exception vs. application
      exception).</p><p>It is important to let Hibernate EntityManager define the
      <code class="literal">hibernate.transaction.factory_class</code> (ie not
      overriding this value). Remember to also set
      <code class="literal">org.hibernate.transaction.manager_lookup_class</code>.</p><p>If you work in a CMT environment, you might also want to use the
      same entity manager in different parts of your code. Typically, in a
      non-managed environment you would use a <code class="literal">ThreadLocal</code>
      variable to hold the entity manager, but a single EJB request might
      execute in different threads (e.g. session bean calling another session
      bean). The EJB3 container takes care of the persistence context
      propagation for you. Either using injection or lookup, the EJB3
      container will return an entity manager with the same persistence
      context bound to the JTA context if any, or create a new one and bind it
      (see <a href="#architecture-ejb-persistctxpropagation" title="1.2.4. Persistence context propagation">Section 1.2.4, “Persistence context propagation”</a> .)</p><p>Our entity manager/transaction management idiom for CMT and EJB3
      container-use is reduced to this:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">CMT&nbsp;idiom&nbsp;through&nbsp;injection</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">PersistenceContext</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;sample&quot;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_type">EntityManager</span><span class="java_plain">&nbsp;em</span><span class="java_separator">;</span></pre><p>Or this if you use Java Context and Dependency Injection
      (CDI).</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Inject</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">EntityManager</span><!-- <br/> --><span class="java_plain">&nbsp;em</span><!-- <br/> --><span class="java_separator">;</span></pre><p>In other words, all you have to do in a managed environment is to
      inject the <code class="literal">EntityManager</code>, do your data access work,
      and leave the rest to the container. Transaction boundaries are set
      declaratively in the annotations or deployment descriptors of your
      session beans. The lifecycle of the entity manager and persistence
      context is completely managed by the container.</p><p>Due to a silly limitation of the JTA spec, it is not possible for
      Hibernate to automatically clean up any unclosed
      <code class="literal">ScrollableResults</code> or <code class="literal">Iterator</code>
      instances returned by <code class="literal">scroll()</code> or
      <code class="literal">iterate()</code>. You <span class="emphasis"><em>must</em></span> release the
      underlying database cursor by calling
      <code class="literal">ScrollableResults.close()</code> or
      <code class="literal">Hibernate.close(Iterator)</code> explicitly from a
      <code class="literal">finally</code> block. (Of course, most applications can
      easily avoid using <code class="literal">scroll()</code> or
      <code class="literal">iterate()</code> at all from the CMT code.)</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-demarcation-exceptions"/>5.2.3. Exception handling</h3></div></div></div><p>If the <code class="literal">EntityManager</code> throws an exception
      (including any <code class="literal">SQLException</code>), you should immediately
      rollback the database transaction, call
      <code class="literal">EntityManager.close()</code> (if
      <code class="methodname">createEntityManager()</code> has been called) and
      discard the <code class="literal">EntityManager</code> instance. Certain methods
      of <code class="literal">EntityManager</code> will <span class="emphasis"><em>not</em></span> leave
      the persistence context in a consistent state. No exception thrown by an
      entity manager can be treated as recoverable. Ensure that the
      <code class="literal">EntityManager</code> will be closed by calling
      <code class="literal">close()</code> in a <code class="literal">finally</code> block. Note
      that a container managed entity manager will do that for you. You just
      have to let the RuntimeException propagate up to the container.</p><p>The Hibernate entity manager generally raises exceptions which
      encapsulate the Hibernate core exception. Common exceptions raised by
      the <code class="literal">EntityManager</code> API are</p><div class="itemizedlist"><ul><li><p><code class="classname">IllegalArgumentException</code>: something
          wrong happen</p></li><li><p><code class="classname">EntityNotFoundException</code>: an entity was
          expected but none match the requirement</p></li><li><p><code class="classname">NonUniqueResultException</code>: more than one
          entity is found when calling
          <code class="methodname">getSingleResult()</code></p></li><li><p>NoResultException: when
          <code class="methodname">getSingleResult()</code> does not find any
          matching entity</p></li><li><p><code class="classname">EntityExistsException</code>: an existing
          entity is passed to <code class="methodname">persist()</code></p></li><li><p><code class="classname">TransactionRequiredException</code>: this
          operation has to be in a transaction</p></li><li><p><code class="classname">IllegalStateException</code>: the entity
          manager is used in a wrong way</p></li><li><p><code class="classname">RollbackException</code>: a failure happens
          during <code class="methodname">commit()</code></p></li><li><p><code class="classname">QueryTimeoutException</code>: the query takes
          longer than the specified timeout (see
          <code class="literal">javax.persistence.query.timeout</code> - this property
          is a hint and might not be followed)</p></li><li><p><code class="classname">PessimisticLockException</code>: when a lock
          cannot be acquired</p></li><li><p><code class="classname">OptimisticLockException</code>: an optimistic
          lock is failing</p></li><li><p><code class="classname">LockTimeoutException</code>: when a lock takes
          longer than the expected time to be acquired
          (<code class="literal">javax.persistence.lock.timeout</code> in
          milliseconds)</p></li><li><p><code class="classname">TransactionRequiredException</code>: an
          operation requiring a transaction is executed outside of a
          transaction</p></li></ul></div><p>The <code class="literal">HibernateException</code>, which wraps most of the
      errors that can occur in a Hibernate persistence layer, is an unchecked
      exception. Note that Hibernate might also throw other unchecked
      exceptions which are not a <code class="literal">HibernateException</code>. These
      are, again, not recoverable and appropriate action should be
      taken.</p><p>Hibernate wraps <code class="literal">SQLException</code>s thrown while
      interacting with the database in a <code class="literal">JDBCException</code>. In
      fact, Hibernate will attempt to convert the exception into a more
      meaningful subclass of <code class="literal">JDBCException</code>. The underlying
      <code class="literal">SQLException</code> is always available via
      <code class="literal">JDBCException.getCause()</code>. Hibernate converts the
      <code class="literal">SQLException</code> into an appropriate
      <code class="literal">JDBCException</code> subclass using the
      <code class="literal">SQLExceptionConverter</code> attached to the
      <code class="literal">SessionFactory</code>. By default, the
      <code class="literal">SQLExceptionConverter</code> is defined by the configured
      dialect; however, it is also possible to plug in a custom implementation
      (see the javadocs for the
      <code class="literal">SQLExceptionConverterFactory</code> class for details). The
      standard <code class="literal">JDBCException</code> subtypes are:</p><div class="itemizedlist"><ul compact="compact"><li><p><code class="literal">JDBCConnectionException</code> - indicates an
          error with the underlying JDBC communication.</p></li><li><p><code class="literal">SQLGrammarException</code> - indicates a grammar
          or syntax problem with the issued SQL.</p></li><li><p><code class="literal">ConstraintViolationException</code> - indicates
          some form of integrity constraint violation.</p></li><li><p><code class="literal">LockAcquisitionException</code> - indicates an
          error acquiring a lock level necessary to perform the requested
          operation.</p></li><li><p><code class="literal">GenericJDBCException</code> - a generic exception
          which did not fall into any of the other categories.</p></li></ul></div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2798"/>5.3. EXTENDED Persistence Context</h2></div></div></div><p>All application managed entity manager and container managed
    persistence contexts defined as such are <code class="literal">EXTENDED</code>. This
    means that the persistence context type goes beyond the transaction life
    cycle. We should then understand what happens to operations made outside
    the scope of a transaction.</p><p>In an <code class="literal">EXTENDED</code> persistence context, all read only
    operations of the entity manager can be executed outside a transaction
    (<code class="literal">find()</code>, <code class="literal">getReference()</code>,
    <code class="literal">refresh()</code>, <code class="methodname">detach()</code> and read
    queries). Some modifications operations can be executed outside a
    transaction, but they are queued until the persistence context join a
    transaction: this is the case of <code class="literal">persist()</code>,
    <code class="literal"><code class="literal">merge()</code></code>,
    <code class="literal">remove()</code>. Some operations cannot be called outside a
    transaction: <code class="literal">flush()</code>, <code class="literal">lock()</code>, and
    update/delete queries.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2839"/>5.3.1. Container Managed Entity Manager</h3></div></div></div><p>When using an <code class="literal">EXTENDED</code> persistence context with
      a container managed entity manager, the lifecycle of the persistence
      context is binded to the lifecycle of the Stateful Session Bean. Plus if
      the entity manager is created outside a transaction, modifications
      operations (persist, merge, remove) are queued in the persistence
      context and not executed to the database.</p><p>When a method of the stateful session bean involved or starting a
      transaction is later called, the entity manager join the transaction.
      All queued operation will then be executed to synchronize the
      persistence context.</p><p>This is perfect to implement the
      <code class="literal">entitymanager-per-conversation</code> pattern. A stateful
      session bean represents the conversation implementation. All
      intermediate conversation work will be processed in methods not
      involving transaction. The end of the conversation will be processed
      inside a <code class="literal">JTA</code> transaction. Hence all queued operations
      will be executed to the database and committed. If you are interested in
      the notion of conversation inside your application, have a look at JBoss
      Seam. JBoss Seam emphasizes the concept of conversation and entity
      manager lifecycle and bind EJB3 and JSF together.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2857"/>5.3.2. Application Managed Entity Manager</h3></div></div></div><p>Application-managed entity manager are always
      <code class="literal">EXTENDED</code>. When you create an entity manager inside a
      transaction, the entity manager automatically join the current
      transaction. If the entity manager is created outside a transaction, the
      entity manager will queue the modification operations. When</p><div class="itemizedlist"><ul><li><p><code class="methodname">entityManager.joinTransaction()</code> is
          called when a JTA transaction is active for a <code class="literal">JTA</code>
          entity manager</p></li><li><p><code class="literal">entityManager.getTransaction().begin()</code> is
          called for a <code class="literal">RESOURCE_LOCAL</code> entity manager</p></li></ul></div><p>the entity manager join the transaction and all the queued
      operations will then be executed to synchronize the persistence
      context.</p><p>It is not legal to call
      <code class="methodname">entityManager.joinTransaction()</code> if no JTA
      transaction is involved.</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="transactions-optimistic"/>5.4. Optimistic concurrency control</h2></div></div></div><p>The only approach that is consistent with high concurrency and high
    scalability is optimistic concurrency control with versioning. Version
    checking uses version numbers, or timestamps, to detect conflicting
    updates (and to prevent lost updates). Hibernate provides for three
    possible approaches to writing application code that uses optimistic
    concurrency. The use cases we show are in the context of long application
    transactions but version checking also has the benefit of preventing lost
    updates in single database transactions.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-optimistic-manual"/>5.4.1. Application version checking</h3></div></div></div><p>In an implementation without much help from the persistence
      mechanism, each interaction with the database occurs in a new
      <code class="literal">EntityManager</code> and the developer is responsible for
      reloading all persistent instances from the database before manipulating
      them. This approach forces the application to carry out its own version
      checking to ensure application transaction isolation. This approach is
      the least efficient in terms of database access. It is the approach most
      similar to EJB2 entities:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;foo&nbsp;is&nbsp;an&nbsp;instance&nbsp;loaded&nbsp;by&nbsp;a&nbsp;previous&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_plain">em&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;factory</span><span class="java_separator">.</span><span class="java_plain">createEntityManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">EntityTransaction</span><span class="java_plain">&nbsp;t&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">t</span><span class="java_separator">.</span><span class="java_plain">begin</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;oldVersion&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;foo</span><span class="java_separator">.</span><span class="java_plain">getVersion</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Foo</span><span class="java_plain">&nbsp;dbFoo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;em</span><span class="java_separator">.</span><span class="java_plain">find</span><span class="java_separator">(</span><span class="java_plain">&nbsp;foo</span><span class="java_separator">.</span><span class="java_plain">getClass</span><span class="java_separator">(),</span><span class="java_plain">&nbsp;foo</span><span class="java_separator">.</span><span class="java_plain">getKey</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;load&nbsp;the&nbsp;current&nbsp;state</span>
<!--  --><br/><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;dbFoo</span><span class="java_separator">.</span><span class="java_plain">getVersion</span><span class="java_separator">()</span><span class="java_operator">!=</span><span class="java_plain">foo</span><span class="java_separator">.</span><span class="java_plain">getVersion&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_keyword">throw</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">StaleObjectStateException</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">dbFoo</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;bar&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">t</span><span class="java_separator">.</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre><p>The <code class="literal">version</code> property is mapped using
      <code class="literal">@Version</code>, and the entity manager will automatically
      increment it during flush if the entity is dirty.</p><p>Of course, if you are operating in a low-data-concurrency
      environment and don't require version checking, you may use this
      approach and just skip the version check. In that case, <span class="emphasis"><em>last
      commit wins</em></span> will be the default strategy for your long
      application transactions. Keep in mind that this might confuse the users
      of the application, as they might experience lost updates without error
      messages or a chance to merge conflicting changes.</p><p>Clearly, manual version checking is only feasible in very trivial
      circumstances and not practical for most applications. Often not only
      single instances, but complete graphs of modified objects have to be
      checked. Hibernate offers automatic version checking with either
      detached instances or an extended entity manager and persistence context
      as the design paradigm.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-optimistic-longsession"/>5.4.2. Extended entity manager and automatic versioning</h3></div></div></div><p>A single persistence context is used for the whole application
      transaction. The entity manager checks instance versions at flush time,
      throwing an exception if concurrent modification is detected. It's up to
      the developer to catch and handle this exception (common options are the
      opportunity for the user to merge his changes or to restart the business
      process with non-stale data).</p><p>In an <code class="literal">EXTENDED</code> persistence context, all
      operations made outside an active transaction are queued. The
      <code class="literal">EXTENDED</code> persistence context is flushed when executed
      in an active transaction (at worse at commit time).</p><p>The <code class="literal">Entity Manager</code> is disconnected from any
      underlying JDBC connection when waiting for user interaction. In an
      application-managed extended entity manager, this occurs automatically
      at transaction completion. In a stateful session bean holding a
      container-managed extended entity manager (i.e. a SFSB annotated with
      <code class="literal">@PersistenceContext(EXTENDED)</code>), this occurs
      transparently as well. This approach is the most efficient in terms of
      database access. The application need not concern itself with version
      checking or with merging detached instances, nor does it have to reload
      instances in every database transaction. For those who might be
      concerned by the number of connections opened and closed, remember that
      the connection provider should be a connection pool, so there is no
      performance impact. The following examples show the idiom in a
      non-managed environment:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;foo&nbsp;is&nbsp;an&nbsp;instance&nbsp;loaded&nbsp;earlier&nbsp;by&nbsp;the&nbsp;extended&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">.</span><span class="java_plain">begin</span><span class="java_separator">();</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;connection&nbsp;to&nbsp;data&nbsp;store&nbsp;is&nbsp;obtained&nbsp;and&nbsp;tx&nbsp;started</span>
<!--  --><br/><span class="java_plain">foo</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;bar&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">em</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">commit</span><span class="java_separator">();</span><span class="java_plain">&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">End</span><span class="java_plain">&nbsp;tx</span><span class="java_separator">,</span><span class="java_plain">&nbsp;flush&nbsp;and&nbsp;check&nbsp;version</span><span class="java_separator">,</span><span class="java_plain">&nbsp;disconnect</span></pre><p>The <code class="literal">foo</code> object still knows which
      <code class="literal">persistence context</code> it was loaded in. With
      <code class="literal">getTransaction.begin();</code> the entity manager obtains a
      new connection and resumes the persistence context. The method
      <code class="literal">getTransaction().commit()</code> will not only flush and
      check versions, but also disconnects the entity manager from the JDBC
      connection and return the connection to the pool.</p><p>This pattern is problematic if the persistence context is too big
      to be stored during user think time, and if you don't know where to
      store it. E.g. the <code class="literal">HttpSession</code> should be kept as
      small as possible. As the persistence context is also the (mandatory)
      first-level cache and contains all loaded objects, we can probably use
      this strategy only for a few request/response cycles. This is indeed
      recommended, as the persistence context will soon also have stale
      data.</p><p>It is up to you where you store the extended entity manager during
      requests, inside an EJB3 container you simply use a stateful session
      bean as described above. Don't transfer it to the web layer (or even
      serialize it to a separate tier) to store it in the
      <code class="literal">HttpSession</code>. In a non-managed, two-tiered environment
      the <code class="literal">HttpSession</code> might indeed be the right place to
      store it.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="transactions-optimistic-detached"/>5.4.3. Detached objects and automatic versioning</h3></div></div></div><p>With this paradigm, each interaction with the data store occurs in
      a new persistence context. However, the same persistent instances are
      reused for each interaction with the database. The application
      manipulates the state of detached instances originally loaded in another
      persistence context and then merges the changes using
      <code class="literal">EntityManager.merge()</code>:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">//</span><!-- <br/> --><span class="java_plain">&nbsp;foo&nbsp;is&nbsp;an&nbsp;instance&nbsp;loaded&nbsp;by&nbsp;a&nbsp;non</span><!-- <br/> --><span class="java_operator">-</span><!-- <br/> --><span class="java_plain">extended&nbsp;entity&nbsp;manager</span>
<!--  --><br/><span class="java_plain">foo</span><span class="java_separator">.</span><span class="java_plain">setProperty</span><span class="java_separator">(</span><span class="java_literal">&quot;bar&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">entityManager&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;factory</span><span class="java_separator">.</span><span class="java_plain">createEntityManager</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">begin</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">managedFoo&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;session</span><span class="java_separator">.</span><span class="java_plain">merge</span><span class="java_separator">(</span><span class="java_plain">foo</span><span class="java_separator">);</span><span class="java_plain">&nbsp;</span><span class="java_operator">//</span><span class="java_plain">&nbsp;discard&nbsp;foo&nbsp;and&nbsp;from&nbsp;now&nbsp;on&nbsp;use&nbsp;managedFoo</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre><p>Again, the entity manager will check instance versions during
      flush, throwing an exception if conflicting updates occurred.</p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="listeners"/>Chapter 6. Entity listeners and Callback methods</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e2985">6.1. Definition</a></span></dt><dt><span class="section"><a href="#d0e3069">6.2. Callbacks and listeners inheritance</a></span></dt><dt><span class="section"><a href="#d0e3102">6.3. XML definition</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2985"/>6.1. Definition</h2></div></div></div><p>It is often useful for the application to react to certain events
    that occur inside the persistence mechanism. This allows the
    implementation of certain kinds of generic functionality, and extension of
    built-in functionality. The JPA specification provides two related
    mechanisms for this purpose.</p><p>A method of the entity may be designated as a callback method to
    receive notification of a particular entity life cycle event. Callbacks
    methods are annotated by a callback annotation. You can also define an
    entity listener class to be used instead of the callback methods defined
    directly inside the entity class. An entity listener is a stateless class
    with a no-arg constructor. An entity listener is defined by annotating the
    entity class with the <code class="literal">@EntityListeners</code>
    annotation:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">Entity</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">EntityListeners</span><span class="java_separator">(</span><span class="java_keyword">class</span><span class="java_operator">=</span><span class="java_type">Audit</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Id</span><span class="java_plain">&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Integer</span><span class="java_plain">&nbsp;id</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">String</span><span class="java_plain">&nbsp;name</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Calendar</span><span class="java_plain">&nbsp;dateOfBirth</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">Transient</span><span class="java_plain">&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;age</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">private</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_plain">&nbsp;lastUpdate</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">//</span><span class="java_plain">getters&nbsp;and&nbsp;setters</span>
</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;my&nbsp;transient&nbsp;property&nbsp;at&nbsp;load&nbsp;time&nbsp;based&nbsp;on&nbsp;a&nbsp;calculation,</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;note&nbsp;that&nbsp;a&nbsp;native&nbsp;Hibernate&nbsp;formula&nbsp;mapping&nbsp;is&nbsp;better&nbsp;for&nbsp;this&nbsp;purpose.</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">PostLoad</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;calculateAge</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Calendar</span><span class="java_plain">&nbsp;birth&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">GregorianCalendar</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;birth</span><span class="java_separator">.</span><span class="java_plain">setTime</span><span class="java_separator">(</span><span class="java_plain">dateOfBirth</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">Calendar</span><span class="java_plain">&nbsp;now&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">GregorianCalendar</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;now</span><span class="java_separator">.</span><span class="java_plain">setTime</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_type">int</span><span class="java_plain">&nbsp;adjust&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">if</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_plain">&nbsp;now</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_type">Calendar</span><span class="java_separator">.</span><span class="java_plain">DAY_OF_YEAR</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;birth</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_type">Calendar</span><span class="java_separator">.</span><span class="java_plain">DAY_OF_YEAR</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">&lt;</span><span class="java_plain">&nbsp;</span><span class="java_literal">0</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjust&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_operator">-</span><span class="java_literal">1</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;age&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;now</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_type">Calendar</span><span class="java_separator">.</span><span class="java_plain">YEAR</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">-</span><span class="java_plain">&nbsp;birth</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_type">Calendar</span><span class="java_separator">.</span><span class="java_plain">YEAR</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;adjust</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span>
</span>
<!--  --><br/><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_type">LastUpdateListener</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_javadoc_comment">/**</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;automatic&nbsp;property&nbsp;set&nbsp;before&nbsp;any&nbsp;database&nbsp;persistence</span>
<!--  --><br/><span class="java_javadoc_comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">PreUpdate</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">PrePersist</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_keyword">public</span><span class="java_plain">&nbsp;</span><span class="java_type">void</span><span class="java_plain">&nbsp;setLastUpdate</span><span class="java_separator">(</span><span class="java_type">Cat</span><span class="java_plain">&nbsp;o</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o</span><span class="java_separator">.</span><span class="java_plain">setLastUpdate</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_keyword">new</span><span class="java_plain">&nbsp;</span><span class="java_type">Date</span><span class="java_separator">()</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">}</span></pre><p>The same callback method or entity listener method can be annotated
    with more than one callback annotation. For a given entity, you cannot
    have two methods being annotated by the same callback annotation whether
    it is a callback method or an entity listener method. A callback method is
    a no-arg method with no return type and any arbitrary name. An entity
    listener has the signature <code class="code">void &lt;METHOD&gt;(Object)</code> where
    Object is of the actual entity type (note that Hibernate Entity Manager
    relaxed this constraint and allows <code class="literal">Object</code> of
    <code class="literal">java.lang.Object</code> type (allowing sharing of listeners
    across several entities.)</p><p>A callback method can raise a
    <code class="classname">RuntimeException</code>. The current transaction, if any,
    must be rolled back. The following callbacks are defined:</p><div class="table"><a id="d0e3013"/><p class="title"><b>Table 6.1. Callbacks</b></p><div class="table-contents"><table summary="Callbacks" border="1"><colgroup><col/><col/></colgroup><thead><tr><th align="center">Type</th><th align="center">Description</th></tr></thead><tbody><tr><td>@PrePersist</td><td>Executed before the entity manager persist operation is
            actually executed or cascaded. This call is synchronous with the
            persist operation.</td></tr><tr><td>@PreRemove</td><td>Executed before the entity manager remove operation is
            actually executed or cascaded. This call is synchronous with the
            remove operation.</td></tr><tr><td>@PostPersist</td><td>Executed after the entity manager persist operation is
            actually executed or cascaded. This call is invoked after the
            database INSERT is executed.</td></tr><tr><td>@PostRemove</td><td>Executed after the entity manager remove operation is
            actually executed or cascaded. This call is synchronous with the
            remove operation.</td></tr><tr><td>@PreUpdate</td><td>Executed before the database UPDATE operation.</td></tr><tr><td>@PostUpdate</td><td>Executed after the database UPDATE operation.</td></tr><tr><td>@PostLoad</td><td>Executed after an entity has been loaded into the current
            persistence context or an entity has been refreshed.</td></tr></tbody></table></div></div><br class="table-break"/><p>A callback method must not invoke
    <code class="classname">EntityManager</code> or <code class="classname">Query</code>
    methods!</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3069"/>6.2. Callbacks and listeners inheritance</h2></div></div></div><p>You can define several entity listeners per entity at different
    level of the hierarchy. You can also define several callbacks at different
    level of the hierarchy. But you cannot define two listeners for the same
    event in the same entity or the same entity listener.</p><p>When an event is raised, the listeners are executed in this
    order:</p><div class="itemizedlist"><ul><li><p><code class="literal">@EntityListeners</code> for a given entity or
        superclass in the array order</p></li><li><p>Entity listeners for the superclasses (highest first)</p></li><li><p>Entity Listeners for the entity</p></li><li><p>Callbacks of the superclasses (highest first)</p></li><li><p>Callbacks of the entity</p></li></ul></div><p>You can stop the entity listeners inheritance by using the
    <code class="literal">@ExcludeSuperclassListeners</code>, all superclasses
    <code class="literal">@EntityListeners</code> will then be ignored.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e3102"/>6.3. XML definition</h2></div></div></div><p>The JPA specification allows annotation overriding through JPA
    deployment descriptors. There is also an additional feature that can be
    useful: default event listeners.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity-mappings</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence/orm&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xmlns:xsi</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">xsi:schemaLocation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;http://java.sun.com/xml/ns/persistence/orm&nbsp;orm_2_0.xsd&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">version</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;2.0&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit-metadata</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">persistence-unit-defaults</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity-listeners</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity-listener</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">class</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.ejb.test.pack.defaultpar.IncrementListener&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pre-persist</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">method-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;increment&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity-listener</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity-listeners</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit-defaults</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">persistence-unit-metadata</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">package</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.hibernate.ejb.test.pack.defaultpar</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">package</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">class</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;ApplicationServer&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity-listeners</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">entity-listener</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">class</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;OtherIncrementListener&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pre-persist</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">method-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;increment&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity-listener</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity-listeners</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">pre-persist</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">method-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;calculate&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">entity-mappings</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>You can override entity listeners on a given entity. An entity
    listener correspond to a given class and one or several event fire a given
    method call. You can also define event on the entity itself to describe
    the callbacks.</p><p>Last but not least, you can define some default entity listeners
    that will apply first on the entity listener stack of all the mapped
    entities of a given persistence unit. If you don't want an entity to
    inherit the default listeners, you can use
    <code class="classname">@ExcludeDefaultListeners</code> (or
    &lt;exclude-default-listeners/&gt;).</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="batch"/>Chapter 7. Batch processing</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#batch-direct">7.1. Bulk update/delete</a></span></dt></dl></div><p>Batch processing has traditionally been difficult in full
  object/relational mapping. ORM is all about object state management, which
  implies that object state is available in memory. However, Hibernate has
  some features to optimize batch processing which are discussed in the
  Hibernate reference guide, however, EJB3 persistence differs
  slightly.</p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="batch-direct"/>7.1. Bulk update/delete</h2></div></div></div><p>As already discussed, automatic and transparent object/relational
    mapping is concerned with the management of object state. This implies
    that the object state is available in memory, hence updating or deleting
    (using SQL <code class="literal">UPDATE</code> and <code class="literal">DELETE</code>) data
    directly in the database will not affect in-memory state. However,
    Hibernate provides methods for bulk SQL-style <code class="literal">UPDATE</code>
    and <code class="literal">DELETE</code> statement execution which are performed
    through JP-QL (<a href="#queryhql" title="Chapter 8. JP-QL: The Object Query Language">Chapter 8, <i xmlns:xlink="http://www.w3.org/1999/xlink">JP-QL: The Object Query Language</i></a>).</p><p>The pseudo-syntax for <code class="literal">UPDATE</code> and
    <code class="literal">DELETE</code> statements is: <code class="literal">( UPDATE | DELETE )
    FROM? ClassName (WHERE WHERE_CONDITIONS)?</code>. Note that:</p><div class="itemizedlist"><ul compact="compact"><li><p>In the from-clause, the FROM keyword is optional.</p></li><li><p>There can only be a single class named in the from-clause, and
        it <span class="emphasis"><em>cannot</em></span> have an alias (this is a current
        Hibernate limitation and will be removed soon).</p></li><li><p>No joins (either implicit or explicit) can be specified in a
        bulk JP-QL query. Sub-queries may be used in the where-clause.</p></li><li><p>The where-clause is also optional.</p></li></ul></div><p>As an example, to execute an JP-QL <code class="literal">UPDATE</code>, use
    the <code class="literal">Query.executeUpdate()</code> method:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">EntityManager</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManagerFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEntityManager</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">begin</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;jpqlUpdate&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;update&nbsp;Customer&nbsp;set&nbsp;name&nbsp;=&nbsp;:newName&nbsp;where&nbsp;name&nbsp;=&nbsp;:oldName&quot;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;updatedEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;jpqlUpdate&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;newName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;newName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;oldName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;oldName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre><p>To execute an JP-QL <code class="literal">DELETE</code>, use the same
    <code class="literal">Query.executeUpdate()</code> method (the method is named for
    those familiar with JDBC's
    <code class="literal">PreparedStatement.executeUpdate()</code>):</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">EntityManager</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManagerFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createEntityManager</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">begin</span><span class="java_separator">();</span>
</span>
<!--  --><br/><span class="java_type">String</span><span class="java_plain">&nbsp;hqlDelete&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;delete&nbsp;Customer&nbsp;where&nbsp;name&nbsp;=&nbsp;:oldName&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">int</span><span class="java_plain">&nbsp;deletedEntities&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">createQuery</span><span class="java_separator">(</span><span class="java_plain">&nbsp;hqlDelete&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;oldName&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;oldName&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">.</span><span class="java_plain">executeUpdate</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">getTransaction</span><span class="java_separator">().</span><span class="java_plain">commit</span><span class="java_separator">();</span>
<!--  --><br/><span class="java_plain">entityManager</span><span class="java_separator">.</span><span class="java_plain">close</span><span class="java_separator">();</span></pre><p>The <code class="literal">int</code> value returned by the
    <code class="literal">Query.executeUpdate()</code> method indicate the number of
    entities effected by the operation. This may or may not correlate with the
    number of rows effected in the database. A JP-QL bulk operation might
    result in multiple actual SQL statements being executed, for
    joined-subclass, for example. The returned number indicates the number of
    actual entities affected by the statement. Going back to the example of
    joined-subclass, a delete against one of the subclasses may actually
    result in deletes against not just the table to which that subclass is
    mapped, but also the "root" table and potentially joined-subclass tables
    further down the inheritance hierarchy.</p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql"/>Chapter 8. JP-QL: The Object Query Language</h2></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="#queryhql-casesensitivity">8.1. Case Sensitivity</a></span></dt><dt><span class="sect1"><a href="#queryhql-from">8.2. The from clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-joins">8.3. Associations and joins</a></span></dt><dt><span class="sect1"><a href="#queryhql-select">8.4. The select clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-aggregation">8.5. Aggregate functions</a></span></dt><dt><span class="sect1"><a href="#queryhql-polymorphism">8.6. Polymorphic queries</a></span></dt><dt><span class="sect1"><a href="#queryhql-where">8.7. The where clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-expressions">8.8. Expressions</a></span></dt><dt><span class="sect1"><a href="#queryhql-ordering">8.9. The order by clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-grouping">8.10. The group by clause</a></span></dt><dt><span class="sect1"><a href="#queryhql-subqueries">8.11. Subqueries</a></span></dt><dt><span class="sect1"><a href="#queryhql-examples">8.12. JP-QL examples</a></span></dt><dt><span class="sect1"><a href="#queryhql-bulk">8.13. Bulk UPDATE &amp; DELETE Statements</a></span></dt><dt><span class="sect1"><a href="#queryhql-tipstricks">8.14. Tips &amp; Tricks</a></span></dt></dl></div><p>The Java Persistence Query Language (JP-QL) has been heavily inspired
  by HQL, the native Hibernate Query Language. Both are therefore very close
  to SQL, but portable and independent of the database schema. People familiar
  with HQL shouldn't have any problem using JP-QL. In fact HQL is a strict
  superset of JP-QL and you use the same query API for both types of queries.
  Portable JPA applications however should stick to JP-QL.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>For a type-safe approach to query, we highly recommend you to use
    the Criteria query, see <a href="#querycriteria" title="Chapter 9. Criteria Queries">Chapter 9, <i xmlns:xlink="http://www.w3.org/1999/xlink">Criteria Queries</i></a>.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-casesensitivity"/>8.1. Case Sensitivity</h2></div></div></div><p>Queries are case-insensitive, except for names of Java classes and
    properties. So <code class="literal">SeLeCT</code> is the same as
    <code class="literal">sELEct</code> is the same as <code class="literal">SELECT</code> but
    <code class="literal">org.hibernate.eg.FOO</code> is not
    <code class="literal">org.hibernate.eg.Foo</code> and <code class="literal">foo.barSet</code>
    is not <code class="literal">foo.BARSET</code>.</p><p>This manual uses lowercase JP-QL keywords. Some users find queries
    with uppercase keywords more readable, but we find this convention ugly
    when embedded in Java code.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-from"/>8.2. The from clause</h2></div></div></div><p>The simplest possible JP-QL query is of the form:</p><pre class="programlisting">select c from eg.Cat c</pre><p>which simply returns all instances of the class
    <code class="literal">eg.Cat</code>. Unlike HQL, the select clause is not optional
    in JP-QL. We don't usually need to qualify the class name, since the
    entity name defaults to the unqualified class name
    (<code class="literal">@Entity</code>). So we almost always just write:</p><pre class="programlisting">select c from Cat c</pre><p>As you may have noticed you can assign aliases to classes, the
    <code class="literal">as</code> keywork is optional. An alias allows you to refer to
    <code class="literal">Cat</code> in other parts of the query.</p><pre class="programlisting">select cat from Cat as cat</pre><p>Multiple classes may appear, resulting in a cartesian product or
    "cross" join.</p><pre class="programlisting">select formula, parameter from Formula as formula, Parameter as parameter</pre><p>It is considered good practice to name query aliases using an
    initial lowercase, consistent with Java naming standards for local
    variables (eg. <code class="literal">domesticCat</code>).</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-joins"/>8.3. Associations and joins</h2></div></div></div><p>You may also assign aliases to associated entities, or even to
    elements of a collection of values, using a
    <code class="literal">join</code>.</p><pre class="programlisting">select cat, mate, kitten from Cat as cat
    inner join cat.mate as mate
    left outer join cat.kittens as kitten</pre><pre class="programlisting">select cat from Cat as cat left join cat.mate.kittens as kittens</pre><p>The supported join types are borrowed from ANSI SQL</p><div class="itemizedlist"><ul compact="compact"><li><p><code class="literal">inner join</code></p></li><li><p><code class="literal">left outer join</code></p></li></ul></div><p>The <code class="literal">inner join</code>, <code class="literal">left outer
    join</code> constructs may be abbreviated.</p><pre class="programlisting">select cat, mate, kitten from Cat as cat
    join cat.mate as mate
    left join cat.kittens as kitten</pre><p>In addition, a "fetch" join allows associations or collections of
    values to be initialized along with their parent objects, using a single
    select. This is particularly useful in the case of a collection. It
    effectively overrides the fetching options in the associations and
    collection mapping metadata. See the Performance chapter of the Hibernate
    reference guide for more information.</p><pre class="programlisting">select cat from Cat as cat
    inner join fetch cat.mate
    left join fetch cat.kittens</pre><p>A fetch join does not usually need to assign an alias, because the
    associated objects should not be used in the <code class="literal">where</code>
    clause (or any other clause). Also, the associated objects are not
    returned directly in the query results. Instead, they may be accessed via
    the parent object. The only reason we might need an alias is if we are
    recursively join fetching a further collection:</p><pre class="programlisting">select cat from Cat as cat 
    inner join fetch cat.mate
    left join fetch cat.kittens child
    left join fetch child.kittens</pre><p>Note that the <code class="literal">fetch</code> construct may not be used in
    queries called using <code class="literal">scroll()</code> or
    <code class="literal">iterate()</code>. Nor should <code class="literal">fetch</code> be used
    together with <code class="literal">setMaxResults()</code> or
    <code class="literal">setFirstResult()</code>. It is possible to create a cartesian
    product by join fetching more than one collection in a query (as in the
    example above), be careful the result of this product isn't bigger than
    you expect. Join fetching multiple collection roles gives unexpected
    results for bag mappings as it is impossible for Hibernate to
    differentiate legit duplicates of a given bag from artificial duplicates
    created by the multi-table cartesian product.</p><p>If you are using property-level lazy fetching (with bytecode
    instrumentation), it is possible to force Hibernate to fetch the lazy
    properties immediately (in the first query) using <code class="literal">fetch all
    properties</code>. This is Hibernate specific option:</p><pre class="programlisting">select doc from Document doc fetch all properties order by doc.name</pre><pre class="programlisting">select doc from Document doc fetch all properties where lower(doc.name) like '%cats%'</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-select"/>8.4. The select clause</h2></div></div></div><p>The <code class="literal">select</code> clause picks which objects and
    properties to return in the query result set. Consider:</p><pre class="programlisting">select mate 
from Cat as cat 
    inner join cat.mate as mate</pre><p>The query will select <code class="literal">mate</code>s of other
    <code class="literal">Cat</code>s. Actually, you may express this query more
    compactly as:</p><pre class="programlisting">select cat.mate from Cat cat</pre><p>Queries may return properties of any value type including properties
    of component type:</p><pre class="programlisting">select cat.name from DomesticCat cat
where cat.name like 'fri%'</pre><pre class="programlisting">select cust.name.firstName from Customer as cust</pre><p>Queries may return multiple objects and/or properties as an array of
    type <code class="literal">Object[]</code>,</p><pre class="programlisting">select mother, offspr, mate.name 
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr</pre><p>or as a <code class="literal">List</code> (HQL specific feature)</p><pre class="programlisting">select new list(mother, offspr, mate.name)
from DomesticCat as mother
    inner join mother.mate as mate
    left outer join mother.kittens as offspr</pre><p>or as an actual type-safe Java object (often called a view
    object),</p><pre class="programlisting">select new Family(mother, mate, offspr)
from DomesticCat as mother
    join mother.mate as mate
    left join mother.kittens as offspr</pre><p>assuming that the class <code class="literal">Family</code> has an appropriate
    constructor.</p><p>You may assign aliases to selected expressions using
    <code class="literal">as</code>:</p><pre class="programlisting">select max(bodyWeight) as max, min(bodyWeight) as min, count(*) as n
from Cat cat</pre><p>This is most useful when used together with <code class="literal">select new
    map</code> (HQL specific feature):</p><pre class="programlisting">select new map( max(bodyWeight) as max, min(bodyWeight) as min, count(*) as n )
from Cat cat</pre><p>This query returns a <code class="literal">Map</code> from aliases to selected
    values.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-aggregation"/>8.5. Aggregate functions</h2></div></div></div><p>HQL queries may even return the results of aggregate functions on
    properties:</p><pre class="programlisting">select avg(cat.weight), sum(cat.weight), max(cat.weight), count(cat)
from Cat cat</pre><p>The supported aggregate functions are</p><div class="itemizedlist"><ul compact="compact"><li><p><code class="literal">avg(...), avg(distinct ...), sum(...), sum(distinct
        ...), min(...), max(...)</code></p></li><li><p><code class="literal">count(*)</code></p></li><li><p><code class="literal">count(...), count(distinct ...),
        count(all...)</code></p></li></ul></div><p>You may use arithmetic operators, concatenation, and recognized SQL
    functions in the select clause (depending on configured dialect, HQL
    specific feature):</p><pre class="programlisting">select cat.weight + sum(kitten.weight) 
from Cat cat 
    join cat.kittens kitten
group by cat.id, cat.weight</pre><pre class="programlisting">select firstName||' '||initial||' '||upper(lastName) from Person</pre><p>The <code class="literal">distinct</code> and <code class="literal">all</code> keywords
    may be used and have the same semantics as in SQL.</p><pre class="programlisting">select distinct cat.name from Cat cat

select count(distinct cat.name), count(cat) from Cat cat</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-polymorphism"/>8.6. Polymorphic queries</h2></div></div></div><p>A query like:</p><pre class="programlisting">select cat from Cat as cat</pre><p>returns instances not only of <code class="literal">Cat</code>, but also of
    subclasses like <code class="literal">DomesticCat</code>. Hibernate queries may name
    <span class="emphasis"><em>any</em></span> Java class or interface in the
    <code class="literal">from</code> clause (portable JP-QL queries should only name
    mapped entities). The query will return instances of all persistent
    classes that extend that class or implement the interface. The following
    query would return all persistent objects:</p><pre class="programlisting">from java.lang.Object o // HQL only</pre><p>The interface <code class="literal">Named</code> might be implemented by
    various persistent classes:</p><pre class="programlisting">from Named n, Named m where n.name = m.name // HQL only</pre><p>Note that these last two queries will require more than one SQL
    <code class="literal">SELECT</code>. This means that the <code class="literal">order by</code>
    clause does not correctly order the whole result set. (It also means you
    can't call these queries using <code class="literal">Query.scroll()</code>.)</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-where"/>8.7. The where clause</h2></div></div></div><p>The <code class="literal">where</code> clause allows you to narrow the list of
    instances returned. If no alias exists, you may refer to properties by
    name:</p><pre class="programlisting">select cat from Cat cat where cat.name='Fritz'</pre><p>returns instances of <code class="literal">Cat</code> named 'Fritz'.</p><pre class="programlisting">select foo 
from Foo foo, Bar bar
where foo.startDate = bar.date</pre><p>will return all instances of <code class="literal">Foo</code> for which there
    exists an instance of <code class="literal">bar</code> with a
    <code class="literal">date</code> property equal to the <code class="literal">startDate</code>
    property of the <code class="literal">Foo</code>. Compound path expressions make the
    <code class="literal">where</code> clause extremely powerful. Consider:</p><pre class="programlisting">select cat from Cat cat where cat.mate.name is not null</pre><p>This query translates to an SQL query with a table (inner) join. If
    you were to write something like</p><pre class="programlisting">select foo from Foo foo  
where foo.bar.baz.customer.address.city is not null</pre><p>you would end up with a query that would require four table joins in
    SQL.</p><p>The <code class="literal">=</code> operator may be used to compare not only
    properties, but also instances:</p><pre class="programlisting">select cat, rival from Cat cat, Cat rival where cat.mate = rival.mate</pre><pre class="programlisting">select cat, mate 
from Cat cat, Cat mate
where cat.mate = mate</pre><p>The special property (lowercase) <code class="literal">id</code> may be used
    to reference the unique identifier of an object. (You may also use its
    mapped identifer property name.). Note that this keyword is specific to
    HQL.</p><pre class="programlisting">select cat from Cat as cat where cat.id = 123

select cat from Cat as cat where cat.mate.id = 69</pre><p>The second query is efficient. No table join is required!</p><p>Properties of composite identifiers may also be used. Suppose
    <code class="literal">Person</code> has a composite identifier consisting of
    <code class="literal">country</code> and <code class="literal">medicareNumber</code>.</p><pre class="programlisting">select person from bank.Person person
where person.id.country = 'AU' 
    and person.id.medicareNumber = 123456</pre><pre class="programlisting">select account from bank.Account account
where account.owner.id.country = 'AU' 
    and account.owner.id.medicareNumber = 123456</pre><p>Once again, the second query requires no table join.</p><p>Likewise, the special property <code class="literal">class</code> accesses the
    discriminator value of an instance in the case of polymorphic persistence.
    A Java class name embedded in the where clause will be translated to its
    discriminator value. Once again, this is specific to HQL.</p><pre class="programlisting">select cat from Cat cat where cat.class = DomesticCat</pre><p>You may also specify properties of components or composite user
    types (and of components of components, etc). Never try to use a
    path-expression that ends in a property of component type (as opposed to a
    property of a component). For example, if <code class="literal">store.owner</code>
    is an entity with a component <code class="literal">address</code></p><pre class="programlisting">store.owner.address.city    // okay
store.owner.address         // error!</pre><p>An "any" type has the special properties <code class="literal">id</code> and
    <code class="literal">class</code>, allowing us to express a join in the following
    way (where <code class="literal">AuditLog.item</code> is a property mapped with
    <code class="literal">&lt;any&gt;</code>). <code class="literal">Any</code> is specific to
    Hibernate</p><pre class="programlisting">from AuditLog log, Payment payment 
where log.item.class = 'Payment' and log.item.id = payment.id</pre><p>Notice that <code class="literal">log.item.class</code> and
    <code class="literal">payment.class</code> would refer to the values of completely
    different database columns in the above query.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-expressions"/>8.8. Expressions</h2></div></div></div><p>Expressions allowed in the <code class="literal">where</code> clause include
    most of the kind of things you could write in SQL:</p><div class="itemizedlist"><ul compact="compact"><li><p>mathematical operators <code class="literal">+, -, *, /</code></p></li><li><p>binary comparison operators <code class="literal">=, &gt;=, &lt;=, &lt;&gt;,
        !=, like</code></p></li><li><p>logical operations <code class="literal">and, or, not</code></p></li><li><p>Parentheses <code class="literal">( )</code>, indicating grouping</p></li><li><p><code class="literal">in</code>, <code class="literal">not in</code>,
        <code class="literal">between</code>, <code class="literal">is null</code>, <code class="literal">is
        not null</code>, <code class="literal">is empty</code>, <code class="literal">is not
        empty</code>, <code class="literal">member of</code> and <code class="literal">not member
        of</code></p></li><li><p><code class="literal">exists</code>, <code class="literal">all</code>,
        <code class="literal">any</code>, <code class="literal">some</code> (taking
        subqueries)</p></li><li><p>"Simple" case, <code class="literal">case ... when ... then ... else ...
        end</code>, and "searched" case, <code class="literal">case when ... then ...
        else ... end</code></p></li><li><p>string concatenation <code class="literal">...||...</code> or
        <code class="literal">concat(...,...) (use concat() for portable JP-QL
        queries)</code></p></li><li><p><code class="literal">current_date()</code>,
        <code class="literal">current_time()</code>,
        <code class="literal">current_timestamp()</code></p></li><li><p><code class="literal">second(...)</code>, <code class="literal">minute(...)</code>,
        <code class="literal">hour(...)</code>, <code class="literal">day(...)</code>,
        <code class="literal">month(...)</code>, <code class="literal">year(...)</code>, (specific
        to HQL)</p></li><li><p>Any function or operator: <code class="literal">substring(), trim(), lower(),
        upper(), length(), locate(), abs(), sqrt(),
        bit_length()</code></p></li><li><p><code class="literal">coalesce()</code> and
        <code class="literal">nullif()</code></p></li><li><p><code class="literal">TYPE ... in ...</code>, where the first argument is
        an identifier variable and the second argument is the subclass to
        restrict polymorphism to (or a list of subclasses surrounded by
        parenthesis)</p></li><li><p><code class="literal">cast(... as ...)</code>, where the second argument
        is the name of a Hibernate type, and <code class="literal">extract(... from
        ...)</code> if ANSI <code class="literal">cast()</code> and
        <code class="literal">extract()</code> is supported by the underlying
        database</p></li><li><p>Any database-supported SQL scalar function like
        <code class="literal">sign()</code>, <code class="literal">trunc()</code>,
        <code class="literal">rtrim()</code>, <code class="literal">sin()</code></p></li><li><p>JDBC IN parameters <code class="literal">?</code></p></li><li><p>named parameters <code class="literal">:name</code>,
        <code class="literal">:start_date</code>, <code class="literal">:x1</code></p></li><li><p>SQL literals <code class="literal">'foo'</code>, <code class="literal">69</code>,
        <code class="literal">'1970-01-01 10:00:01.0'</code></p></li><li><p>JDBC escape syntax for dates (dependent on your JDBC driver
        support) (eg. <code class="code">where date = {d '2008-12-31'}</code>)</p></li><li><p>Java <code class="literal">public static final</code> constants
        <code class="literal">eg.Color.TABBY</code></p></li></ul></div><p><code class="literal">in</code> and <code class="literal">between</code> may be used as
    follows:</p><pre class="programlisting">select cat from DomesticCat cat where cat.name between 'A' and 'B'</pre><pre class="programlisting">select cat from DomesticCat cat where cat.name in ( 'Foo', 'Bar', 'Baz' )</pre><p>and the negated forms may be written</p><pre class="programlisting">select cat from DomesticCat cat where cat.name not between 'A' and 'B'</pre><pre class="programlisting">select cat from DomesticCat cat where cat.name not in ( 'Foo', 'Bar', 'Baz' )</pre><p>Likewise, <code class="literal">is null</code> and <code class="literal">is not
    null</code> may be used to test for null values.</p><p>Booleans may be easily used in expressions by declaring HQL query
    substitutions in Hibernate configuration:</p><pre class="programlisting">hibernate.query.substitutions true 1, false 0</pre><p>This will replace the keywords <code class="literal">true</code> and
    <code class="literal">false</code> with the literals <code class="literal">1</code> and
    <code class="literal">0</code> in the translated SQL from this HQL:</p><pre class="programlisting">select cat from Cat cat where cat.alive = true</pre><p>You may test the size of a collection with the special property
    <code class="literal">size</code>, or the special <code class="literal">size()</code> function
    (HQL specific feature).</p><pre class="programlisting">select cat from Cat cat where cat.kittens.size &gt; 0</pre><pre class="programlisting">select cat from Cat cat where size(cat.kittens) &gt; 0</pre><p>For indexed collections, you may refer to the minimum and maximum
    indices using <code class="literal">minindex</code> and <code class="literal">maxindex</code>
    functions. Similarly, you may refer to the minimum and maximum elements of
    a collection of basic type using the <code class="literal">minelement</code> and
    <code class="literal">maxelement</code> functions. These are HQL specific
    features.</p><pre class="programlisting">select cal from Calendar cal where maxelement(cal.holidays) &gt; current date</pre><pre class="programlisting">select order from Order order where maxindex(order.items) &gt; 100</pre><pre class="programlisting">select order from Order order where minelement(order.items) &gt; 10000</pre><p>The SQL functions <code class="literal">any, some, all, exists, in</code> are
    supported when passed the element or index set of a collection
    (<code class="literal">elements</code> and <code class="literal">indices</code> functions) or
    the result of a subquery (see below). While subqueries are supported by
    JP-QL, <code class="literal">elements</code> and <code class="literal">indices</code> are
    specific HQL features.</p><pre class="programlisting">select mother from Cat as mother, Cat as kit
where kit in elements(foo.kittens)</pre><pre class="programlisting">select p from NameList list, Person p
where p.name = some elements(list.names)</pre><pre class="programlisting">select cat from Cat cat where exists elements(cat.kittens)</pre><pre class="programlisting">select cat from Player p where 3 &gt; all elements(p.scores)</pre><pre class="programlisting">select cat from Show show where 'fizard' in indices(show.acts)</pre><p>Note that these constructs - <code class="literal">size</code>,
    <code class="literal">elements</code>, <code class="literal">indices</code>,
    <code class="literal">minindex</code>, <code class="literal">maxindex</code>,
    <code class="literal">minelement</code>, <code class="literal">maxelement</code> - may only be
    used in the where clause in Hibernate.</p><p>JP-QL lets you access the key or the value of a map by using the
    <code class="literal">KEY()</code> and <code class="literal">VALUE()</code> operations (even
    access the Entry object using <code class="literal">ENTRY()</code>)</p><pre class="programlisting">SELECT i.name, VALUE(p) FROM Item i JOIN i.photos p WHERE KEY(p) LIKE ‘%egret’</pre><p>In HQL, elements of indexed collections (arrays, lists, maps) may be
    referred to by index (in a where clause only):</p><pre class="programlisting">select order from Order order where order.items[0].id = 1234</pre><pre class="programlisting">select person from Person person, Calendar calendar
where calendar.holidays['national day'] = person.birthDay
    and person.nationality.calendar = calendar</pre><pre class="programlisting">select item from Item item, Order order
where order.items[ order.deliveredItemIndices[0] ] = item and order.id = 11</pre><pre class="programlisting">select item from Item item, Order order
where order.items[ maxindex(order.items) ] = item and order.id = 11</pre><p>The expression inside <code class="literal">[]</code> may even be an
    arithmetic expression.</p><pre class="programlisting">select item from Item item, Order order
where order.items[ size(order.items) - 1 ] = item</pre><p>HQL also provides the built-in <code class="literal">index()</code> function,
    for elements of a one-to-many association or collection of values.</p><pre class="programlisting">select item, index(item) from Order order 
    join order.items item
where index(item) &lt; 5</pre><p>Scalar SQL functions supported by the underlying database may be
    used</p><pre class="programlisting">select cat from DomesticCat cat where upper(cat.name) like 'FRI%'</pre><p>If you are not yet convinced by all this, think how much longer and
    less readable the following query would be in SQL:</p><pre class="programlisting">select cust
from Product prod,
    Store store
    inner join store.customers cust
where prod.name = 'widget'
    and store.location.name in ( 'Melbourne', 'Sydney' )
    and prod = all elements(cust.currentOrder.lineItems)</pre><p><span class="emphasis"><em>Hint:</em></span> something like</p><pre class="programlisting">SELECT cust.name, cust.address, cust.phone, cust.id, cust.current_order
FROM customers cust,
    stores store,
    locations loc,
    store_customers sc,
    product prod
WHERE prod.name = 'widget'
    AND store.loc_id = loc.id
    AND loc.name IN ( 'Melbourne', 'Sydney' )
    AND sc.store_id = store.id
    AND sc.cust_id = cust.id
    AND prod.id = ALL(
        SELECT item.prod_id
        FROM line_items item, orders o
        WHERE item.order_id = o.id
            AND cust.current_order = o.id
    )</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-ordering"/>8.9. The order by clause</h2></div></div></div><p>The list returned by a query may be ordered by any property of a
    returned class or components:</p><pre class="programlisting">select cat from DomesticCat cat
order by cat.name asc, cat.weight desc, cat.birthdate</pre><p>The optional <code class="literal">asc</code> or <code class="literal">desc</code>
    indicate ascending or descending order respectively.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-grouping"/>8.10. The group by clause</h2></div></div></div><p>A query that returns aggregate values may be grouped by any property
    of a returned class or components:</p><pre class="programlisting">select cat.color, sum(cat.weight), count(cat) 
from Cat cat
group by cat.color</pre><pre class="programlisting">select foo.id, avg(name), max(name) 
from Foo foo join foo.names name
group by foo.id</pre><p>A <code class="literal">having</code> clause is also allowed.</p><pre class="programlisting">select cat.color, sum(cat.weight), count(cat) 
from Cat cat
group by cat.color 
having cat.color in (eg.Color.TABBY, eg.Color.BLACK)</pre><p>SQL functions and aggregate functions are allowed in the
    <code class="literal">having</code> and <code class="literal">order by</code> clauses, if
    supported by the underlying database (eg. not in MySQL).</p><pre class="programlisting">select cat
from Cat cat
    join cat.kittens kitten
group by cat
having avg(kitten.weight) &gt; 100
order by count(kitten) asc, sum(kitten.weight) desc</pre><p>Note that neither the <code class="literal">group by</code> clause nor the
    <code class="literal">order by</code> clause may contain arithmetic
    expressions.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-subqueries"/>8.11. Subqueries</h2></div></div></div><p>For databases that support subselects, JP-QL supports subqueries
    within queries. A subquery must be surrounded by parentheses (often by an
    SQL aggregate function call). Even correlated subqueries (subqueries that
    refer to an alias in the outer query) are allowed.</p><pre class="programlisting">select fatcat from Cat as fatcat 
where fatcat.weight &gt; ( 
    select avg(cat.weight) from DomesticCat cat 
)</pre><pre class="programlisting">select cat from DomesticCat as cat 
where cat.name = some ( 
    select name.nickName from Name as name 
)</pre><pre class="programlisting">select cat from Cat as cat 
where not exists ( 
    from Cat as mate where mate.mate = cat 
)</pre><pre class="programlisting">select cat from DomesticCat as cat 
where cat.name not in ( 
    select name.nickName from Name as name 
)</pre><p>For subqueries with more than one expression in the select list, you
    can use a tuple constructor:</p><pre class="programlisting">select cat from Cat as cat 
where not ( cat.name, cat.color ) in ( 
    select cat.name, cat.color from DomesticCat cat 
)</pre><p>Note that on some databases (but not Oracle or HSQLDB), you can use
    tuple constructors in other contexts, for example when querying components
    or composite user types:</p><pre class="programlisting">select cat from Person where name = ('Gavin', 'A', 'King')</pre><p>Which is equivalent to the more verbose:</p><pre class="programlisting">select cat from Person where name.first = 'Gavin' and name.initial = 'A' and name.last = 'King')</pre><p>There are two good reasons you might not want to do this kind of
    thing: first, it is not completely portable between database platforms;
    second, the query is now dependent upon the ordering of properties in the
    mapping document.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-examples"/>8.12. JP-QL examples</h2></div></div></div><p>Hibernate queries can be quite powerful and complex. In fact, the
    power of the query language is one of Hibernate's main selling points (and
    now JP-QL). Here are some example queries very similar to queries that I
    used on a recent project. Note that most queries you will write are much
    simpler than these!</p><p>The following query returns the order id, number of items and total
    value of the order for all unpaid orders for a particular customer and
    given minimum total value, ordering the results by total value. In
    determining the prices, it uses the current catalog. The resulting SQL
    query, against the <code class="literal">ORDER</code>,
    <code class="literal">ORDER_LINE</code>, <code class="literal">PRODUCT</code>,
    <code class="literal">CATALOG</code> and <code class="literal">PRICE</code> tables has four
    inner joins and an (uncorrelated) subselect.</p><pre class="programlisting">select order.id, sum(price.amount), count(item)
from Order as order
    join order.lineItems as item
    join item.product as product,
    Catalog as catalog
    join catalog.prices as price
where order.paid = false
    and order.customer = :customer
    and price.product = product
    and catalog.effectiveDate &lt; sysdate
    and catalog.effectiveDate &gt;= all (
        select cat.effectiveDate 
        from Catalog as cat
        where cat.effectiveDate &lt; sysdate
    )
group by order
having sum(price.amount) &gt; :minAmount
order by sum(price.amount) desc</pre><p>What a monster! Actually, in real life, I'm not very keen on
    subqueries, so my query was really more like this:</p><pre class="programlisting">select order.id, sum(price.amount), count(item)
from Order as order
    join order.lineItems as item
    join item.product as product,
    Catalog as catalog
    join catalog.prices as price
where order.paid = false
    and order.customer = :customer
    and price.product = product
    and catalog = :currentCatalog
group by order
having sum(price.amount) &gt; :minAmount
order by sum(price.amount) desc</pre><p>The next query counts the number of payments in each status,
    excluding all payments in the <code class="literal">AWAITING_APPROVAL</code> status
    where the most recent status change was made by the current user. It
    translates to an SQL query with two inner joins and a correlated subselect
    against the <code class="literal">PAYMENT</code>, <code class="literal">PAYMENT_STATUS</code>
    and <code class="literal">PAYMENT_STATUS_CHANGE</code> tables.</p><pre class="programlisting">select count(payment), status.name 
from Payment as payment 
    join payment.currentStatus as status
    join payment.statusChanges as statusChange
where payment.status.name &lt;&gt; PaymentStatus.AWAITING_APPROVAL
    or (
        statusChange.timeStamp = ( 
            select max(change.timeStamp) 
            from PaymentStatusChange change 
            where change.payment = payment
        )
        and statusChange.user &lt;&gt; :currentUser
    )
group by status.name, status.sortOrder
order by status.sortOrder</pre><p>If I would have mapped the <code class="literal">statusChanges</code>
    collection as a list, instead of a set, the query would have been much
    simpler to write.</p><pre class="programlisting">select count(payment), status.name 
from Payment as payment
    join payment.currentStatus as status
where payment.status.name &lt;&gt; PaymentStatus.AWAITING_APPROVAL
    or payment.statusChanges[ maxIndex(payment.statusChanges) ].user &lt;&gt; :currentUser
group by status.name, status.sortOrder
order by status.sortOrder</pre><p>However the query would have been HQL specific.</p><p>The next query uses the MS SQL Server <code class="literal">isNull()</code>
    function to return all the accounts and unpaid payments for the
    organization to which the current user belongs. It translates to an SQL
    query with three inner joins, an outer join and a subselect against the
    <code class="literal">ACCOUNT</code>, <code class="literal">PAYMENT</code>,
    <code class="literal">PAYMENT_STATUS</code>, <code class="literal">ACCOUNT_TYPE</code>,
    <code class="literal">ORGANIZATION</code> and <code class="literal">ORG_USER</code>
    tables.</p><pre class="programlisting">select account, payment
from Account as account
    join account.holder.users as user
    left outer join account.payments as payment
where :currentUser = user
    and PaymentStatus.UNPAID = isNull(payment.currentStatus.name, PaymentStatus.UNPAID)
order by account.type.sortOrder, account.accountNumber, payment.dueDate</pre></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-bulk"/>8.13. Bulk UPDATE &amp; DELETE Statements</h2></div></div></div><p>Hibernate now supports UPDATE and DELETE statements in HQL/JP-QL.
    See <a href="#batch-direct" title="7.1. Bulk update/delete">Section 7.1, “Bulk update/delete”</a> for details.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryhql-tipstricks"/>8.14. Tips &amp; Tricks</h2></div></div></div><p>To order a result by the size of a collection, use the following
    query:</p><pre class="programlisting">select usr.id, usr.name
from User as usr 
    left join usr.messages as msg
group by usr.id, usr.name
order by count(msg)</pre><p>If your database supports subselects, you can place a condition upon
    selection size in the where clause of your query:</p><pre class="programlisting">from User usr where size(usr.messages) &gt;= 1</pre><p>If your database doesn't support subselects, use the following
    query:</p><pre class="programlisting">select usr.id, usr.name
from User usr.name
    join usr.messages msg
group by usr.id, usr.name
having count(msg) &gt;= 1</pre><p>As this solution can't return a <code class="literal">User</code> with zero
    messages because of the inner join, the following form is also
    useful:</p><pre class="programlisting">select usr.id, usr.name
from User as usr
    left join usr.messages as msg
group by usr.id, usr.name
having count(msg) = 0</pre></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria"/>Chapter 9. Criteria Queries</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#querycriteria-typedquery">9.1. Typed criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-typedquery-entity">9.1.1. Selecting an entity</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-expression">9.1.2. Selecting a value</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-multiselect">9.1.3. Selecting multiple values</a></span></dt><dt><span class="section"><a href="#querycriteria-typedquery-construct">9.1.4. Selecting a wrapper</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-tuple">9.2. Tuple criteria queries</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-tuple-access">9.2.1. Accessing tuple elements</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-from">9.3. FROM clause</a></span></dt><dd><dl><dt><span class="section"><a href="#querycriteria-from-root">9.3.1. Roots</a></span></dt><dt><span class="section"><a href="#querycriteria-from-join">9.3.2. Joins</a></span></dt><dt><span class="section"><a href="#querycriteria-from-fetch">9.3.3. Fetches</a></span></dt></dl></dd><dt><span class="section"><a href="#querycriteria-path">9.4. Path expressions</a></span></dt><dt><span class="section"><a href="#querycriteria-param">9.5. Using parameters</a></span></dt></dl></div><p>Criteria queries are a programmatic, type-safe way to express a query.
  They are type-safe in terms of using interfaces and classes to represent
  various structural parts of a query such as the query itself, or the select
  clause, or an order-by, etc. They can also be type-safe in terms of
  referencing attributes as we will see in a bit. Users of the older Hibernate
  <code class="interfacename">org.hibernate.Criteria</code> query API will
  recognize the general approach, though we believe the JPA API to be superior
  as it represents a clean look at the lessons learned from that API.</p><p>Criteria queries are essentially an object graph, where each part of
  the graph represents an increasing (as we navigate down this graph) more
  atomic part of query. The first step in performing a criteria query is
  building this graph. The
  <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
  interface is the first thing with which you need to become acquainted to
  begin using criteria queries. Its role is that of a factory for all the
  individual pieces of the criteria. You obtain a
  <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
  instance by calling the <code class="methodname">getCriteriaBuilder</code> method
  of the
  <code class="interfacename">javax.persistence.EntityManagerFactory</code></p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaBuilder</span><!-- <br/> --><span class="java_plain">&nbsp;builder&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManagerFactory</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">getCriteriaBuilder</span><!-- <br/> --><span class="java_separator">();</span></pre><p>The next step is to obtain a
  <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>. You
  do this by one of the 3 methods on
  <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
  for this purpose.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">T</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Class</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">T</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">)</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Tuple</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;createTupleQuery</span><!-- <br/> --><span class="java_separator">()</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;createQuery</span><!-- <br/> --><span class="java_separator">()</span></pre><p>Each serves a different purpose depending on the expected type of the
  query results.</p><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p><em class="citetitle">Chapter 6 Criteria API</em> of
    the [<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a></span>] already contains a decent
    amount of reference material pertaining to the various parts of a criteria
    query. So rather than duplicate all that content here, lets instead look
    at some of the more widely anticipated usages of the API.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-typedquery"/>9.1. Typed criteria queries</h2></div></div></div><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">T</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Class</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">T</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">)</span></pre><p>The type of the criteria query (aka the &lt;T&gt;) indicates the
    expected types in the query result. This might be an entity, an Integer,
    or any other object.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-entity"/>9.1.1. Selecting an entity</h3></div></div></div><p>This the most used form of query in Hibernate Query Language (HQL)
      and Hibernate Criteria Queries. You have an entity and you want to
      select one or more of that entity based on some condition.</p><div class="example"><a id="ex-criteria-typedquery-entity"/><p class="title"><b>Example 9.1. Selecting the root entity</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>Person&gt; criteria = builder.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.selec<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>t( personRoot );
criteria.where<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;Person&gt; people = em.createQuery( criteria ).getResultList();
for ( Person p<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>erson : people ) { ... }</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>We use the form <span class="emphasis"><em>createQuery( Person.class
            )</em></span> here because the expected returns are in fact Person
            entities as we see when we begin processing the results.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p><span class="emphasis"><em>personCriteria.select( personRoot )</em></span>
            here is completely unneeded in this specific case because of the
            fact that <span class="emphasis"><em>personRoot</em></span> will be the implied
            selection since we have only a single root. It was done here only
            for completeness of an example</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/3.png" alt="3" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p><span class="emphasis"><em>Person_.eyeColor</em></span> is an example of the
            static form of metamodel reference. We will use that form
            exclusively in this chapter. See <a href="#metamodel-static" title="4.1. Static metamodel">Section 4.1, “Static metamodel”</a> for details.</p></td></tr></table></div></div></div><br class="example-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-expression"/>9.1.2. Selecting a value</h3></div></div></div><p>The simplest form of selecting a value is selecting a particular
      attribute from an entity. But this might also be an aggregation, a
      mathematical operation, etc.</p><div class="example"><a id="ex-criteria-typedquery-attribute"/><p class="title"><b>Example 9.2. Selecting an attribute</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>Integer&gt; criteria = builder.createQuery( Integer.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.selec<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>t( personRoot.get( Person_.age ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;Integer&gt; <span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>ages = em.createQuery( criteria ).getResultList();
for ( Integer age : ages ) { ... } </pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Notice again the typing of the query based on the
            anticipated result type(s). Here we are specifying
            <code class="classname">java.lang.Integer</code> as the type of the
            <span class="emphasis"><em>Person#age</em></span> attribute is
            <code class="classname">java.lang.Integer</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>We need to bind the fact that we are interested in the age
            associated with the <span class="emphasis"><em>personRoot</em></span>. We might have
            multiple references to the Person entity in the query so we need
            to identify (aka qualify) which <span class="emphasis"><em>Person#age</em></span> we
            mean.</p></td></tr></table></div></div></div><br class="example-break"/><div class="example"><a id="ex-criteria-typedquery-expression"/><p class="title"><b>Example 9.3. Selecting an expression</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;Integer&gt; criteria = builder.createQuery( Integer.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.selec<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>t( builder.max( personRoot.get( Person_.age ) ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
Integer maxAge = em.createQuery( criteria ).getSingleResult();</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Here we see
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
            used to obtain a <span class="emphasis"><em>MAX</em></span> expression. These
            expression building methods return
            <code class="interfacename">javax.persistence.criteria.Expression</code>
            instances typed according to various rules. The rule for a
            <span class="emphasis"><em>MAX</em></span> expression is that the expression type is
            the same as that of the underlying attribute.</p></td></tr></table></div></div></div><br class="example-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-multiselect"/>9.1.3. Selecting multiple values</h3></div></div></div><p>There are actually a few different ways to select multiple values
      using criteria queries. We will explore 2 options here, but an
      alternative recommended approach is to use tuples as described in <a href="#querycriteria-tuple" title="9.2. Tuple criteria queries">Section 9.2, “Tuple criteria queries”</a></p><div class="example"><a id="ex-criteria-typedquery-array"/><p class="title"><b>Example 9.4. Selecting an array</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.selec<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>t( builder.array( idPath, agePath ) );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;Object[]&gt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span> valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
    final Long id = (Long) values[0];
    final Integer age = (Integer) values[1];
    ...
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Technically this is classified as a typed query, but as you
            can see in handling the results that is sort of misleading.
            Anyway, the expected result type here is an array.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Here we see the use of the <code class="methodname">array</code>
            method of the
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
            which explicitly combines individual selections into a
            <code class="interfacename">javax.persistence.criteria.CompoundSelection</code>.</p></td></tr></table></div></div></div><br class="example-break"/><div class="example"><a id="ex-criteria-typedquery-array2"/><p class="title"><b>Example 9.5. Selecting an array (2)</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>Object[]&gt; criteria = builder.createQuery( Object[].class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multi<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>select( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;Object[]&gt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span> valueArray = em.createQuery( criteria ).getResultList();
for ( Object[] values : valueArray ) {
    final Long id = (Long) values[0];
    final Integer age = (Integer) values[1];
    ...
} </pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Just as we saw in <a href="#ex-criteria-typedquery-array" title="Example 9.4. Selecting an array">Example 9.4, “Selecting an array”</a> we have a "typed"
            criteria query returning an Object array.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>This actually functions exactly the same as what we saw in
            <a href="#ex-criteria-typedquery-array" title="Example 9.4. Selecting an array">Example 9.4, “Selecting an array”</a>. The
            <code class="methodname">multiselect</code> method behaves slightly
            differently based on the type given when the criteria query was
            first built, but in this case it says to select and return an
            <span class="emphasis"><em>Object[]</em></span>.</p></td></tr></table></div></div></div><br class="example-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-typedquery-construct"/>9.1.4. Selecting a wrapper</h3></div></div></div><p>Another alternative to <a href="#querycriteria-typedquery-multiselect" title="9.1.3. Selecting multiple values">Section 9.1.3, “Selecting multiple values”</a> is to instead select
      an object that will "wrap" the multiple values. Going back to the
      example query there, rather than returning an array of
      <span class="emphasis"><em>[Person#id, Person#age]</em></span> instead declare a class
      that holds these values and instead return that.</p><div class="example"><a id="ex-criteria-typedquery-construct"/><p class="title"><b>Example 9.6. Selecting an wrapper</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">public class P<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>ersonWrapper {
    private final Long id;
    private final Integer age;
    public Per<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>sonWrapper(Long id, Integer age) {
        this.id = id;
        this.age = age;
    }
    ...
}
...
CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>PersonWrapper&gt; criteria = builder.createQuery( PersonWrapper.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.selec<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>t(
    builder.co<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>nstruct(
        PersonWrapper.class,
        personRoot.get( Person_.id ),
        personRoot.get( Person_.age )
    )
);
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;PersonWra<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>pper&gt; people = em.createQuery( criteria ).getResultList();
for ( PersonWrapper person : people ) { ... }</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>First we see the simple definition of the wrapper object we
            will be using to wrap our result values. Specifically notice the
            constructor and its argument types.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Since we will be returning
            <span class="emphasis"><em>PersonWrapper</em></span> objects, we use
            <span class="emphasis"><em>PersonWrapper</em></span> as the type of our criteria
            query.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/3.png" alt="3" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Here we see another new
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
            method, <code class="methodname">construct</code>, which is used to
            builder a wrapper expression. Basically for every row in the
            result we are saying we would like a
            <span class="emphasis"><em>PersonWrapper</em></span> instantiated by the matching
            constructor. This wrapper expression is then passed as the
            select.</p></td></tr></table></div></div></div><br class="example-break"/></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-tuple"/>9.2. Tuple criteria queries</h2></div></div></div><p>A better approach to <a href="#querycriteria-typedquery-multiselect" title="9.1.3. Selecting multiple values">Section 9.1.3, “Selecting multiple values”</a> is to either use a
    wrapper (which we just saw in <a href="#querycriteria-typedquery-construct" title="9.1.4. Selecting a wrapper">Section 9.1.4, “Selecting a wrapper”</a>) or using the
    <code class="interfacename">javax.persistence.Tuple</code> contract.</p><div class="example"><a id="ex-criteria-typedquery-tuple"/><p class="title"><b>Example 9.7. Selecting a tuple</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>Tuple&gt; criteria = builder.createTupleQuery();
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
Path&lt;Long&gt; idPath = personRoot.get( Person_.id );
Path&lt;Integer&gt; agePath = personRoot.get( Person_.age );
criteria.multi<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>select( idPath, agePath );
criteria.where( builder.equal( personRoot.get( Person_.eyeColor ), "brown" ) );
List&lt;Tuple&gt; tu<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>ples = em.createQuery( criteria ).getResultList();
for ( Tuple tuple : valueArray ) {
    assert tup<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>le.get( 0 ) == tuple.get( idPath );
    assert tup<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>le.get( 1 ) == tuple.get( agePath );
    ...
} </pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Here we see the use of a new
          <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
          <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>
          building method, <code class="methodname">createTupleQuery</code>. This is
          exactly equivalent to calling <span class="emphasis"><em>builder.createQuery(
          Tuple.class )</em></span>. It signifies that we want to access the
          results through the
          <code class="interfacename">javax.persistence.Tuple</code>
          contract.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Again we see the use of the
          <code class="methodname">multiselect</code> method, just like in <a href="#ex-criteria-typedquery-array2" title="Example 9.5. Selecting an array (2)">Example 9.5, “Selecting an array (2)”</a>. The difference here is
          that the type of the
          <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>
          was defined as
          <code class="interfacename">javax.persistence.Tuple</code> so the
          compound selections in this case are interpreted to be the tuple
          elements.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/3.png" alt="3" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Here we see
          <code class="interfacename">javax.persistence.Tuple</code> allowing
          different types of access to the results, which we will expand on
          next.</p></td></tr></table></div></div></div><br class="example-break"/><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-tuple-access"/>9.2.1. Accessing tuple elements</h3></div></div></div><p>The <code class="interfacename">javax.persistence.Tuple</code>
      contract provides 3 basic forms of access to the underlying
      elements:</p><div class="variablelist"><dl><dt><span class="term">typed</span></dt><dd><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;X&nbsp;get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">TupleElement</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;tupleElement</span><!-- <br/> --><span class="java_separator">)</span></pre><p>This allows typed access to the underlying tuple elements.
            We see this in <a href="#ex-criteria-typedquery-tuple" title="Example 9.7. Selecting a tuple">Example 9.7, “Selecting a tuple”</a> in
            the <span class="emphasis"><em>tuple.get( idPath )</em></span> and
            <span class="emphasis"><em>tuple.get( agePath )</em></span> calls. Just about
            everything is a
            <code class="interfacename">javax.persistence.TupleElement</code>.</p></dd><dt><span class="term">positional</span></dt><dd><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">int</span><!-- <br/> --><span class="java_plain">&nbsp;i</span><!-- <br/> --><span class="java_separator">)</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;X&nbsp;get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">int</span><!-- <br/> --><span class="java_plain">&nbsp;i</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Class</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;type</span><!-- <br/> --><span class="java_separator">)</span></pre><p>Very similar to what we saw in <a href="#ex-criteria-typedquery-array" title="Example 9.4. Selecting an array">Example 9.4, “Selecting an array”</a> and <a href="#ex-criteria-typedquery-array2" title="Example 9.5. Selecting an array (2)">Example 9.5, “Selecting an array (2)”</a> in terms of positional
            access. Only the second form here provides typing, because the
            user explicitly provides the typing on access. We see this in
            <a href="#ex-criteria-typedquery-tuple" title="Example 9.7. Selecting a tuple">Example 9.7, “Selecting a tuple”</a> in the
            <span class="emphasis"><em>tuple.get( 0 )</em></span> and <span class="emphasis"><em>tuple.get( 1
            )</em></span> calls.</p></dd><dt><span class="term">aliased</span></dt><dd><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Object</span><!-- <br/> --><span class="java_plain">&nbsp;get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;alias</span><!-- <br/> --><span class="java_separator">)</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;X&nbsp;get</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;alias</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Class</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;type</span><!-- <br/> --><span class="java_separator">)</span></pre><p>Again, only the second form here provides typing, because
            the user explicitly provides the typing on access. We have not
            seen an example of using this, but its trivial. We would simply,
            for example, have applies an alias to either of the paths like
            <span class="emphasis"><em>idPath.alias( "id" )</em></span> and/or
            <span class="emphasis"><em>agePath.alias( "age" )</em></span> and we could have
            accessed the individual tuple elements by those specified
            aliases.</p></dd></dl></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-from"/>9.3. FROM clause</h2></div></div></div><div class="blockquote"><table border="0" width="100%" cellspacing="0" cellpadding="0" class="blockquote" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>A CriteriaQuery object defines a query over one or more entity,
      embeddable, or basic abstract schema types. The root objects of the
      query are entities, from which the other types are reached by
      navigation.</p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">[<span class="citation"><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev"/></a><a id="JPA2_ABBREV"/><a href="#JPA2" title="JSR 317: Java™ Persistence API, Version 2.0"><abbr class="abbrev">JPA 2 Specification</abbr></a>, section 6.5.2 Query
      Roots, pg 262</span>]</span></td></tr></table></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>All the individual parts of the FROM clause (roots, joins, paths)
      implement the
      <code class="interfacename">javax.persistence.criteria.From</code>
      interface.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-root"/>9.3.1. Roots</h3></div></div></div><p>Roots define the basis from which all joins, paths and attributes
      are available in the query. In a criteria query, a root is always an
      entity. Roots are defined and added to the criteria by the overloaded
      <code class="methodname">from</code> methods on
      <code class="interfacename">javax.persistence.criteria.CriteriaQuery</code>:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Root</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;from</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">Class</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">)</span></pre><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Root</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;from</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_type">EntityType</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_plain">X</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_separator">)</span></pre><div class="example"><a id="d0e4612"/><p class="title"><b>Example 9.8. Adding a root</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;personCriteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;create&nbsp;and&nbsp;add&nbsp;the&nbsp;root</span>
<!--  --><br/><span class="java_plain">person</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/><p>Criteria queries may define multiple roots, the effect of which is
      to create a <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://en.wikipedia.org/wiki/Cartesian_product">cartesian
      product</a> between the newly added root and the others. Here is an
      example matching all single men and all single women:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_plain">&nbsp;query&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">();</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;men&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;women&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;query</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Predicate</span><span class="java_plain">&nbsp;menRestriction&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">and</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">equal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;men</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">gender&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">Gender</span><span class="java_separator">.</span><span class="java_plain">MALE&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">equal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;men</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">relationshipStatus&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">RelationshipStatus</span><span class="java_separator">.</span><span class="java_plain">SINGLE&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Predicate</span><span class="java_plain">&nbsp;womenRestriction&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">and</span><span class="java_separator">(</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">equal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;women</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">gender&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">Gender</span><span class="java_separator">.</span><span class="java_plain">FEMALE&nbsp;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">equal</span><span class="java_separator">(</span><span class="java_plain">&nbsp;women</span><span class="java_separator">.</span><span class="java_plain">get</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">relationshipStatus&nbsp;</span><span class="java_separator">),</span><span class="java_plain">&nbsp;</span><span class="java_type">RelationshipStatus</span><span class="java_separator">.</span><span class="java_plain">SINGLE&nbsp;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">query</span><span class="java_separator">.</span><span class="java_plain">where</span><span class="java_separator">(</span><span class="java_plain">&nbsp;builder</span><span class="java_separator">.</span><span class="java_plain">and</span><span class="java_separator">(</span><span class="java_plain">&nbsp;menRestriction</span><span class="java_separator">,</span><span class="java_plain">&nbsp;womenRestriction&nbsp;</span><span class="java_separator">)</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span></pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-join"/>9.3.2. Joins</h3></div></div></div><p>Joins allow navigation from other
      <code class="interfacename">javax.persistence.criteria.From</code> to either
      association or embedded attributes. Joins are created by the numerous
      overloaded <code class="methodname">join</code> methods of the
      <code class="interfacename">javax.persistence.criteria.From</code>
      interface:</p><div class="example"><a id="criteria-join-singular"/><p class="title"><b>Example 9.9. Example with Embedded and ManyToOne</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;personCriteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personRoot&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_plain">address&nbsp;is&nbsp;an&nbsp;embedded&nbsp;attribute</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_separator">,</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personAddress&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personRoot</span><span class="java_separator">.</span><span class="java_plain">join</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">address&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_separator">.</span><span class="java_plain">country&nbsp;is&nbsp;a&nbsp;</span><span class="java_type">ManyToOne</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_separator">,</span><span class="java_type">Country</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;addressCountry&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personAddress</span><span class="java_separator">.</span><span class="java_plain">join</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Address_</span><span class="java_separator">.</span><span class="java_plain">country&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/><div class="example"><a id="criteria-join-plural"/><p class="title"><b>Example 9.10. Example with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;personCriteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personRoot&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_separator">,</span><span class="java_type">Order</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;orders&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personRoot</span><span class="java_separator">.</span><span class="java_plain">join</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">orders&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Order</span><span class="java_separator">,</span><span class="java_type">LineItem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;orderLines&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;orders</span><span class="java_separator">.</span><span class="java_plain">join</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Order_</span><span class="java_separator">.</span><span class="java_plain">lineItems&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="querycriteria-from-fetch"/>9.3.3. Fetches</h3></div></div></div><p>Just like in HQL and EJB-QL, we can specify that associated data
      be fetched along with the owner. Fetches are created by the numerous
      overloaded <code class="methodname">fetch</code> methods of the
      <code class="interfacename">javax.persistence.criteria.From</code>
      interface:</p><div class="example"><a id="criteria-fetch-singular"/><p class="title"><b>Example 9.11. Example with Embedded and ManyToOne</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;personCriteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personRoot&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_plain">address&nbsp;is&nbsp;an&nbsp;embedded&nbsp;attribute</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_separator">,</span><span class="java_type">Address</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personAddress&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personRoot</span><span class="java_separator">.</span><span class="java_plain">fetch</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">address&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">&nbsp;</span><span class="java_type">Address</span><span class="java_separator">.</span><span class="java_plain">country&nbsp;is&nbsp;a&nbsp;</span><span class="java_type">ManyToOne</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Address</span><span class="java_separator">,</span><span class="java_type">Country</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;addressCountry&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personAddress</span><span class="java_separator">.</span><span class="java_plain">fetch</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Address_</span><span class="java_separator">.</span><span class="java_plain">country&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Technically speaking, embedded attributes are always fetched
        with their owner. However in order to define the fetching of
        <span class="emphasis"><em>Address#country</em></span> we needed a
        <code class="interfacename">javax.persistence.criteria.Fetch</code> for
        its parent path.</p></div><div class="example"><a id="criteria-fetch-plural"/><p class="title"><b>Example 9.12. Example with Collections</b></p><div class="example-contents"><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">CriteriaQuery</span><!-- <br/> --><span class="java_operator">&lt;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_operator">&gt;</span><!-- <br/> --><span class="java_plain">&nbsp;personCriteria&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;builder</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_type">Person</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_keyword">class</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Root</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;personRoot&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;person</span><span class="java_separator">.</span><span class="java_plain">from</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Person</span><span class="java_separator">,</span><span class="java_type">Order</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;orders&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;personRoot</span><span class="java_separator">.</span><span class="java_plain">fetch</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Person_</span><span class="java_separator">.</span><span class="java_plain">orders&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Join</span><span class="java_operator">&lt;</span><span class="java_type">Order</span><span class="java_separator">,</span><span class="java_type">LineItem</span><span class="java_operator">&gt;</span><span class="java_plain">&nbsp;orderLines&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;orders</span><span class="java_separator">.</span><span class="java_plain">fetch</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_type">Order_</span><span class="java_separator">.</span><span class="java_plain">lineItems&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_separator">...</span></pre></div></div><br class="example-break"/></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-path"/>9.4. Path expressions</h2></div></div></div><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>Roots, joins and fetches are themselves paths as well.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="querycriteria-param"/>9.5. Using parameters</h2></div></div></div><div class="example"><a id="ex-querycriteria-param"/><p class="title"><b>Example 9.13. Using parameters</b></p><div class="example-contents"><div class="programlistingco"><pre class="programlisting">CriteriaQuery&lt;Person&gt; criteria = build.createQuery( Person.class );
Root&lt;Person&gt; personRoot = criteria.from( Person.class );
criteria.select( personRoot );
ParameterExpre<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/1.png" alt="(1)"/></span>ssion&lt;String&gt; eyeColorParam = builder.parameter( String.class );
criteria.where<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/2.png" alt="(2)"/></span>( builder.equal( personRoot.get( Person_.eyeColor ), eyeColorParam ) );
TypedQuery&lt;Person&gt; query = em.createQuery( criteria );
query.setParam<span xmlns="" class="co"><img src="images/org/hibernate/docbook/callouts/3.png" alt="(3)"/></span>eter( eyeColorParam, "brown" );
List&lt;Person&gt; people = query.getResultList();</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/1.png" alt="1" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Use the <code class="methodname">parameter</code> method of
            <code class="interfacename">javax.persistence.criteria.CriteriaBuilder</code>
            to obtain a parameter reference.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/2.png" alt="2" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Use the parameter reference in the criteria query.</p></td></tr><tr><td width="5%" valign="top" align="left"><img xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" src="images/org/hibernate/docbook/callouts/3.png" alt="3" border="0" height="17px" width="17px"/></td><td valign="top" align="left"><p>Use the parameter reference to bind the parameter value to
            the
            <code class="interfacename">javax.persistence.TypedQuery</code></p></td></tr></table></div></div></div></div><br class="example-break"/></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="query_native"/>Chapter 10. Native query</h2></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="#d0e4721">10.1. Expressing the resultset</a></span></dt><dt><span class="sect1"><a href="#d0e4753">10.2. Using native SQL Queries</a></span></dt><dt><span class="sect1"><a href="#d0e4774">10.3. Named queries</a></span></dt></dl></div><p>You may also express queries in the native SQL dialect of your
  database. This is useful if you want to utilize database specific features
  such as query hints or the CONNECT BY option in Oracle. It also provides a
  clean migration path from a direct SQL/JDBC based application to Hibernate.
  Note that Hibernate allows you to specify handwritten SQL (including stored
  procedures) for all create, update, delete, and load operations (please
  refer to the reference guide for more information.)</p><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e4721"/>10.1. Expressing the resultset</h2></div></div></div><p>To use a SQL query, you need to describe the SQL resultset, this
    description will help the <code class="literal">EntityManager</code> to map your
    columns onto entity properties. This is done using the
    <code class="literal">@SqlResultSetMapping</code> annotation. Each
    <code class="literal">@SqlResultSetMapping </code>has a name which is used when
    creating a SQL query on <code class="literal">EntityManager</code>.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">SqlResultSetMapping</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;GetNightAndArea&quot;</span><!-- <br/> --><span class="java_separator">,</span><!-- <br/> --><span class="java_plain">&nbsp;entities</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;org.hibernate.test.annotations.query.Night&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;nid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;duration&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_duration&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;date&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_date&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;area&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;area_id&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;org.hibernate.test.annotations.query.Area&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;aid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">)</span>
</span>
<!--  --><br/><span class="java_operator">//</span><span class="java_plain">or</span>
<!--  --><br/><span class="java_plain">@</span><span class="java_type">SqlResultSetMapping</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;defaultSpaceShip&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;entities</span><span class="java_operator">=</span><span class="java_plain">@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;org.hibernate.test.annotations.query.SpaceShip&quot;</span><span class="java_separator">))</span></pre><p>You can also define scalar results and even mix entity results and
    scalar results</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_plain">@</span><!-- <br/> --><span class="java_type">SqlResultSetMapping</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_plain">name</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_literal">&quot;ScalarAndEntities&quot;</span><!-- <br/> --><span class="java_separator">,</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;entities</span><span class="java_operator">=</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;org.hibernate.test.annotations.query.Night&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;nid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;duration&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_duration&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;date&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;night_date&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;area&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;area_id&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">EntityResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;org.hibernate.test.annotations.query.Area&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;fields&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;id&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;aid&quot;</span><span class="java_separator">),</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">FieldResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">,</span><span class="java_plain">&nbsp;column</span><span class="java_operator">=</span><span class="java_literal">&quot;name&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">})</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">},</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;columns</span><span class="java_operator">=</span><span class="java_separator">{</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span class="java_type">ColumnResult</span><span class="java_separator">(</span><span class="java_plain">name</span><span class="java_operator">=</span><span class="java_literal">&quot;durationInSec&quot;</span><span class="java_separator">)</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_separator">}</span>
<!--  --><br/><span class="java_separator">)</span></pre><p>The SQL query will then have to return a column alias
    <code class="literal">durationInSec</code>.</p><p>Please refer to the Hibernate Annotations reference guide for more
    information about <code class="literal">@SqlResultSetMapping.</code></p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e4753"/>10.2. Using native SQL Queries</h2></div></div></div><p>TODO: This sounds like a dupe...</p><p>Now that the result set is described, we are capable of executing
    the native SQL query. <code class="literal">EntityManager</code> provides all the
    needed APIs. The first method is to use a SQL resultset name to do the
    binding, the second one uses the entity default mapping (the column
    returned has to have the same names as the one used in the mapping). A
    third one (not yet supported by Hibernate entity manager), returns pure
    scalar results.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;sqlQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;select&nbsp;night.id&nbsp;nid,&nbsp;night.night_duration,&nbsp;night.night_date,&nbsp;area.id&nbsp;aid,&nbsp;&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;night.area_id,&nbsp;area.name&nbsp;from&nbsp;Night&nbsp;night,&nbsp;Area&nbsp;area&nbsp;where&nbsp;night.area_id&nbsp;=&nbsp;area.id&nbsp;&quot;</span>
<!--  --><br/><span class="java_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="java_operator">+</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;and&nbsp;night.night_duration&nbsp;&gt;=&nbsp;?&quot;</span><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">sqlQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;GetNightAndArea&quot;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;expectedDuration&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><p>This native query returns nights and area based on the
    <code class="literal">GetNightAndArea</code> result set.</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">String</span><!-- <br/> --><span class="java_plain">&nbsp;sqlQuery&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;</span><!-- <br/> --><span class="java_literal">&quot;select&nbsp;*&nbsp;from&nbsp;tbl_spaceship&nbsp;where&nbsp;owner&nbsp;=&nbsp;?&quot;</span><!-- <br/> --><span class="java_separator">;</span>
<!--  --><br/><span class="java_type">Query</span><span class="java_plain">&nbsp;q&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;entityManager</span><span class="java_separator">.</span><span class="java_plain">createNativeQuery</span><span class="java_separator">(</span><span class="java_plain">sqlQuery</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_type">SpaceShip</span><span class="java_separator">.</span><span class="java_keyword">class</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;</span><span class="java_literal">&quot;Han&quot;</span><span class="java_plain">&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">getResultList</span><span class="java_separator">();</span></pre><p>The second version is useful when your SQL query returns one entity
    reusing the same columns as the ones mapped in metadata.</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e4774"/>10.3. Named queries</h2></div></div></div><p>Native named queries share the same calling API than JP-QL named
    queries. Your code doesn't need to know the difference between the two.
    This is very useful for migration from SQL to JP-QL:</p><pre xmlns="" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="JAVA"><!-- <br/> --><span class="java_type">Query</span><!-- <br/> --><span class="java_plain">&nbsp;q&nbsp;</span><!-- <br/> --><span class="java_operator">=</span><!-- <br/> --><span class="java_plain">&nbsp;entityManager</span><!-- <br/> --><span class="java_separator">.</span><!-- <br/> --><span class="java_plain">createNamedQuery</span><!-- <br/> --><span class="java_separator">(</span><!-- <br/> --><span class="java_literal">&quot;getSeasonByNativeQuery&quot;</span><!-- <br/> --><span class="java_separator">);</span>
<!--  --><br/><span class="java_plain">q</span><span class="java_separator">.</span><span class="java_plain">setParameter</span><span class="java_separator">(</span><span class="java_plain">&nbsp;</span><span class="java_literal">1</span><span class="java_separator">,</span><span class="java_plain">&nbsp;name&nbsp;</span><span class="java_separator">);</span>
<!--  --><br/><span class="java_type">Season</span><span class="java_plain">&nbsp;season&nbsp;</span><span class="java_operator">=</span><span class="java_plain">&nbsp;</span><span class="java_separator">(</span><span class="java_type">Season</span><span class="java_separator">)</span><span class="java_plain">&nbsp;q</span><span class="java_separator">.</span><span class="java_plain">getSingleResult</span><span class="java_separator">();</span></pre></div></div><div class="bibliography"><div class="titlepage"><div><div><h2 class="title"><a id="d0e4781"/>References</h2></div></div></div><div class="biblioentry"><a id="JPA2"/><p>[<abbr class="abbrev"><a id="JPA2_ABBREV"/>JPA 2 Specification</abbr>] <span class="title"><i>JSR 317: <span class="trademark">Java</span>™ Persistence API, Version
      2.0</i>. </span><span class="collab"><span class="collabname">Java Persistence 2.0 Expert Group. </span>. </span><span class="copyright">Copyright © 2009 SUN MICROSYSTEMS, INC.. </span><span class="bibliomisc"><code class="email">&lt;<a href="mailto:jsr-317-feedback@sun.com">jsr-317-feedback@sun.com</a>&gt;</code> <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://jcp.org/en/jsr/detail?id=317">JSR 317 JCP
      Page</a>. </span></p></div></div></div><HR xmlns=""/><a xmlns="" href=""><p xmlns="http://www.w3.org/1999/xhtml" class="copyright">Copyright © 2005 Red Hat Inc. and the various authors</p></a></body></html>